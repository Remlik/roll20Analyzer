function Mash(){var t=4022871197,e=function(e){e=e.toString();for(var r=0;r<e.length;r++){t+=e.charCodeAt(r);var n=.02519603282416938*t;t=n>>>0,n-=t,n*=t,t=n>>>0,n-=t,t+=4294967296*n}return 2.3283064365386963e-10*(t>>>0)};return e.version="Mash 0.9",e}function Alea(){var t=Math.pow(2,32)-1;return this.next=function(t){var e=0,r=0,n=0,i=1;0==t.length&&(t=[+new Date]);var o=Mash();e=o(" "),r=o(" "),n=o(" ");for(var s=0;s<t.length;s++)e-=o(t[s]),0>e&&(e+=1),r-=o(t[s]),0>r&&(r+=1),n-=o(t[s]),0>n&&(n+=1);o=null;var a=function(){var t=2091639*e+2.3283064365386963e-10*i;return e=r,r=n,n=t-(i=0|t)};return a.uint32=function(){return 4294967296*a()},a.fract53=function(){return a()+1.1102230246251565e-16*(2097152*a()|0)},a.version="Alea 0.9",a.args=t,a}(Array.prototype.slice.call(arguments)),this.nextInt=function(e){return void 0==e&&(e=t),Math.floor(this.next()*e)},this}function BigInteger(t,e,r){null!=t&&("number"==typeof t?this.fromNumber(t,e,r):null==e&&"string"!=typeof t?this.fromString(t,256):this.fromString(t,e))}function nbi(){return new BigInteger(null)}function am1(t,e,r,n,i,o){for(;--o>=0;){var s=e*this[t++]+r[n]+i;i=Math.floor(s/67108864),r[n++]=67108863&s}return i}function am2(t,e,r,n,i,o){for(var s=32767&e,a=e>>15;--o>=0;){var l=32767&this[t],u=this[t++]>>15,c=a*l+u*s;l=s*l+((32767&c)<<15)+r[n]+(1073741823&i),i=(l>>>30)+(c>>>15)+a*u+(i>>>30),r[n++]=1073741823&l}return i}function am3(t,e,r,n,i,o){for(var s=16383&e,a=e>>14;--o>=0;){var l=16383&this[t],u=this[t++]>>14,c=a*l+u*s;l=s*l+((16383&c)<<14)+r[n]+i,i=(l>>28)+(c>>14)+a*u,r[n++]=268435455&l}return i}function int2char(t){return BI_RM.charAt(t)}function intAt(t,e){var r=BI_RC[t.charCodeAt(e)];return null==r?-1:r}function bnpCopyTo(t){for(var e=this.t-1;e>=0;--e)t[e]=this[e];t.t=this.t,t.s=this.s}function bnpFromInt(t){this.t=1,this.s=0>t?-1:0,t>0?this[0]=t:-1>t?this[0]=t+this.DV:this.t=0}function nbv(t){var e=nbi();return e.fromInt(t),e}function bnpFromString(t,e){var r;if(16==e)r=4;else if(8==e)r=3;else if(256==e)r=8;else if(2==e)r=1;else if(32==e)r=5;else{if(4!=e)return void this.fromRadix(t,e);r=2}this.t=0,this.s=0;for(var n=t.length,i=!1,o=0;--n>=0;){var s=8==r?255&t[n]:intAt(t,n);0>s?"-"==t.charAt(n)&&(i=!0):(i=!1,0==o?this[this.t++]=s:o+r>this.DB?(this[this.t-1]|=(s&(1<<this.DB-o)-1)<<o,this[this.t++]=s>>this.DB-o):this[this.t-1]|=s<<o,o+=r,o>=this.DB&&(o-=this.DB))}8==r&&0!=(128&t[0])&&(this.s=-1,o>0&&(this[this.t-1]|=(1<<this.DB-o)-1<<o)),this.clamp(),i&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var t=this.s&this.DM;this.t>0&&this[this.t-1]==t;)--this.t}function bnToString(t){if(this.s<0)return"-"+this.negate().toString(t);var e;if(16==t)e=4;else if(8==t)e=3;else if(2==t)e=1;else if(32==t)e=5;else{if(4!=t)return this.toRadix(t);e=2}var r,n=(1<<e)-1,i=!1,o="",s=this.t,a=this.DB-s*this.DB%e;if(s-->0)for(a<this.DB&&(r=this[s]>>a)>0&&(i=!0,o=int2char(r));s>=0;)e>a?(r=(this[s]&(1<<a)-1)<<e-a,r|=this[--s]>>(a+=this.DB-e)):(r=this[s]>>(a-=e)&n,0>=a&&(a+=this.DB,--s)),r>0&&(i=!0),i&&(o+=int2char(r));return i?o:"0"}function bnNegate(){var t=nbi();return BigInteger.ZERO.subTo(this,t),t}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(t){var e=this.s-t.s;if(0!=e)return e;var r=this.t;if(e=r-t.t,0!=e)return this.s<0?-e:e;for(;--r>=0;)if(0!=(e=this[r]-t[r]))return e;return 0}function nbits(t){var e,r=1;return 0!=(e=t>>>16)&&(t=e,r+=16),0!=(e=t>>8)&&(t=e,r+=8),0!=(e=t>>4)&&(t=e,r+=4),0!=(e=t>>2)&&(t=e,r+=2),0!=(e=t>>1)&&(t=e,r+=1),r}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(t,e){var r;for(r=this.t-1;r>=0;--r)e[r+t]=this[r];for(r=t-1;r>=0;--r)e[r]=0;e.t=this.t+t,e.s=this.s}function bnpDRShiftTo(t,e){for(var r=t;r<this.t;++r)e[r-t]=this[r];e.t=Math.max(this.t-t,0),e.s=this.s}function bnpLShiftTo(t,e){var r,n=t%this.DB,i=this.DB-n,o=(1<<i)-1,s=Math.floor(t/this.DB),a=this.s<<n&this.DM;for(r=this.t-1;r>=0;--r)e[r+s+1]=this[r]>>i|a,a=(this[r]&o)<<n;for(r=s-1;r>=0;--r)e[r]=0;e[s]=a,e.t=this.t+s+1,e.s=this.s,e.clamp()}function bnpRShiftTo(t,e){e.s=this.s;var r=Math.floor(t/this.DB);if(r>=this.t)return void(e.t=0);var n=t%this.DB,i=this.DB-n,o=(1<<n)-1;e[0]=this[r]>>n;for(var s=r+1;s<this.t;++s)e[s-r-1]|=(this[s]&o)<<i,e[s-r]=this[s]>>n;n>0&&(e[this.t-r-1]|=(this.s&o)<<i),e.t=this.t-r,e.clamp()}function bnpSubTo(t,e){for(var r=0,n=0,i=Math.min(t.t,this.t);i>r;)n+=this[r]-t[r],e[r++]=n&this.DM,n>>=this.DB;if(t.t<this.t){for(n-=t.s;r<this.t;)n+=this[r],e[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<t.t;)n-=t[r],e[r++]=n&this.DM,n>>=this.DB;n-=t.s}e.s=0>n?-1:0,-1>n?e[r++]=this.DV+n:n>0&&(e[r++]=n),e.t=r,e.clamp()}function bnpMultiplyTo(t,e){var r=this.abs(),n=t.abs(),i=r.t;for(e.t=i+n.t;--i>=0;)e[i]=0;for(i=0;i<n.t;++i)e[i+r.t]=r.am(0,n[i],e,i,0,r.t);e.s=0,e.clamp(),this.s!=t.s&&BigInteger.ZERO.subTo(e,e)}function bnpSquareTo(t){for(var e=this.abs(),r=t.t=2*e.t;--r>=0;)t[r]=0;for(r=0;r<e.t-1;++r){var n=e.am(r,e[r],t,2*r,0,1);(t[r+e.t]+=e.am(r+1,2*e[r],t,2*r+1,n,e.t-r-1))>=e.DV&&(t[r+e.t]-=e.DV,t[r+e.t+1]=1)}t.t>0&&(t[t.t-1]+=e.am(r,e[r],t,2*r,0,1)),t.s=0,t.clamp()}function bnpDivRemTo(t,e,r){var n=t.abs();if(!(n.t<=0)){var i=this.abs();if(i.t<n.t)return null!=e&&e.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=nbi());var o=nbi(),s=this.s,a=t.s,l=this.DB-nbits(n[n.t-1]);l>0?(n.lShiftTo(l,o),i.lShiftTo(l,r)):(n.copyTo(o),i.copyTo(r));var u=o.t,c=o[u-1];if(0!=c){var p=c*(1<<this.F1)+(u>1?o[u-2]>>this.F2:0),h=this.FV/p,d=(1<<this.F1)/p,f=1<<this.F2,g=r.t,m=g-u,v=null==e?nbi():e;for(o.dlShiftTo(m,v),r.compareTo(v)>=0&&(r[r.t++]=1,r.subTo(v,r)),BigInteger.ONE.dlShiftTo(u,v),v.subTo(o,o);o.t<u;)o[o.t++]=0;for(;--m>=0;){var y=r[--g]==c?this.DM:Math.floor(r[g]*h+(r[g-1]+f)*d);if((r[g]+=o.am(0,y,r,m,0,u))<y)for(o.dlShiftTo(m,v),r.subTo(v,r);r[g]<--y;)r.subTo(v,r)}null!=e&&(r.drShiftTo(u,e),s!=a&&BigInteger.ZERO.subTo(e,e)),r.t=u,r.clamp(),l>0&&r.rShiftTo(l,r),0>s&&BigInteger.ZERO.subTo(r,r)}}}function bnMod(t){var e=nbi();return this.abs().divRemTo(t,null,e),this.s<0&&e.compareTo(BigInteger.ZERO)>0&&t.subTo(e,e),e}function Classic(t){this.m=t}function cConvert(t){return t.s<0||t.compareTo(this.m)>=0?t.mod(this.m):t}function cRevert(t){return t}function cReduce(t){t.divRemTo(this.m,null,t)}function cMulTo(t,e,r){t.multiplyTo(e,r),this.reduce(r)}function cSqrTo(t,e){t.squareTo(e),this.reduce(e)}function bnpInvDigit(){if(this.t<1)return 0;var t=this[0];if(0==(1&t))return 0;var e=3&t;return e=e*(2-(15&t)*e)&15,e=e*(2-(255&t)*e)&255,e=e*(2-((65535&t)*e&65535))&65535,e=e*(2-t*e%this.DV)%this.DV,e>0?this.DV-e:-e}function Montgomery(t){this.m=t,this.mp=t.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<t.DB-15)-1,this.mt2=2*t.t}function montConvert(t){var e=nbi();return t.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),t.s<0&&e.compareTo(BigInteger.ZERO)>0&&this.m.subTo(e,e),e}function montRevert(t){var e=nbi();return t.copyTo(e),this.reduce(e),e}function montReduce(t){for(;t.t<=this.mt2;)t[t.t++]=0;for(var e=0;e<this.m.t;++e){var r=32767&t[e],n=r*this.mpl+((r*this.mph+(t[e]>>15)*this.mpl&this.um)<<15)&t.DM;for(r=e+this.m.t,t[r]+=this.m.am(0,n,t,e,0,this.m.t);t[r]>=t.DV;)t[r]-=t.DV,t[++r]++}t.clamp(),t.drShiftTo(this.m.t,t),t.compareTo(this.m)>=0&&t.subTo(this.m,t)}function montSqrTo(t,e){t.squareTo(e),this.reduce(e)}function montMulTo(t,e,r){t.multiplyTo(e,r),this.reduce(r)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(t,e){if(t>4294967295||1>t)return BigInteger.ONE;var r=nbi(),n=nbi(),i=e.convert(this),o=nbits(t)-1;for(i.copyTo(r);--o>=0;)if(e.sqrTo(r,n),(t&1<<o)>0)e.mulTo(n,i,r);else{var s=r;r=n,n=s}return e.revert(r)}function bnModPowInt(t,e){var r;return r=256>t||e.isEven()?new Classic(e):new Montgomery(e),this.exp(t,r)}function bnClone(){var t=nbi();return this.copyTo(t),t}function bnIntValue(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return 0==this.t?this.s:this[0]<<24>>24}function bnShortValue(){return 0==this.t?this.s:this[0]<<16>>16}function bnpChunkSize(t){return Math.floor(Math.LN2*this.DB/Math.log(t))}function bnSigNum(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function bnpToRadix(t){if(null==t&&(t=10),0==this.signum()||2>t||t>36)return"0";var e=this.chunkSize(t),r=Math.pow(t,e),n=nbv(r),i=nbi(),o=nbi(),s="";for(this.divRemTo(n,i,o);i.signum()>0;)s=(r+o.intValue()).toString(t).substr(1)+s,i.divRemTo(n,i,o);return o.intValue().toString(t)+s}function bnpFromRadix(t,e){this.fromInt(0),null==e&&(e=10);for(var r=this.chunkSize(e),n=Math.pow(e,r),i=!1,o=0,s=0,a=0;a<t.length;++a){var l=intAt(t,a);0>l?"-"==t.charAt(a)&&0==this.signum()&&(i=!0):(s=e*s+l,++o>=r&&(this.dMultiply(n),this.dAddOffset(s,0),o=0,s=0))}o>0&&(this.dMultiply(Math.pow(e,o)),this.dAddOffset(s,0)),i&&BigInteger.ZERO.subTo(this,this)}function bnpFromNumber(t,e,r){if("number"==typeof e)if(2>t)this.fromInt(1);else for(this.fromNumber(t,r),this.testBit(t-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(t-1),op_or,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>t&&this.subTo(BigInteger.ONE.shiftLeft(t-1),this);else{var n=new Array,i=7&t;n.length=(t>>3)+1,e.nextBytes(n),i>0?n[0]&=(1<<i)-1:n[0]=0,this.fromString(n,256)}}function bnToByteArray(){var t=this.t,e=new Array;e[0]=this.s;var r,n=this.DB-t*this.DB%8,i=0;if(t-->0)for(n<this.DB&&(r=this[t]>>n)!=(this.s&this.DM)>>n&&(e[i++]=r|this.s<<this.DB-n);t>=0;)8>n?(r=(this[t]&(1<<n)-1)<<8-n,r|=this[--t]>>(n+=this.DB-8)):(r=this[t]>>(n-=8)&255,0>=n&&(n+=this.DB,--t)),0!=(128&r)&&(r|=-256),0==i&&(128&this.s)!=(128&r)&&++i,(i>0||r!=this.s)&&(e[i++]=r);return e}function bnEquals(t){return 0==this.compareTo(t)}function bnMin(t){return this.compareTo(t)<0?this:t}function bnMax(t){return this.compareTo(t)>0?this:t}function bnpBitwiseTo(t,e,r){var n,i,o=Math.min(t.t,this.t);for(n=0;o>n;++n)r[n]=e(this[n],t[n]);if(t.t<this.t){for(i=t.s&this.DM,n=o;n<this.t;++n)r[n]=e(this[n],i);r.t=this.t}else{for(i=this.s&this.DM,n=o;n<t.t;++n)r[n]=e(i,t[n]);r.t=t.t}r.s=e(this.s,t.s),r.clamp()}function op_and(t,e){return t&e}function bnAnd(t){var e=nbi();return this.bitwiseTo(t,op_and,e),e}function op_or(t,e){return t|e}function bnOr(t){var e=nbi();return this.bitwiseTo(t,op_or,e),e}function op_xor(t,e){return t^e}function bnXor(t){var e=nbi();return this.bitwiseTo(t,op_xor,e),e}function op_andnot(t,e){return t&~e}function bnAndNot(t){var e=nbi();return this.bitwiseTo(t,op_andnot,e),e}function bnNot(){for(var t=nbi(),e=0;e<this.t;++e)t[e]=this.DM&~this[e];return t.t=this.t,t.s=~this.s,t}function bnShiftLeft(t){var e=nbi();return 0>t?this.rShiftTo(-t,e):this.lShiftTo(t,e),e}function bnShiftRight(t){var e=nbi();return 0>t?this.lShiftTo(-t,e):this.rShiftTo(t,e),e}function lbit(t){if(0==t)return-1;var e=0;return 0==(65535&t)&&(t>>=16,e+=16),0==(255&t)&&(t>>=8,e+=8),0==(15&t)&&(t>>=4,e+=4),0==(3&t)&&(t>>=2,e+=2),0==(1&t)&&++e,e}function bnGetLowestSetBit(){for(var t=0;t<this.t;++t)if(0!=this[t])return t*this.DB+lbit(this[t]);return this.s<0?this.t*this.DB:-1}function cbit(t){for(var e=0;0!=t;)t&=t-1,++e;return e}function bnBitCount(){for(var t=0,e=this.s&this.DM,r=0;r<this.t;++r)t+=cbit(this[r]^e);return t}function bnTestBit(t){var e=Math.floor(t/this.DB);return e>=this.t?0!=this.s:0!=(this[e]&1<<t%this.DB)}function bnpChangeBit(t,e){var r=BigInteger.ONE.shiftLeft(t);return this.bitwiseTo(r,e,r),r}function bnSetBit(t){return this.changeBit(t,op_or)}function bnClearBit(t){return this.changeBit(t,op_andnot)}function bnFlipBit(t){return this.changeBit(t,op_xor)}function bnpAddTo(t,e){for(var r=0,n=0,i=Math.min(t.t,this.t);i>r;)n+=this[r]+t[r],e[r++]=n&this.DM,n>>=this.DB;if(t.t<this.t){for(n+=t.s;r<this.t;)n+=this[r],e[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<t.t;)n+=t[r],e[r++]=n&this.DM,n>>=this.DB;n+=t.s}e.s=0>n?-1:0,n>0?e[r++]=n:-1>n&&(e[r++]=this.DV+n),e.t=r,e.clamp()}function bnAdd(t){var e=nbi();return this.addTo(t,e),e}function bnSubtract(t){var e=nbi();return this.subTo(t,e),e}function bnMultiply(t){var e=nbi();return this.multiplyTo(t,e),e}function bnSquare(){var t=nbi();return this.squareTo(t),t}function bnDivide(t){var e=nbi();return this.divRemTo(t,e,null),e}function bnRemainder(t){var e=nbi();return this.divRemTo(t,null,e),e}function bnDivideAndRemainder(t){var e=nbi(),r=nbi();return this.divRemTo(t,e,r),new Array(e,r)}function bnpDMultiply(t){this[this.t]=this.am(0,t-1,this,0,0,this.t),++this.t,this.clamp()}function bnpDAddOffset(t,e){if(0!=t){for(;this.t<=e;)this[this.t++]=0;for(this[e]+=t;this[e]>=this.DV;)this[e]-=this.DV,++e>=this.t&&(this[this.t++]=0),++this[e]}}function NullExp(){}function nNop(t){return t}function nMulTo(t,e,r){t.multiplyTo(e,r)}function nSqrTo(t,e){t.squareTo(e)}function bnPow(t){return this.exp(t,new NullExp)}function bnpMultiplyLowerTo(t,e,r){var n=Math.min(this.t+t.t,e);for(r.s=0,r.t=n;n>0;)r[--n]=0;var i;for(i=r.t-this.t;i>n;++n)r[n+this.t]=this.am(0,t[n],r,n,0,this.t);for(i=Math.min(t.t,e);i>n;++n)this.am(0,t[n],r,n,0,e-n);r.clamp()}function bnpMultiplyUpperTo(t,e,r){--e;var n=r.t=this.t+t.t-e;for(r.s=0;--n>=0;)r[n]=0;for(n=Math.max(e-this.t,0);n<t.t;++n)r[this.t+n-e]=this.am(e-n,t[n],r,0,0,this.t+n-e);r.clamp(),r.drShiftTo(1,r)}function Barrett(t){this.r2=nbi(),this.q3=nbi(),BigInteger.ONE.dlShiftTo(2*t.t,this.r2),this.mu=this.r2.divide(t),this.m=t}function barrettConvert(t){if(t.s<0||t.t>2*this.m.t)return t.mod(this.m);if(t.compareTo(this.m)<0)return t;var e=nbi();return t.copyTo(e),this.reduce(e),e}function barrettRevert(t){return t}function barrettReduce(t){for(t.drShiftTo(this.m.t-1,this.r2),t.t>this.m.t+1&&(t.t=this.m.t+1,t.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);t.compareTo(this.r2)<0;)t.dAddOffset(1,this.m.t+1);for(t.subTo(this.r2,t);t.compareTo(this.m)>=0;)t.subTo(this.m,t)}function barrettSqrTo(t,e){t.squareTo(e),this.reduce(e)}function barrettMulTo(t,e,r){t.multiplyTo(e,r),this.reduce(r)}function bnModPow(t,e){var r,n,i=t.bitLength(),o=nbv(1);if(0>=i)return o;r=18>i?1:48>i?3:144>i?4:768>i?5:6,n=8>i?new Classic(e):e.isEven()?new Barrett(e):new Montgomery(e);var s=new Array,a=3,l=r-1,u=(1<<r)-1;if(s[1]=n.convert(this),r>1){var c=nbi();for(n.sqrTo(s[1],c);u>=a;)s[a]=nbi(),n.mulTo(c,s[a-2],s[a]),a+=2}var p,h,d=t.t-1,f=!0,g=nbi();for(i=nbits(t[d])-1;d>=0;){for(i>=l?p=t[d]>>i-l&u:(p=(t[d]&(1<<i+1)-1)<<l-i,d>0&&(p|=t[d-1]>>this.DB+i-l)),a=r;0==(1&p);)p>>=1,--a;if((i-=a)<0&&(i+=this.DB,--d),f)s[p].copyTo(o),f=!1;else{for(;a>1;)n.sqrTo(o,g),n.sqrTo(g,o),a-=2;a>0?n.sqrTo(o,g):(h=o,o=g,g=h),n.mulTo(g,s[p],o)}for(;d>=0&&0==(t[d]&1<<i);)n.sqrTo(o,g),h=o,o=g,g=h,--i<0&&(i=this.DB-1,--d)}return n.revert(o)}function bnGCD(t){var e=this.s<0?this.negate():this.clone(),r=t.s<0?t.negate():t.clone();if(e.compareTo(r)<0){var n=e;e=r,r=n}var i=e.getLowestSetBit(),o=r.getLowestSetBit();if(0>o)return e;for(o>i&&(o=i),o>0&&(e.rShiftTo(o,e),r.rShiftTo(o,r));e.signum()>0;)(i=e.getLowestSetBit())>0&&e.rShiftTo(i,e),(i=r.getLowestSetBit())>0&&r.rShiftTo(i,r),e.compareTo(r)>=0?(e.subTo(r,e),e.rShiftTo(1,e)):(r.subTo(e,r),r.rShiftTo(1,r));return o>0&&r.lShiftTo(o,r),r}function bnpModInt(t){if(0>=t)return 0;var e=this.DV%t,r=this.s<0?t-1:0;if(this.t>0)if(0==e)r=this[0]%t;else for(var n=this.t-1;n>=0;--n)r=(e*r+this[n])%t;return r}function bnModInverse(t){var e=t.isEven();if(this.isEven()&&e||0==t.signum())return BigInteger.ZERO;for(var r=t.clone(),n=this.clone(),i=nbv(1),o=nbv(0),s=nbv(0),a=nbv(1);0!=r.signum();){for(;r.isEven();)r.rShiftTo(1,r),e?(i.isEven()&&o.isEven()||(i.addTo(this,i),o.subTo(t,o)),i.rShiftTo(1,i)):o.isEven()||o.subTo(t,o),o.rShiftTo(1,o);for(;n.isEven();)n.rShiftTo(1,n),e?(s.isEven()&&a.isEven()||(s.addTo(this,s),a.subTo(t,a)),s.rShiftTo(1,s)):a.isEven()||a.subTo(t,a),a.rShiftTo(1,a);r.compareTo(n)>=0?(r.subTo(n,r),e&&i.subTo(s,i),o.subTo(a,o)):(n.subTo(r,n),e&&s.subTo(i,s),a.subTo(o,a))}return 0!=n.compareTo(BigInteger.ONE)?BigInteger.ZERO:a.compareTo(t)>=0?a.subtract(t):a.signum()<0?(a.addTo(t,a),a.signum()<0?a.add(t):a):a}function bnIsProbablePrime(t){var e,r=this.abs();if(1==r.t&&r[0]<=lowprimes[lowprimes.length-1]){for(e=0;e<lowprimes.length;++e)if(r[0]==lowprimes[e])return!0;return!1}if(r.isEven())return!1;for(e=1;e<lowprimes.length;){for(var n=lowprimes[e],i=e+1;i<lowprimes.length&&lplim>n;)n*=lowprimes[i++];for(n=r.modInt(n);i>e;)if(n%lowprimes[e++]==0)return!1}return r.millerRabin(t)}function bnpMillerRabin(t){var e=this.subtract(BigInteger.ONE),r=e.getLowestSetBit();if(0>=r)return!1;var n=e.shiftRight(r);t=t+1>>1,t>lowprimes.length&&(t=lowprimes.length);for(var i=nbi(),o=0;t>o;++o){i.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var s=i.modPow(n,this);if(0!=s.compareTo(BigInteger.ONE)&&0!=s.compareTo(e)){for(var a=1;a++<r&&0!=s.compareTo(e);)if(s=s.modPowInt(2,this),0==s.compareTo(BigInteger.ONE))return!1;if(0!=s.compareTo(e))return!1}}return!0}function parseBigInt(t,e){return new BigInteger(t,e)}function linebrk(t,e){for(var r="",n=0;n+e<t.length;)r+=t.substring(n,n+e)+"\n",n+=e;return r+t.substring(n,t.length)}function byte2Hex(t){return 16>t?"0"+t.toString(16):t.toString(16)}function pkcs1pad2(t,e){if(e<t.length+11)return alert("Message too long for RSA"),null;for(var r=new Array,n=t.length-1;n>=0&&e>0;){var i=t.charCodeAt(n--);128>i?r[--e]=i:i>127&&2048>i?(r[--e]=63&i|128,r[--e]=i>>6|192):(r[--e]=63&i|128,r[--e]=i>>6&63|128,r[--e]=i>>12|224)}r[--e]=0;for(var o=new SecureRandom,s=new Array;e>2;){for(s[0]=0;0==s[0];)o.nextBytes(s);r[--e]=s[0]}return r[--e]=2,r[--e]=0,new BigInteger(r)}function oaep_mgf1_arr(t,e,r){for(var n="",i=0;n.length<e;)n+=r(String.fromCharCode.apply(String,t.concat([(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i]))),i+=1;return n}function oaep_pad(t,e,r){if(t.length+2*SHA1_SIZE+2>e)throw"Message too long for RSA";var n,i="";for(n=0;n<e-t.length-2*SHA1_SIZE-2;n+=1)i+="\x00";var o=rstr_sha1("")+i+""+t,s=new Array(SHA1_SIZE);(new SecureRandom).nextBytes(s);var a=oaep_mgf1_arr(s,o.length,r||rstr_sha1),l=[];for(n=0;n<o.length;n+=1)l[n]=o.charCodeAt(n)^a.charCodeAt(n);var u=oaep_mgf1_arr(l,s.length,rstr_sha1),c=[0];for(n=0;n<s.length;n+=1)c[n+1]=s[n]^u.charCodeAt(n);return new BigInteger(c.concat(l))}function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function RSASetPublic(t,e){this.isPublic=!0,"string"!=typeof t?(this.n=t,this.e=e):null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16)):alert("Invalid RSA public key")}function RSADoPublic(t){return t.modPowInt(this.e,this.n)}function RSAEncrypt(t){var e=pkcs1pad2(t,this.n.bitLength()+7>>3);if(null==e)return null;var r=this.doPublic(e);if(null==r)return null;var n=r.toString(16);return 0==(1&n.length)?n:"0"+n}function RSAEncryptOAEP(t,e){var r=oaep_pad(t,this.n.bitLength()+7>>3,e);if(null==r)return null;var n=this.doPublic(r);if(null==n)return null;var i=n.toString(16);return 0==(1&i.length)?i:"0"+i}function pkcs1unpad2(t,e){for(var r=t.toByteArray(),n=0;n<r.length&&0==r[n];)++n;if(r.length-n!=e-1||2!=r[n])return null;for(++n;0!=r[n];)if(++n>=r.length)return null;for(var i="";++n<r.length;){var o=255&r[n];128>o?i+=String.fromCharCode(o):o>191&&224>o?(i+=String.fromCharCode((31&o)<<6|63&r[n+1]),++n):(i+=String.fromCharCode((15&o)<<12|(63&r[n+1])<<6|63&r[n+2]),n+=2)}return i}function oaep_mgf1_str(t,e,r){for(var n="",i=0;n.length<e;)n+=r(t+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])),i+=1;return n}function oaep_unpad(t,e,r){t=t.toByteArray();var n;for(n=0;n<t.length;n+=1)t[n]&=255;for(;t.length<e;)t.unshift(0);if(t=String.fromCharCode.apply(String,t),t.length<2*SHA1_SIZE+2)throw"Cipher too short";var n,i=t.substr(1,SHA1_SIZE),o=t.substr(SHA1_SIZE+1),s=oaep_mgf1_str(o,SHA1_SIZE,r||rstr_sha1),a=[];for(n=0;n<i.length;n+=1)a[n]=i.charCodeAt(n)^s.charCodeAt(n);var l=oaep_mgf1_str(String.fromCharCode.apply(String,a),t.length-SHA1_SIZE,rstr_sha1),u=[];for(n=0;n<o.length;n+=1)u[n]=o.charCodeAt(n)^l.charCodeAt(n);if(u=String.fromCharCode.apply(String,u),u.substr(0,SHA1_SIZE)!==rstr_sha1(""))throw"Hash mismatch";u=u.substr(SHA1_SIZE);var c=u.indexOf(""),p=-1!=c?u.substr(0,c).lastIndexOf("\x00"):-1;if(p+1!=c)throw"Malformed data";return u.substr(c+1)}function RSASetPrivate(t,e,r){this.isPrivate=!0,"string"!=typeof t?(this.n=t,this.e=e,this.d=r):null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16),this.d=parseBigInt(r,16)):alert("Invalid RSA private key")}function RSASetPrivateEx(t,e,r,n,i,o,s,a){if(this.isPrivate=!0,null==t)throw"RSASetPrivateEx N == null";if(null==e)throw"RSASetPrivateEx E == null";if(0==t.length)throw"RSASetPrivateEx N.length == 0";if(0==e.length)throw"RSASetPrivateEx E.length == 0";null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16),this.d=parseBigInt(r,16),this.p=parseBigInt(n,16),this.q=parseBigInt(i,16),this.dmp1=parseBigInt(o,16),this.dmq1=parseBigInt(s,16),this.coeff=parseBigInt(a,16)):alert("Invalid RSA private key in RSASetPrivateEx")}function RSAGenerate(t,e){var r=new SecureRandom,n=t>>1;this.e=parseInt(e,16);for(var i=new BigInteger(e,16);;){for(;this.p=new BigInteger(t-n,1,r),0!=this.p.subtract(BigInteger.ONE).gcd(i).compareTo(BigInteger.ONE)||!this.p.isProbablePrime(10););for(;this.q=new BigInteger(n,1,r),0!=this.q.subtract(BigInteger.ONE).gcd(i).compareTo(BigInteger.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var o=this.p;this.p=this.q,this.q=o}var s=this.p.subtract(BigInteger.ONE),a=this.q.subtract(BigInteger.ONE),l=s.multiply(a);if(0==l.gcd(i).compareTo(BigInteger.ONE)){this.n=this.p.multiply(this.q),this.d=i.modInverse(l),this.dmp1=this.d.mod(s),this.dmq1=this.d.mod(a),this.coeff=this.q.modInverse(this.p);break}}}function RSADoPrivate(t){if(null==this.p||null==this.q)return t.modPow(this.d,this.n);for(var e=t.mod(this.p).modPow(this.dmp1,this.p),r=t.mod(this.q).modPow(this.dmq1,this.q);e.compareTo(r)<0;)e=e.add(this.p);return e.subtract(r).multiply(this.coeff).mod(this.p).multiply(this.q).add(r)}function RSADecrypt(t){var e=parseBigInt(t,16),r=this.doPrivate(e);return null==r?null:pkcs1unpad2(r,this.n.bitLength()+7>>3)}function RSADecryptOAEP(t,e){var r=parseBigInt(t,16),n=this.doPrivate(r);return null==n?null:oaep_unpad(n,this.n.bitLength()+7>>3,e)}function hex2b64(t){var e,r,n="";for(e=0;e+3<=t.length;e+=3)r=parseInt(t.substring(e,e+3),16),n+=b64map.charAt(r>>6)+b64map.charAt(63&r);if(e+1==t.length?(r=parseInt(t.substring(e,e+1),16),n+=b64map.charAt(r<<2)):e+2==t.length&&(r=parseInt(t.substring(e,e+2),16),n+=b64map.charAt(r>>2)+b64map.charAt((3&r)<<4)),b64pad)for(;(3&n.length)>0;)n+=b64pad;return n}function b64tohex(t){var e,r,n,i="",o=0;for(e=0;e<t.length&&t.charAt(e)!=b64pad;++e)n=b64map.indexOf(t.charAt(e)),0>n||(0==o?(i+=int2char(n>>2),r=3&n,o=1):1==o?(i+=int2char(r<<2|n>>4),r=15&n,o=2):2==o?(i+=int2char(r),i+=int2char(n>>2),r=3&n,o=3):(i+=int2char(r<<2|n>>4),i+=int2char(15&n),o=0));return 1==o&&(i+=int2char(r<<2)),i}function b64toBA(t){var e,r=b64tohex(t),n=new Array;for(e=0;2*e<r.length;++e)n[e]=parseInt(r.substring(2*e,2*e+2),16);return n}function _rsapem_pemToBase64(t){var e=t;return e=e.replace("-----BEGIN RSA PRIVATE KEY-----",""),e=e.replace("-----END RSA PRIVATE KEY-----",""),e=e.replace(/[ \n]+/g,"")}function _rsapem_getPosArrayOfChildrenFromHex(t){var e=new Array,r=ASN1HEX.getStartPosOfV_AtObj(t,0),n=ASN1HEX.getPosOfNextSibling_AtObj(t,r),i=ASN1HEX.getPosOfNextSibling_AtObj(t,n),o=ASN1HEX.getPosOfNextSibling_AtObj(t,i),s=ASN1HEX.getPosOfNextSibling_AtObj(t,o),a=ASN1HEX.getPosOfNextSibling_AtObj(t,s),l=ASN1HEX.getPosOfNextSibling_AtObj(t,a),u=ASN1HEX.getPosOfNextSibling_AtObj(t,l),c=ASN1HEX.getPosOfNextSibling_AtObj(t,u);return e.push(r,n,i,o,s,a,l,u,c),e}function _rsapem_getHexValueArrayOfChildrenFromHex(t){var e=_rsapem_getPosArrayOfChildrenFromHex(t),r=ASN1HEX.getHexOfV_AtObj(t,e[0]),n=ASN1HEX.getHexOfV_AtObj(t,e[1]),i=ASN1HEX.getHexOfV_AtObj(t,e[2]),o=ASN1HEX.getHexOfV_AtObj(t,e[3]),s=ASN1HEX.getHexOfV_AtObj(t,e[4]),a=ASN1HEX.getHexOfV_AtObj(t,e[5]),l=ASN1HEX.getHexOfV_AtObj(t,e[6]),u=ASN1HEX.getHexOfV_AtObj(t,e[7]),c=ASN1HEX.getHexOfV_AtObj(t,e[8]),p=new Array;return p.push(r,n,i,o,s,a,l,u,c),p}function _rsapem_readPrivateKeyFromASN1HexString(t){var e=_rsapem_getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}function _rsapem_readPrivateKeyFromPEMString(t){var e=_rsapem_pemToBase64(t),r=b64tohex(e),n=_rsapem_getHexValueArrayOfChildrenFromHex(r);this.setPrivateEx(n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}function _rsasign_getHexPaddedDigestInfoForString(t,e,r){var n=function(t){return KJUR.crypto.Util.hashString(t,r)},i=n(t);return KJUR.crypto.Util.getPaddedDigestInfoHex(i,r,e)}function _zeroPaddingOfSignature(t,e){for(var r="",n=e/4-t.length,i=0;n>i;i++)r+="0";return r+t}function _rsasign_signString(t,e){var r=function(t){return KJUR.crypto.Util.hashString(t,e)},n=r(t);return this.signWithMessageHash(n,e)}function _rsasign_signWithMessageHash(t,e){var r=KJUR.crypto.Util.getPaddedDigestInfoHex(t,e,this.n.bitLength()),n=parseBigInt(r,16),i=this.doPrivate(n),o=i.toString(16);return _zeroPaddingOfSignature(o,this.n.bitLength())}function _rsasign_signStringWithSHA1(t){return _rsasign_signString.call(this,t,"sha1")}function _rsasign_signStringWithSHA256(t){return _rsasign_signString.call(this,t,"sha256")}function pss_mgf1_str(t,e,r){for(var n="",i=0;n.length<e;)n+=hextorstr(r(rstrtohex(t+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return n}function _rsasign_signStringPSS(t,e,r){var n=function(t){return KJUR.crypto.Util.hashHex(t,e)},i=n(rstrtohex(t));return void 0===r&&(r=-1),this.signWithMessageHashPSS(i,e,r)}function _rsasign_signWithMessageHashPSS(t,e,r){var n,i=hextorstr(t),o=i.length,s=this.n.bitLength()-1,a=Math.ceil(s/8),l=function(t){return KJUR.crypto.Util.hashHex(t,e)};if(-1===r||void 0===r)r=o;else if(-2===r)r=a-o-2;else if(-2>r)throw"invalid salt length";if(o+r+2>a)throw"data too long";var u="";r>0&&(u=new Array(r),(new SecureRandom).nextBytes(u),u=String.fromCharCode.apply(String,u));var c=hextorstr(l(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+i+u))),p=[];for(n=0;a-r-o-2>n;n+=1)p[n]=0;var h=String.fromCharCode.apply(String,p)+""+u,d=pss_mgf1_str(c,h.length,l),f=[];for(n=0;n<h.length;n+=1)f[n]=h.charCodeAt(n)^d.charCodeAt(n);var g=65280>>8*a-s&255;for(f[0]&=~g,n=0;o>n;n++)f.push(c.charCodeAt(n));return f.push(188),_zeroPaddingOfSignature(this.doPrivate(new BigInteger(f)).toString(16),this.n.bitLength())}function _rsasign_getDecryptSignatureBI(t,e,r){var n=new RSAKey;n.setPublic(e,r);var i=n.doPublic(t);return i}function _rsasign_getHexDigestInfoFromSig(t,e,r){var n=_rsasign_getDecryptSignatureBI(t,e,r),i=n.toString(16).replace(/^1f+00/,"");return i}function _rsasign_getAlgNameAndHashFromHexDisgestInfo(t){for(var e in KJUR.crypto.Util.DIGESTINFOHEAD){var r=KJUR.crypto.Util.DIGESTINFOHEAD[e],n=r.length;if(t.substring(0,n)==r){var i=[e,t.substring(n)];return i}}return[]}function _rsasign_verifySignatureWithArgs(t,e,r,n){var i=_rsasign_getHexDigestInfoFromSig(e,r,n),o=_rsasign_getAlgNameAndHashFromHexDisgestInfo(i);if(0==o.length)return!1;var s=o[0],a=o[1],l=function(t){return KJUR.crypto.Util.hashString(t,s)},u=l(t);return a==u}function _rsasign_verifyHexSignatureForMessage(t,e){var r=parseBigInt(t,16),n=_rsasign_verifySignatureWithArgs(e,r,this.n.toString(16),this.e.toString(16));return n}function _rsasign_verifyString(t,e){e=e.replace(_RE_HEXDECONLY,""),e=e.replace(/[ \n]+/g,"");var r=parseBigInt(e,16);if(r.bitLength()>this.n.bitLength())return 0;var n=this.doPublic(r),i=n.toString(16).replace(/^1f+00/,""),o=_rsasign_getAlgNameAndHashFromHexDisgestInfo(i);if(0==o.length)return!1;var s=o[0],a=o[1],l=function(t){return KJUR.crypto.Util.hashString(t,s)},u=l(t);return a==u}function _rsasign_verifyWithMessageHash(t,e){e=e.replace(_RE_HEXDECONLY,""),e=e.replace(/[ \n]+/g,"");var r=parseBigInt(e,16);if(r.bitLength()>this.n.bitLength())return 0;var n=this.doPublic(r),i=n.toString(16).replace(/^1f+00/,""),o=_rsasign_getAlgNameAndHashFromHexDisgestInfo(i);if(0==o.length)return!1;var s=(o[0],o[1]);return s==t}function _rsasign_verifyStringPSS(t,e,r,n){var i=function(t){return KJUR.crypto.Util.hashHex(t,r)},o=i(rstrtohex(t));return void 0===n&&(n=-1),this.verifyWithMessageHashPSS(o,e,r,n)}function _rsasign_verifyWithMessageHashPSS(t,e,r,n){var i=new BigInteger(e,16);if(i.bitLength()>this.n.bitLength())return!1;var o,s=function(t){return KJUR.crypto.Util.hashHex(t,r)},a=hextorstr(t),l=a.length,u=this.n.bitLength()-1,c=Math.ceil(u/8);if(-1===n||void 0===n)n=l;else if(-2===n)n=c-l-2;else if(-2>n)throw"invalid salt length";if(l+n+2>c)throw"data too long";var p=this.doPublic(i).toByteArray();for(o=0;o<p.length;o+=1)p[o]&=255;for(;p.length<c;)p.unshift(0);if(188!==p[c-1])throw"encoded message does not end in 0xbc";p=String.fromCharCode.apply(String,p);var h=p.substr(0,c-l-1),d=p.substr(h.length,l),f=65280>>8*c-u&255;if(0!==(h.charCodeAt(0)&f))throw"bits beyond keysize not zero";var g=pss_mgf1_str(d,h.length,s),m=[];for(o=0;o<h.length;o+=1)m[o]=h.charCodeAt(o)^g.charCodeAt(o);m[0]&=~f;var v=c-l-n-2;for(o=0;v>o;o+=1)if(0!==m[o])throw"leftmost octets not zero";if(1!==m[v])throw"0x01 marker not found";return d===hextorstr(s(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+a+String.fromCharCode.apply(String,m.slice(-n)))))}function X509(){this.subjectPublicKeyRSA=null,this.subjectPublicKeyRSA_hN=null,this.subjectPublicKeyRSA_hE=null,this.hex=null,this.getSerialNumberHex=function(){return ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,1])},this.getIssuerHex=function(){return ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,3])},this.getIssuerString=function(){return X509.hex2dn(ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,3]))},this.getSubjectHex=function(){return ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,5])},this.getSubjectString=function(){return X509.hex2dn(ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,5]))},this.getNotBefore=function(){var t=ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,4,0]);return t=t.replace(/(..)/g,"%$1"),t=decodeURIComponent(t)},this.getNotAfter=function(){var t=ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,4,1]);return t=t.replace(/(..)/g,"%$1"),t=decodeURIComponent(t)},this.readCertPEM=function(t){var e=X509.pemToHex(t),r=X509.getPublicKeyHexArrayFromCertHex(e),n=new RSAKey;n.setPublic(r[0],r[1]),this.subjectPublicKeyRSA=n,this.subjectPublicKeyRSA_hN=r[0],this.subjectPublicKeyRSA_hE=r[1],this.hex=e},this.readCertPEMWithoutRSAInit=function(t){var e=X509.pemToHex(t),r=X509.getPublicKeyHexArrayFromCertHex(e);this.subjectPublicKeyRSA.setPublic(r[0],r[1]),this.subjectPublicKeyRSA_hN=r[0],this.subjectPublicKeyRSA_hE=r[1],this.hex=e}}!function(t){function e(){a=!1}function r(){u&&(window.clearTimeout(p),u=!1,c=null)}function n(t){u||(u=!0,c=t.changedTouches[0],p=window.setTimeout("doRightClick();",800))}function i(t){var r=t.changedTouches,i=r[0],o="mouseover",u=document.createEvent("MouseEvent");u.initMouseEvent(o,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(u),o="mousedown",u=document.createEvent("MouseEvent"),u.initMouseEvent(o,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(u),a?(window.clearTimeout(l),i.target==s?(s=null,a=!1,o="click",u=document.createEvent("MouseEvent"),u.initMouseEvent(o,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(u),o="dblclick",u=document.createEvent("MouseEvent"),u.initMouseEvent(o,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(u)):(s=i.target,a=!0,l=window.setTimeout(function(){e()},600),n(t))):(s=i.target,a=!0,l=window.setTimeout(function(){e()},600),n(t))}function o(e){var n="",o=0;if(!(e.touches.length>1)){switch(e.type){case"touchstart":if(t(e.changedTouches[0].target).is("select"))return;return i(e),e.preventDefault(),!1;case"touchmove":r(),n="mousemove",e.preventDefault();break;case"touchend":if(h)return h=!1,e.preventDefault(),!1;r(),n="mouseup";break;default:return}var l=e.changedTouches,u=l[0],c=document.createEvent("MouseEvent");c.initMouseEvent(n,!0,!0,window,1,u.screenX,u.screenY,u.clientX,u.clientY,!1,!1,!1,!1,o,null),u.target.dispatchEvent(c),"mouseup"==n&&a&&u.target==s&&(c=document.createEvent("MouseEvent"),c.initMouseEvent("click",!0,!0,window,1,u.screenX,u.screenY,u.clientX,u.clientY,!1,!1,!1,!1,o,null),u.target.dispatchEvent(c))}}var s=null,a=!1,l=null,u=!1,c=null,p=null,h=!1;
t.extend(t.support,{touch:"ontouchend"in document}),t.fn.addTouch=function(){t.support.touch&&this.each(function(t,e){e.addEventListener("touchstart",o,!1),e.addEventListener("touchmove",o,!1),e.addEventListener("touchend",o,!1),e.addEventListener("touchcancel",o,!1)})},t.fn.addTouchLive=function(e){t.support.touch&&this.each(function(r,n){t(n).on("touchstart",e,function(t){o(t.originalEvent)}),t(n).on("touchmove",e,function(t){o(t.originalEvent)}),t(n).on("touchend",e,function(t){o(t.originalEvent)}),t(n).on("touchcancel",e,function(t){o(t.originalEvent)})})}}(jQuery),function(t,e,r,n,i,o,s){function a(t){var e,n,i=this,o=t.length,s=0,a=i.i=i.j=i.m=0;for(i.S=[],i.c=[],o||(t=[o++]);r>s;)i.S[s]=s++;for(s=0;r>s;s++)e=i.S[s],a=c(a+e+t[s%o]),n=i.S[a],i.S[s]=n,i.S[a]=e;i.g=function(t){var e=i.S,n=c(i.i+1),o=e[n],s=c(i.j+o),a=e[s];e[n]=a,e[s]=o;for(var l=e[c(o+a)];--t;)n=c(n+1),o=e[n],s=c(s+o),a=e[s],e[n]=a,e[s]=o,l=l*r+e[c(o+a)];return i.i=n,i.j=s,l},i.g(r)}function l(t,e,r,n,i){if(r=[],i=typeof t,e&&"object"==i)for(n in t)if(n.indexOf("S")<5)try{r.push(l(t[n],e-1))}catch(o){}return r.length?r:t+("string"!=i?"\x00":"")}function u(t,e,r,n){for(t+="",r=0,n=0;n<t.length;n++)e[c(n)]=c((r^=19*e[c(n)])+t.charCodeAt(n));t="";for(n in e)t+=String.fromCharCode(e[n]);return t}function c(t){return t&r-1}e.seedrandom=function(c,p){var h,d=[];c=u(l(p?[c,t]:arguments.length?c:[(new Date).getTime(),t,window],3),d),h=new a(d),u(h.S,t),e.random=function(){for(var t=h.g(n),e=s,a=0;i>t;)t=(t+a)*r,e*=r,a=h.g(1);for(;t>=o;)t/=2,e/=2,a>>>=1;return(t+a)/e};var f=function(t){if(0>t)throw"n must be non-negative";var e=Math.max(Math.ceil(Math.log(t)/Math.log(r)),1);if(e>n)throw"n cannot be greater than "+r+"^"+n;var i,o=Math.pow(r,e),s=t*Math.floor(o/t),a=0;do i=h.g(e),a++;while(i>=s&&100>a);return i%t};return Math.randomInt=f,f},s=e.pow(r,n),i=e.pow(2,i),o=2*i,u(e.random(),t)}([],Math,256,6,52);var dbits,canary=0xdeadbeefcafe,j_lm=15715070==(16777215&canary);j_lm&&"Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=am2,dbits=30):j_lm&&"Netscape"!=navigator.appName?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array,rr,vv;for(rr="0".charCodeAt(0),vv=0;9>=vv;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;36>vv;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;36>vv;++vv)BI_RC[rr++]=vv;Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=nMulTo,NullExp.prototype.sqrTo=nSqrTo,Barrett.prototype.convert=barrettConvert,Barrett.prototype.revert=barrettRevert,Barrett.prototype.reduce=barrettReduce,Barrett.prototype.mulTo=barrettMulTo,Barrett.prototype.sqrTo=barrettSqrTo;var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];BigInteger.prototype.chunkSize=bnpChunkSize,BigInteger.prototype.toRadix=bnpToRadix,BigInteger.prototype.fromRadix=bnpFromRadix,BigInteger.prototype.fromNumber=bnpFromNumber,BigInteger.prototype.bitwiseTo=bnpBitwiseTo,BigInteger.prototype.changeBit=bnpChangeBit,BigInteger.prototype.addTo=bnpAddTo,BigInteger.prototype.dMultiply=bnpDMultiply,BigInteger.prototype.dAddOffset=bnpDAddOffset,BigInteger.prototype.multiplyLowerTo=bnpMultiplyLowerTo,BigInteger.prototype.multiplyUpperTo=bnpMultiplyUpperTo,BigInteger.prototype.modInt=bnpModInt,BigInteger.prototype.millerRabin=bnpMillerRabin,BigInteger.prototype.clone=bnClone,BigInteger.prototype.intValue=bnIntValue,BigInteger.prototype.byteValue=bnByteValue,BigInteger.prototype.shortValue=bnShortValue,BigInteger.prototype.signum=bnSigNum,BigInteger.prototype.toByteArray=bnToByteArray,BigInteger.prototype.equals=bnEquals,BigInteger.prototype.min=bnMin,BigInteger.prototype.max=bnMax,BigInteger.prototype.and=bnAnd,BigInteger.prototype.or=bnOr,BigInteger.prototype.xor=bnXor,BigInteger.prototype.andNot=bnAndNot,BigInteger.prototype.not=bnNot,BigInteger.prototype.shiftLeft=bnShiftLeft,BigInteger.prototype.shiftRight=bnShiftRight,BigInteger.prototype.getLowestSetBit=bnGetLowestSetBit,BigInteger.prototype.bitCount=bnBitCount,BigInteger.prototype.testBit=bnTestBit,BigInteger.prototype.setBit=bnSetBit,BigInteger.prototype.clearBit=bnClearBit,BigInteger.prototype.flipBit=bnFlipBit,BigInteger.prototype.add=bnAdd,BigInteger.prototype.subtract=bnSubtract,BigInteger.prototype.multiply=bnMultiply,BigInteger.prototype.divide=bnDivide,BigInteger.prototype.remainder=bnRemainder,BigInteger.prototype.divideAndRemainder=bnDivideAndRemainder,BigInteger.prototype.modPow=bnModPow,BigInteger.prototype.modInverse=bnModInverse,BigInteger.prototype.pow=bnPow,BigInteger.prototype.gcd=bnGCD,BigInteger.prototype.isProbablePrime=bnIsProbablePrime,BigInteger.prototype.square=bnSquare;var SHA1_SIZE=20;RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.encrypt=RSAEncrypt,RSAKey.prototype.encryptOAEP=RSAEncryptOAEP,RSAKey.prototype.type="RSA";var SHA1_SIZE=20;RSAKey.prototype.doPrivate=RSADoPrivate,RSAKey.prototype.setPrivate=RSASetPrivate,RSAKey.prototype.setPrivateEx=RSASetPrivateEx,RSAKey.prototype.generate=RSAGenerate,RSAKey.prototype.decrypt=RSADecrypt,RSAKey.prototype.decryptOAEP=RSADecryptOAEP;var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64pad="=",CryptoJS=CryptoJS||function(t,e){var r={},n=r.lib={},i=n.Base=function(){function t(){}return{extend:function(e){t.prototype=this;var r=new t;return e&&r.mixIn(e),r.hasOwnProperty("init")||(r.init=function(){r.$super.init.apply(this,arguments)}),r.init.prototype=r,r.$super=this,r},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),o=n.WordArray=i.extend({init:function(t,r){t=this.words=t||[],this.sigBytes=r!=e?r:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,r=t.words,n=this.sigBytes,i=t.sigBytes;if(this.clamp(),n%4)for(var o=0;i>o;o++){var s=r[o>>>2]>>>24-o%4*8&255;e[n+o>>>2]|=s<<24-(n+o)%4*8}else if(r.length>65535)for(var o=0;i>o;o+=4)e[n+o>>>2]=r[o>>>2];else e.push.apply(e,r);return this.sigBytes+=i,this},clamp:function(){var e=this.words,r=this.sigBytes;e[r>>>2]&=4294967295<<32-r%4*8,e.length=t.ceil(r/4)},clone:function(){var t=i.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var r=[],n=0;e>n;n+=4)r.push(4294967296*t.random()|0);return new o.init(r,e)}}),s=r.enc={},a=s.Hex={stringify:function(t){for(var e=t.words,r=t.sigBytes,n=[],i=0;r>i;i++){var o=e[i>>>2]>>>24-i%4*8&255;n.push((o>>>4).toString(16)),n.push((15&o).toString(16))}return n.join("")},parse:function(t){for(var e=t.length,r=[],n=0;e>n;n+=2)r[n>>>3]|=parseInt(t.substr(n,2),16)<<24-n%8*4;return new o.init(r,e/2)}},l=s.Latin1={stringify:function(t){for(var e=t.words,r=t.sigBytes,n=[],i=0;r>i;i++){var o=e[i>>>2]>>>24-i%4*8&255;n.push(String.fromCharCode(o))}return n.join("")},parse:function(t){for(var e=t.length,r=[],n=0;e>n;n++)r[n>>>2]|=(255&t.charCodeAt(n))<<24-n%4*8;return new o.init(r,e)}},u=s.Utf8={stringify:function(t){try{return decodeURIComponent(escape(l.stringify(t)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(t){return l.parse(unescape(encodeURIComponent(t)))}},c=n.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=u.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var r=this._data,n=r.words,i=r.sigBytes,s=this.blockSize,a=4*s,l=i/a;l=e?t.ceil(l):t.max((0|l)-this._minBufferSize,0);var u=l*s,c=t.min(4*u,i);if(u){for(var p=0;u>p;p+=s)this._doProcessBlock(n,p);var h=n.splice(0,u);r.sigBytes-=c}return new o.init(h,c)},clone:function(){var t=i.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),p=(n.Hasher=c.extend({cfg:i.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){t&&this._append(t);var e=this._doFinalize();return e},blockSize:16,_createHelper:function(t){return function(e,r){return new t.init(r).finalize(e)}},_createHmacHelper:function(t){return function(e,r){return new p.HMAC.init(t,r).finalize(e)}}}),r.algo={});return r}(Math);!function(){var t=CryptoJS,e=t.lib,r=e.WordArray,n=e.Hasher,i=t.algo,o=[],s=i.SHA1=n.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var r=this._hash.words,n=r[0],i=r[1],s=r[2],a=r[3],l=r[4],u=0;80>u;u++){if(16>u)o[u]=0|t[e+u];else{var c=o[u-3]^o[u-8]^o[u-14]^o[u-16];o[u]=c<<1|c>>>31}var p=(n<<5|n>>>27)+l+o[u];p+=20>u?(i&s|~i&a)+1518500249:40>u?(i^s^a)+1859775393:60>u?(i&s|i&a|s&a)-1894007588:(i^s^a)-899497514,l=a,a=s,s=i<<30|i>>>2,i=n,n=p}r[0]=r[0]+n|0,r[1]=r[1]+i|0,r[2]=r[2]+s|0,r[3]=r[3]+a|0,r[4]=r[4]+l|0},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,n=8*t.sigBytes;return e[n>>>5]|=128<<24-n%32,e[(n+64>>>9<<4)+14]=Math.floor(r/4294967296),e[(n+64>>>9<<4)+15]=r,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=n.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA1=n._createHelper(s),t.HmacSHA1=n._createHmacHelper(s)}(),RSAKey.prototype.readPrivateKeyFromPEMString=_rsapem_readPrivateKeyFromPEMString,RSAKey.prototype.readPrivateKeyFromASN1HexString=_rsapem_readPrivateKeyFromASN1HexString;var _RE_HEXDECONLY=new RegExp("");_RE_HEXDECONLY.compile("[^0-9a-f]","gi"),RSAKey.prototype.signWithMessageHash=_rsasign_signWithMessageHash,RSAKey.prototype.signString=_rsasign_signString,RSAKey.prototype.signStringWithSHA1=_rsasign_signStringWithSHA1,RSAKey.prototype.signStringWithSHA256=_rsasign_signStringWithSHA256,RSAKey.prototype.sign=_rsasign_signString,RSAKey.prototype.signWithSHA1=_rsasign_signStringWithSHA1,RSAKey.prototype.signWithSHA256=_rsasign_signStringWithSHA256,RSAKey.prototype.signWithMessageHashPSS=_rsasign_signWithMessageHashPSS,RSAKey.prototype.signStringPSS=_rsasign_signStringPSS,RSAKey.prototype.signPSS=_rsasign_signStringPSS,RSAKey.SALT_LEN_HLEN=-1,RSAKey.SALT_LEN_MAX=-2,RSAKey.prototype.verifyWithMessageHash=_rsasign_verifyWithMessageHash,RSAKey.prototype.verifyString=_rsasign_verifyString,RSAKey.prototype.verifyHexSignatureForMessage=_rsasign_verifyHexSignatureForMessage,RSAKey.prototype.verify=_rsasign_verifyString,RSAKey.prototype.verifyHexSignatureForByteArrayMessage=_rsasign_verifyHexSignatureForMessage,RSAKey.prototype.verifyWithMessageHashPSS=_rsasign_verifyWithMessageHashPSS,RSAKey.prototype.verifyStringPSS=_rsasign_verifyStringPSS,RSAKey.prototype.verifyPSS=_rsasign_verifyStringPSS,RSAKey.SALT_LEN_RECOVER=-2;var ASN1HEX=new function(){this.getByteLengthOfL_AtObj=function(t,e){if("8"!=t.substring(e+2,e+3))return 1;var r=parseInt(t.substring(e+3,e+4));return 0==r?-1:r>0&&10>r?r+1:-2},this.getHexOfL_AtObj=function(t,e){var r=this.getByteLengthOfL_AtObj(t,e);return 1>r?"":t.substring(e+2,e+2+2*r)},this.getIntOfL_AtObj=function(t,e){var r=this.getHexOfL_AtObj(t,e);if(""==r)return-1;var n;return n=parseInt(r.substring(0,1))<8?new BigInteger(r,16):new BigInteger(r.substring(2),16),n.intValue()},this.getStartPosOfV_AtObj=function(t,e){var r=this.getByteLengthOfL_AtObj(t,e);return 0>r?r:e+2*(r+1)},this.getHexOfV_AtObj=function(t,e){var r=this.getStartPosOfV_AtObj(t,e),n=this.getIntOfL_AtObj(t,e);return t.substring(r,r+2*n)},this.getHexOfTLV_AtObj=function(t,e){var r=t.substr(e,2),n=this.getHexOfL_AtObj(t,e),i=this.getHexOfV_AtObj(t,e);return r+n+i},this.getPosOfNextSibling_AtObj=function(t,e){var r=this.getStartPosOfV_AtObj(t,e),n=this.getIntOfL_AtObj(t,e);return r+2*n},this.getPosArrayOfChildren_AtObj=function(t,e){var r=new Array,n=this.getStartPosOfV_AtObj(t,e);r.push(n);for(var i=this.getIntOfL_AtObj(t,e),o=n,s=0;;){var a=this.getPosOfNextSibling_AtObj(t,o);if(null==a||a-n>=2*i)break;if(s>=200)break;r.push(a),o=a,s++}return r},this.getNthChildIndex_AtObj=function(t,e,r){var n=this.getPosArrayOfChildren_AtObj(t,e);return n[r]},this.getDecendantIndexByNthList=function(t,e,r){if(0==r.length)return e;var n=r.shift(),i=this.getPosArrayOfChildren_AtObj(t,e);return this.getDecendantIndexByNthList(t,i[n],r)},this.getDecendantHexTLVByNthList=function(t,e,r){var n=this.getDecendantIndexByNthList(t,e,r);return this.getHexOfTLV_AtObj(t,n)},this.getDecendantHexVByNthList=function(t,e,r){var n=this.getDecendantIndexByNthList(t,e,r);return this.getHexOfV_AtObj(t,n)}};ASN1HEX.getVbyList=function(t,e,r,n){var i=this.getDecendantIndexByNthList(t,e,r);if(void 0===i)throw"can't find nthList object";if(void 0!==n&&t.substr(i,2)!=n)throw"checking tag doesn't match: "+t.substr(i,2)+"!="+n;return this.getHexOfV_AtObj(t,i)},X509.pemToBase64=function(t){var e=t;return e=e.replace("-----BEGIN CERTIFICATE-----",""),e=e.replace("-----END CERTIFICATE-----",""),e=e.replace(/[ \n]+/g,"")},X509.pemToHex=function(t){var e=X509.pemToBase64(t),r=b64tohex(e);return r},X509.getSubjectPublicKeyPosFromCertHex=function(t){var e=X509.getSubjectPublicKeyInfoPosFromCertHex(t);if(-1==e)return-1;var r=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);if(2!=r.length)return-1;var n=r[1];if("03"!=t.substring(n,n+2))return-1;var i=ASN1HEX.getStartPosOfV_AtObj(t,n);return"00"!=t.substring(i,i+2)?-1:i+2},X509.getSubjectPublicKeyInfoPosFromCertHex=function(t){var e=ASN1HEX.getStartPosOfV_AtObj(t,0),r=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);return r.length<1?-1:"a003020102"==t.substring(r[0],r[0]+10)?r.length<6?-1:r[6]:r.length<5?-1:r[5]},X509.getPublicKeyHexArrayFromCertHex=function(t){var e=X509.getSubjectPublicKeyPosFromCertHex(t),r=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);if(2!=r.length)return[];var n=ASN1HEX.getHexOfV_AtObj(t,r[0]),i=ASN1HEX.getHexOfV_AtObj(t,r[1]);return null!=n&&null!=i?[n,i]:[]},X509.getHexTbsCertificateFromCert=function(t){var e=ASN1HEX.getStartPosOfV_AtObj(t,0);return e},X509.getPublicKeyHexArrayFromCertPEM=function(t){var e=X509.pemToHex(t),r=X509.getPublicKeyHexArrayFromCertHex(e);return r},X509.hex2dn=function(t){for(var e="",r=ASN1HEX.getPosArrayOfChildren_AtObj(t,0),n=0;n<r.length;n++){var i=ASN1HEX.getHexOfTLV_AtObj(t,r[n]);e=e+"/"+X509.hex2rdn(i)}return e},X509.hex2rdn=function(t){var e=ASN1HEX.getDecendantHexTLVByNthList(t,0,[0,0]),r=ASN1HEX.getDecendantHexVByNthList(t,0,[0,1]),n="";try{n=X509.DN_ATTRHEX[e]}catch(i){n=e}r=r.replace(/(..)/g,"%$1");var o=decodeURIComponent(r);return n+"="+o},X509.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"},X509.getPublicKeyFromCertPEM=function(t){var e=X509.getPublicKeyInfoPropOfCertPEM(t);if("2a864886f70d010101"==e.algoid){var r=KEYUTIL.parsePublicRawRSAKeyHex(e.keyhex),n=new RSAKey;return n.setPublic(r.n,r.e),n}if("2a8648ce3d0201"==e.algoid){var i=KJUR.crypto.OID.oidhex2name[e.algparam],n=new KJUR.crypto.ECDSA({curve:i,info:e.keyhex});return n.setPublicKeyHex(e.keyhex),n}if("2a8648ce380401"==e.algoid){var o=ASN1HEX.getVbyList(e.algparam,0,[0],"02"),s=ASN1HEX.getVbyList(e.algparam,0,[1],"02"),a=ASN1HEX.getVbyList(e.algparam,0,[2],"02"),l=ASN1HEX.getHexOfV_AtObj(e.keyhex,0);l=l.substr(2);var n=new KJUR.crypto.DSA;return n.setPublic(new BigInteger(o,16),new BigInteger(s,16),new BigInteger(a,16),new BigInteger(l,16)),n}throw"unsupported key"},X509.getPublicKeyInfoPropOfCertPEM=function(t){var e={};e.algparam=null;var r=X509.pemToHex(t),n=ASN1HEX.getPosArrayOfChildren_AtObj(r,0);if(3!=n.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=r.substr(n[0],2))throw"malformed X.509 certificate PEM (code:002)";var i=ASN1HEX.getPosArrayOfChildren_AtObj(r,n[0]);if(i.length<7)throw"malformed X.509 certificate PEM (code:003)";var o=ASN1HEX.getPosArrayOfChildren_AtObj(r,i[6]);if(2!=o.length)throw"malformed X.509 certificate PEM (code:004)";var s=ASN1HEX.getPosArrayOfChildren_AtObj(r,o[0]);if(2!=s.length)throw"malformed X.509 certificate PEM (code:005)";if(e.algoid=ASN1HEX.getHexOfV_AtObj(r,s[0]),"06"==r.substr(s[1],2)?e.algparam=ASN1HEX.getHexOfV_AtObj(r,s[1]):"30"==r.substr(s[1],2)&&(e.algparam=ASN1HEX.getHexOfTLV_AtObj(r,s[1])),"03"!=r.substr(o[1],2))throw"malformed X.509 certificate PEM (code:006)";var a=ASN1HEX.getHexOfV_AtObj(r,o[1]);return e.keyhex=a.substr(2),e},"undefined"!=typeof KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"},this.getDigestInfoHex=function(t,e){if("undefined"==typeof this.DIGESTINFOHEAD[e])throw"alg not supported in Util.DIGESTINFOHEAD: "+e;return this.DIGESTINFOHEAD[e]+t},this.getPaddedDigestInfoHex=function(t,e,r){var n=this.getDigestInfoHex(t,e),i=r/4;if(n.length+22>i)throw"key is too short for SigAlg: keylen="+r+","+e;for(var o="0001",s="00"+n,a="",l=i-o.length-s.length,u=0;l>u;u+=2)a+="ff";var c=o+a+s;return c},this.hashString=function(t,e){var r=new KJUR.crypto.MessageDigest({alg:e});return r.digestString(t)},this.hashHex=function(t,e){var r=new KJUR.crypto.MessageDigest({alg:e});return r.digestHex(t)},this.sha1=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha1",prov:"cryptojs"});return e.digestString(t)},this.sha256=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});return e.digestString(t)},this.sha256Hex=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});return e.digestHex(t)},this.sha512=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"});return e.digestString(t)},this.sha512Hex=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"});return e.digestHex(t)},this.md5=function(t){var e=new KJUR.crypto.MessageDigest({alg:"md5",prov:"cryptojs"});return e.digestString(t)},this.ripemd160=function(t){var e=new KJUR.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"});return e.digestString(t)},this.getCryptoJSMDByName=function(){}},KJUR.crypto.MessageDigest=function(params){var md=null,algName=null,provName=null;this.setAlgAndProvider=function(alg,prov){if(null!=alg&&void 0===prov&&(prov=KJUR.crypto.Util.DEFAULTPROVIDER[alg]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(alg)&&"cryptojs"==prov){try{this.md=eval(KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[alg]).create()}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+alg+"/"+ex}this.updateString=function(t){this.md.update(t)},this.updateHex=function(t){var e=CryptoJS.enc.Hex.parse(t);this.md.update(e)},this.digest=function(){var t=this.md.finalize();return t.toString(CryptoJS.enc.Hex)},this.digestString=function(t){return this.updateString(t),this.digest()},this.digestHex=function(t){return this.updateHex(t),this.digest()}}if(-1!=":sha256:".indexOf(alg)&&"sjcl"==prov){try{this.md=new sjcl.hash.sha256}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+alg+"/"+ex}this.updateString=function(t){this.md.update(t)},this.updateHex=function(t){var e=sjcl.codec.hex.toBits(t);this.md.update(e)},this.digest=function(){var t=this.md.finalize();return sjcl.codec.hex.fromBits(t)},this.digestString=function(t){return this.updateString(t),this.digest()},this.digestHex=function(t){return this.updateHex(t),this.digest()}}},this.updateString=function(){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==params&&void 0!==params.alg&&(this.algName=params.alg,void 0===params.prov&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},KJUR.crypto.Mac=function(params){var mac=null,pass=null,algName=null,provName=null,algProv=null;this.setAlgAndProvider=function(alg,prov){if(null==alg&&(alg="hmacsha1"),alg=alg.toLowerCase(),"hmac"!=alg.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+alg;void 0===prov&&(prov=KJUR.crypto.Util.DEFAULTPROVIDER[alg]),this.algProv=alg+"/"+prov;var hashAlg=alg.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(hashAlg)&&"cryptojs"==prov){try{var mdObj=eval(KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[hashAlg]);this.mac=CryptoJS.algo.HMAC.create(mdObj,this.pass)}catch(ex){throw"setAlgAndProvider hash alg set fail hashAlg="+hashAlg+"/"+ex}this.updateString=function(t){this.mac.update(t)},this.updateHex=function(t){var e=CryptoJS.enc.Hex.parse(t);this.mac.update(e)},this.doFinal=function(){var t=this.mac.finalize();return t.toString(CryptoJS.enc.Hex)},this.doFinalString=function(t){return this.updateString(t),this.doFinal()},this.doFinalHex=function(t){return this.updateHex(t),this.doFinal()}}},this.updateString=function(){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},void 0!==params&&(void 0!==params.pass&&(this.pass=params.pass),void 0!==params.alg&&(this.algName=params.alg,void 0===params.prov&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},KJUR.crypto.Signature=function(t){var e=null;if(this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())},this._zeroPaddingOfSignature=function(t,e){for(var r="",n=e/4-t.length,i=0;n>i;i++)r+="0";return r+t},this.setAlgAndProvider=function(t,e){if(this._setAlgNames(),"cryptojs/jsrsa"!=e)throw"provider not supported: "+e;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new KJUR.crypto.MessageDigest({alg:this.mdAlgName})}catch(r){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+r}this.init=function(t,e){var r=null;try{r=void 0===e?KEYUTIL.getKey(t):KEYUTIL.getKey(t,e)}catch(n){throw"init failed:"+n}if(r.isPrivate===!0)this.prvKey=r,this.state="SIGN";else{if(r.isPublic!==!0)throw"init failed.:"+r;this.pubKey=r,this.state="VERIFY"}},this.initSign=function(t){"string"==typeof t.ecprvhex&&"string"==typeof t.eccurvename?(this.ecprvhex=t.ecprvhex,this.eccurvename=t.eccurvename):this.prvKey=t,this.state="SIGN"},this.initVerifyByPublicKey=function(t){"string"==typeof t.ecpubhex&&"string"==typeof t.eccurvename?(this.ecpubhex=t.ecpubhex,this.eccurvename=t.eccurvename):t instanceof KJUR.crypto.ECDSA?this.pubKey=t:t instanceof RSAKey&&(this.pubKey=t),this.state="VERIFY"},this.initVerifyByCertificatePEM=function(t){var e=new X509;e.readCertPEM(t),this.pubKey=e.subjectPublicKeyRSA,this.state="VERIFY"},this.updateString=function(t){this.md.updateString(t)},this.updateHex=function(t){this.md.updateHex(t)},this.sign=function(){if(this.sHashHex=this.md.digest(),"undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename){var t=new KJUR.crypto.ECDSA({curve:this.eccurvename});this.hSign=t.signHex(this.sHashHex,this.ecprvhex)}else if("rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if("rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof KJUR.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof KJUR.crypto.DSA))throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(t){this.updateString(t),this.sign()},this.signHex=function(t){this.updateHex(t),this.sign()},this.verify=function(t){if(this.sHashHex=this.md.digest(),"undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename){var e=new KJUR.crypto.ECDSA({curve:this.eccurvename});return e.verifyHex(this.sHashHex,t,this.ecpubhex)}if("rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,t,this.mdAlgName,this.pssSaltLen);if("rsa"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);if(this.pubKey instanceof KJUR.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);if(this.pubKey instanceof KJUR.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.initVerifyByPublicKey=function(){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName},this.initVerifyByCertificatePEM=function(){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+this.algProvName},this.initSign=function(){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName},this.updateString=function(){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=t,void 0!==t&&(void 0!==t.alg&&(this.algName=t.alg,this.provName=void 0===t.prov?KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]:t.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==t.psssaltlen&&(this.pssSaltLen=t.psssaltlen),void 0!==t.prvkeypem)){if(void 0!==t.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{var e=new RSAKey;e.readPrivateKeyFromPEMString(t.prvkeypem),this.initSign(e)}catch(r){throw"fatal error to load pem private key: "+r}}},KJUR.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},function(){function t(e,r,n){if(e===r)return 0!==e||1/e==1/r;if(null==e||null==r)return e===r;if(e._chain&&(e=e._wrapped),r._chain&&(r=r._wrapped),e.isEqual&&S.isFunction(e.isEqual))return e.isEqual(r);if(r.isEqual&&S.isFunction(r.isEqual))return r.isEqual(e);var i=u.call(e);if(i!=u.call(r))return!1;switch(i){case"[object String]":return e==String(r);case"[object Number]":return e!=+e?r!=+r:0==e?1/e==1/r:e==+r;case"[object Date]":case"[object Boolean]":return+e==+r;case"[object RegExp]":return e.source==r.source&&e.global==r.global&&e.multiline==r.multiline&&e.ignoreCase==r.ignoreCase}if("object"!=typeof e||"object"!=typeof r)return!1;for(var o=n.length;o--;)if(n[o]==e)return!0;n.push(e);var s=0,a=!0;if("[object Array]"==i){if(s=e.length,a=s==r.length)for(;s--&&(a=s in e==s in r&&t(e[s],r[s],n)););}else{if("constructor"in e!="constructor"in r||e.constructor!=r.constructor)return!1;for(var l in e)if(S.has(e,l)&&(s++,!(a=S.has(r,l)&&t(e[l],r[l],n))))break;if(a){for(l in r)if(S.has(r,l)&&!s--)break;a=!s}}return n.pop(),a}var e=this,r=e._,n={},i=Array.prototype,o=Object.prototype,s=Function.prototype,a=i.slice,l=i.unshift,u=o.toString,c=o.hasOwnProperty,p=i.forEach,h=i.map,d=i.reduce,f=i.reduceRight,g=i.filter,m=i.every,v=i.some,y=i.indexOf,b=i.lastIndexOf,w=Array.isArray,x=Object.keys,_=s.bind,S=function(t){return new L(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=S),exports._=S):e._=S,S.VERSION="1.3.1";var E=S.each=S.forEach=function(t,e,r){if(null!=t)if(p&&t.forEach===p)t.forEach(e,r);else if(t.length===+t.length){for(var i=0,o=t.length;o>i;i++)if(i in t&&e.call(r,t[i],i,t)===n)return}else for(var s in t)if(S.has(t,s)&&e.call(r,t[s],s,t)===n)return};S.map=S.collect=function(t,e,r){var n=[];return null==t?n:h&&t.map===h?t.map(e,r):(E(t,function(t,i,o){n[n.length]=e.call(r,t,i,o)
}),t.length===+t.length&&(n.length=t.length),n)},S.reduce=S.foldl=S.inject=function(t,e,r,n){var i=arguments.length>2;if(null==t&&(t=[]),d&&t.reduce===d)return n&&(e=S.bind(e,n)),i?t.reduce(e,r):t.reduce(e);if(E(t,function(t,o,s){i?r=e.call(n,r,t,o,s):(r=t,i=!0)}),!i)throw new TypeError("Reduce of empty array with no initial value");return r},S.reduceRight=S.foldr=function(t,e,r,n){var i=arguments.length>2;if(null==t&&(t=[]),f&&t.reduceRight===f)return n&&(e=S.bind(e,n)),i?t.reduceRight(e,r):t.reduceRight(e);var o=S.toArray(t).reverse();return n&&!i&&(e=S.bind(e,n)),i?S.reduce(o,e,r,n):S.reduce(o,e)},S.find=S.detect=function(t,e,r){var n;return T(t,function(t,i,o){return e.call(r,t,i,o)?(n=t,!0):void 0}),n},S.filter=S.select=function(t,e,r){var n=[];return null==t?n:g&&t.filter===g?t.filter(e,r):(E(t,function(t,i,o){e.call(r,t,i,o)&&(n[n.length]=t)}),n)},S.reject=function(t,e,r){var n=[];return null==t?n:(E(t,function(t,i,o){e.call(r,t,i,o)||(n[n.length]=t)}),n)},S.every=S.all=function(t,e,r){var i=!0;return null==t?i:m&&t.every===m?t.every(e,r):(E(t,function(t,o,s){return(i=i&&e.call(r,t,o,s))?void 0:n}),i)};var T=S.some=S.any=function(t,e,r){e||(e=S.identity);var i=!1;return null==t?i:v&&t.some===v?t.some(e,r):(E(t,function(t,o,s){return i||(i=e.call(r,t,o,s))?n:void 0}),!!i)};S.include=S.contains=function(t,e){var r=!1;return null==t?r:y&&t.indexOf===y?-1!=t.indexOf(e):r=T(t,function(t){return t===e})},S.invoke=function(t,e){var r=a.call(arguments,2);return S.map(t,function(t){return(S.isFunction(e)?e||t:t[e]).apply(t,r)})},S.pluck=function(t,e){return S.map(t,function(t){return t[e]})},S.max=function(t,e,r){if(!e&&S.isArray(t))return Math.max.apply(Math,t);if(!e&&S.isEmpty(t))return-1/0;var n={computed:-1/0};return E(t,function(t,i,o){var s=e?e.call(r,t,i,o):t;s>=n.computed&&(n={value:t,computed:s})}),n.value},S.min=function(t,e,r){if(!e&&S.isArray(t))return Math.min.apply(Math,t);if(!e&&S.isEmpty(t))return 1/0;var n={computed:1/0};return E(t,function(t,i,o){var s=e?e.call(r,t,i,o):t;s<n.computed&&(n={value:t,computed:s})}),n.value},S.shuffle=function(t){var e,r=[];return E(t,function(t,n){0==n?r[0]=t:(e=Math.floor(Math.random()*(n+1)),r[n]=r[e],r[e]=t)}),r},S.sortBy=function(t,e,r){return S.pluck(S.map(t,function(t,n,i){return{value:t,criteria:e.call(r,t,n,i)}}).sort(function(t,e){var r=t.criteria,n=e.criteria;return n>r?-1:r>n?1:0}),"value")},S.groupBy=function(t,e){var r={},n=S.isFunction(e)?e:function(t){return t[e]};return E(t,function(t,e){var i=n(t,e);(r[i]||(r[i]=[])).push(t)}),r},S.sortedIndex=function(t,e,r){r||(r=S.identity);for(var n=0,i=t.length;i>n;){var o=n+i>>1;r(t[o])<r(e)?n=o+1:i=o}return n},S.toArray=function(t){return t?t.toArray?t.toArray():S.isArray(t)?a.call(t):S.isArguments(t)?a.call(t):S.values(t):[]},S.size=function(t){return S.toArray(t).length},S.first=S.head=function(t,e,r){return null==e||r?t[0]:a.call(t,0,e)},S.initial=function(t,e,r){return a.call(t,0,t.length-(null==e||r?1:e))},S.last=function(t,e,r){return null==e||r?t[t.length-1]:a.call(t,Math.max(t.length-e,0))},S.rest=S.tail=function(t,e,r){return a.call(t,null==e||r?1:e)},S.compact=function(t){return S.filter(t,function(t){return!!t})},S.flatten=function(t,e){return S.reduce(t,function(t,r){return S.isArray(r)?t.concat(e?r:S.flatten(r)):(t[t.length]=r,t)},[])},S.without=function(t){return S.difference(t,a.call(arguments,1))},S.uniq=S.unique=function(t,e,r){var n=r?S.map(t,r):t,i=[];return S.reduce(n,function(r,n,o){return 0!=o&&(e===!0?S.last(r)==n:S.include(r,n))||(r[r.length]=n,i[i.length]=t[o]),r},[]),i},S.union=function(){return S.uniq(S.flatten(arguments,!0))},S.intersection=S.intersect=function(t){var e=a.call(arguments,1);return S.filter(S.uniq(t),function(t){return S.every(e,function(e){return S.indexOf(e,t)>=0})})},S.difference=function(t){var e=S.flatten(a.call(arguments,1));return S.filter(t,function(t){return!S.include(e,t)})},S.zip=function(){for(var t=a.call(arguments),e=S.max(S.pluck(t,"length")),r=new Array(e),n=0;e>n;n++)r[n]=S.pluck(t,""+n);return r},S.indexOf=function(t,e,r){if(null==t)return-1;var n,i;if(r)return n=S.sortedIndex(t,e),t[n]===e?n:-1;if(y&&t.indexOf===y)return t.indexOf(e);for(n=0,i=t.length;i>n;n++)if(n in t&&t[n]===e)return n;return-1},S.lastIndexOf=function(t,e){if(null==t)return-1;if(b&&t.lastIndexOf===b)return t.lastIndexOf(e);for(var r=t.length;r--;)if(r in t&&t[r]===e)return r;return-1},S.range=function(t,e,r){arguments.length<=1&&(e=t||0,t=0),r=arguments[2]||1;for(var n=Math.max(Math.ceil((e-t)/r),0),i=0,o=new Array(n);n>i;)o[i++]=t,t+=r;return o};var A=function(){};S.bind=function(t,e){if(t){var r,n;if(t.bind===_&&_)return _.apply(t,a.call(arguments,1));if(!S.isFunction(t))throw new TypeError;return n=a.call(arguments,2),r=function(){if(!(this instanceof r))return t.apply(e,n.concat(a.call(arguments)));A.prototype=t.prototype;var i=new A,o=t.apply(i,n.concat(a.call(arguments)));return Object(o)===o?o:i}}},S.bindAll=function(t){var e=a.call(arguments,1);return 0==e.length&&(e=S.functions(t)),E(e,function(e){t[e]=S.bind(t[e],t)}),t},S.memoize=function(t,e){var r={};return e||(e=S.identity),function(){var n=e.apply(this,arguments);return S.has(r,n)?r[n]:r[n]=t.apply(this,arguments)}},S.delay=function(t,e){var r=a.call(arguments,2);return setTimeout(function(){return t.apply(t,r)},e)},S.defer=function(t){return S.delay.apply(S,[t,1].concat(a.call(arguments,1)))},S.throttle=function(t,e){var r,n,i,o,s,a=S.debounce(function(){s=o=!1},e);return function(){r=this,n=arguments;var l=function(){i=null,s&&t.apply(r,n),a()};i||(i=setTimeout(l,e)),o?s=!0:t.apply(r,n),a(),o=!0}},S.debounce=function(t,e){var r;return function(){var n=this,i=arguments,o=function(){r=null,t.apply(n,i)};clearTimeout(r),r=setTimeout(o,e)}},S.once=function(t){var e,r=!1;return function(){return r?e:(r=!0,e=t.apply(this,arguments))}},S.wrap=function(t,e){return function(){var r=[t].concat(a.call(arguments,0));return e.apply(this,r)}},S.compose=function(){var t=arguments;return function(){for(var e=arguments,r=t.length-1;r>=0;r--)e=[t[r].apply(this,e)];return e[0]}},S.after=function(t,e){return 0>=t?e():function(){return--t<1?e.apply(this,arguments):void 0}},S.keys=x||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var r in t)S.has(t,r)&&(e[e.length]=r);return e},S.values=function(t){return S.map(t,S.identity)},S.functions=S.methods=function(t){var e=[];for(var r in t)S.isFunction(t[r])&&e.push(r);return e.sort()},S.extend=function(t){return E(a.call(arguments,1),function(e){for(var r in e)t[r]=e[r]}),t},S.defaults=function(t){return E(a.call(arguments,1),function(e){for(var r in e)null==t[r]&&(t[r]=e[r])}),t},S.clone=function(t){return S.isObject(t)?S.isArray(t)?t.slice():S.extend({},t):t},S.tap=function(t,e){return e(t),t},S.isEqual=function(e,r){return t(e,r,[])},S.isEmpty=function(t){if(S.isArray(t)||S.isString(t))return 0===t.length;for(var e in t)if(S.has(t,e))return!1;return!0},S.isElement=function(t){return!(!t||1!=t.nodeType)},S.isArray=w||function(t){return"[object Array]"==u.call(t)},S.isObject=function(t){return t===Object(t)},S.isArguments=function(t){return"[object Arguments]"==u.call(t)},S.isArguments(arguments)||(S.isArguments=function(t){return!(!t||!S.has(t,"callee"))}),S.isFunction=function(t){return"[object Function]"==u.call(t)},S.isString=function(t){return"[object String]"==u.call(t)},S.isNumber=function(t){return"[object Number]"==u.call(t)},S.isFinite=function(t){return S.isNumber(t)&&isFinite(t)},S.isNaN=function(t){return t!==t},S.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==u.call(t)},S.isDate=function(t){return"[object Date]"==u.call(t)},S.isRegExp=function(t){return"[object RegExp]"==u.call(t)},S.isNull=function(t){return null===t},S.isUndefined=function(t){return void 0===t},S.has=function(t,e){return c.call(t,e)},S.noConflict=function(){return e._=r,this},S.identity=function(t){return t},S.times=function(t,e,r){for(var n=0;t>n;n++)e.call(r,n)},S.escape=function(t){return(""+t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},S.mixin=function(t){E(S.functions(t),function(e){k(e,S[e]=t[e])})};var C=0;S.uniqueId=function(t){var e=C++;return t?t+e:e},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var P=/.^/,R=function(t){return t.replace(/\\\\/g,"\\").replace(/\\'/g,"'")};S.template=function(t,e){var r=S.templateSettings,n="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(r.escape||P,function(t,e){return"',_.escape("+R(e)+"),'"}).replace(r.interpolate||P,function(t,e){return"',"+R(e)+",'"}).replace(r.evaluate||P,function(t,e){return"');"+R(e).replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",i=new Function("obj","_",n);return e?i(e,S):function(t){return i.call(this,t,S)}},S.chain=function(t){return S(t).chain()};var L=function(t){this._wrapped=t};S.prototype=L.prototype;var M=function(t,e){return e?S(t).chain():t},k=function(t,e){L.prototype[t]=function(){var t=a.call(arguments);return l.call(t,this._wrapped),M(e.apply(S,t),this._chain)}};S.mixin(S),E(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=i[t];L.prototype[t]=function(){var r=this._wrapped;e.apply(r,arguments);var n=r.length;return"shift"!=t&&"splice"!=t||0!==n||delete r[0],M(r,this._chain)}}),E(["concat","join","slice"],function(t){var e=i[t];L.prototype[t]=function(){return M(e.apply(this._wrapped,arguments),this._chain)}}),L.prototype.chain=function(){return this._chain=!0,this},L.prototype.value=function(){return this._wrapped}}.call(this),function(t){function e(e,r){throw t.extend(e,r),e}function r(t){var e=[];if(d.call(t)!==a)return!1;for(var r=0,n=t.length;n>r;r++)e[r]=t[r].jqote_id;return e.length?e.sort().join(".").replace(/(\b\d+\b)\.(?:\1(\.|$))+/g,"$1$2"):!1}function n(e,r){var i,o=[],r=r||p,s=d.call(e);if(s===u)return e.jqote_id?[e]:!1;if(s!==a)return[t.jqotec(e,r)];if(s===a)for(var l=0,c=e.length;c>l;l++)(i=n(e[l],r))&&o.push(i[0]);return o.length?o:!1}var i="UndefinedTemplateError",o="TemplateCompilationError",s="TemplateExecutionError",a="[object Array]",l="[object String]",u="[object Function]",c=1,p="%",h=/^[^<]*(<[\w\W]+>)[^>]*$/,d=Object.prototype.toString;t.fn.extend({jqote:function(e,r){var e=d.call(e)===a?e:[e],n="";return this.each(function(i){for(var o=t.jqotec(this,r),s=0;s<e.length;s++)n+=o.call(e[s],i,s,e,o)}),n}}),t.each({app:"append",pre:"prepend",sub:"html"},function(e,i){t.fn["jqote"+e]=function(o,s,a){var l,u,c=t.jqote(o,s,a),p=h.test(c)?t:function(e){return t(document.createTextNode(e))};return(l=r(n(o)))&&(u=new RegExp("(^|\\.)"+l.split(".").join("\\.(.*)?")+"(\\.|$)")),this.each(function(){var r=p(c);t(this)[i](r),(3===r[0].nodeType?t(this):r).trigger("jqote."+e,[r,u])})}}),t.extend({jqote:function(t,r,o){var s="",l=n(t);l===!1&&e(new Error("Empty or undefined template passed to $.jqote "+t),{type:i}),r=d.call(r)!==a?[r]:r;for(var u=0,c=l.length;c>u;u++)for(var p=0;p<r.length;p++)s+=l[u].call(r[p],u,p,r,l[u]);return s},jqotec:function(r,n){var a,u,f,n=n||p,g=d.call(r);if(g===l&&h.test(r)){if(u=f=r,a=t.jqotecache[r])return a}else if(u=g===l||r.nodeType?t(r):r instanceof jQuery?r:null,u[0]&&((f=u[0].innerHTML)||(f=u.text()))||(console.log("Error finding template "+r),e(new Error("Empty or undefined template passed to $.jqotec"),{type:i})),a=t.jqotecache[t.data(u[0],"jqote_id")])return a;for(var m,v="",y=f.replace(/\s*<!\[CDATA\[\s*|\s*\]\]>\s*|[\r\n\t]/g,"").split("<"+n).join(n+">").split(n+">"),b=0,w=y.length;w>b;b++)v+=""!==y[b].charAt(0)?"out+='"+y[b].replace(/(\\|["'])/g,"\\$1")+"'":"="===y[b].charAt(1)?";out+=("+y[b].substr(2)+");":"!"===y[b].charAt(1)?";out+=$.jqotenc(("+y[b].substr(2)+"));":";"+y[b].substr(1);v="try{"+('var out="";'+v+";return out;").split("out+='';").join("").split('var out="";out+=').join("var out=")+'}catch(e){e.type="'+s+'";e.args=arguments;e.template=arguments.callee.toString();throw e;}';try{var x=new Function("i, j, data, fn",v)}catch(_){e(_,{type:o})}return m=u instanceof jQuery?t.data(u[0],"jqote_id",c):u,t.jqotecache[m]=(x.jqote_id=c++,x)},jqotefn:function(e){var r=d.call(e),n=r===l&&h.test(e)?e:t.data(t(e)[0],"jqote_id");return t.jqotecache[n]||!1},jqotetag:function(t){d.call(t)===l&&(p=t)},jqotenc:function(t){return t.toString().replace(/&(?!\w+;)/g,"&#38;").split("<").join("&#60;").split(">").join("&#62;").split('"').join("&#34;").split("'").join("&#39;")},jqotecache:{}}),t.event.special.jqote={add:function(t){var e,i=t.handler,o=t.data?d.call(t.data)!==a?[t.data]:t.data:[];t.namespace||(t.namespace="app.pre.sub"),o.length&&(e=r(n(o)))&&(t.handler=function(t,r,n){return!n||n.test(e)?i.apply(this,[t,r]):null})}}}(jQuery),$(function(){$.jqotetag("$")}),function(){var t,e=[].slice;t=function(){var t,r,n,i,o,s;return i=1<=arguments.length?e.call(arguments,0):[],o=/(^|[\s\n]|<br\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,i.length>0?(n=i[0],r=function(){var e;e=[];for(t in n)s=n[t],"callback"!==t&&e.push(" "+t+"='"+s+"'");return e}().join(""),this.replace(o,function(t,e,i){var o;return o=("function"==typeof n.callback?n.callback(i):void 0)||"<a href='"+i+"'"+r+">"+i+"</a>",""+e+o})):this.replace(o,"$1<a href='$2'>$2</a>")},String.prototype.autoLink=t}.call(this);var CSS_PROP_BIT_QUANTITY=1,CSS_PROP_BIT_HASH_VALUE=2,CSS_PROP_BIT_NEGATIVE_QUANTITY=4,CSS_PROP_BIT_QSTRING_CONTENT=8,CSS_PROP_BIT_QSTRING_URL=16,CSS_PROP_BIT_HISTORY_INSENSITIVE=32,CSS_PROP_BIT_Z_INDEX=64,CSS_PROP_BIT_ALLOWED_IN_LINK=128,cssSchema=function(){var t=["rgb(?:\\(\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)|a\\(\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0(?:\\.\\d+)?|\\.\\d+|1(?:\\.0+)?|0|\\d+(?:\\.\\d+)?%)) *\\)"],e=[/^ *$/i,RegExp("^ *\\s*"+t[0]+" *$","i"),RegExp("^ *(?:\\s*"+t[0]+"|(?:\\s*"+t[0]+")?)+ *$","i")],r=[["aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","gray","green","greenyellow","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgreen","lightgrey","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategray","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen"],["all-scroll","col-resize","crosshair","default","e-resize","hand","help","move","n-resize","ne-resize","no-drop","not-allowed","nw-resize","pointer","progress","row-resize","s-resize","se-resize","sw-resize","text","vertical-text","w-resize","wait"],["-moz-inline-box","-moz-inline-stack","block","inline","inline-block","inline-table","list-item","run-in","table","table-caption","table-cell","table-column","table-column-group","table-footer-group","table-header-group","table-row","table-row-group"],["armenian","circle","decimal","decimal-leading-zero","disc","georgian","lower-alpha","lower-greek","lower-latin","lower-roman","square","upper-alpha","upper-latin","upper-roman"],["100","200","300","400","500","600","700","800","900","bold","bolder","lighter"],["condensed","expanded","extra-condensed","extra-expanded","narrower","semi-condensed","semi-expanded","ultra-condensed","ultra-expanded","wider"],["behind","center-left","center-right","far-left","far-right","left-side","leftwards","right-side","rightwards"],["large","larger","small","smaller","x-large","x-small","xx-large","xx-small"],["-moz-pre-wrap","-o-pre-wrap","-pre-wrap","nowrap","pre","pre-line","pre-wrap"],["dashed","dotted","double","groove","outset","ridge","solid"],["baseline","middle","sub","super","text-bottom","text-top"],["caption","icon","menu","message-box","small-caption","status-bar"],["fast","faster","slow","slower","x-fast","x-slow"],["above","below","higher","level","lower"],["border-box","contain","content-box","cover","padding-box"],["cursive","fantasy","monospace","sans-serif","serif"],["loud","silent","soft","x-loud","x-soft"],["no-repeat","repeat-x","repeat-y","round","space"],["blink","line-through","overline","underline"],["high","low","x-high","x-low"],["absolute","relative","static"],["capitalize","lowercase","uppercase"],["child","female","male"],["bidi-override","embed"],["bottom","top"],["clip","ellipsis"],["continuous","digits"],["hide","show"],["inside","outside"],["italic","oblique"],["left","right"],["ltr","rtl"],["no-content","no-display"],["suppress","unrestricted"],["thick","thin"],[","],["/"],["always"],["auto"],["avoid"],["both"],["break-word"],["center"],["code"],["collapse"],["fixed"],["hidden"],["inherit"],["inset"],["invert"],["justify"],["local"],["medium"],["mix"],["none"],["normal"],["once"],["repeat"],["scroll"],["separate"],["small-caps"],["spell-out"],["transparent"],["visible"]];return{"-moz-border-radius":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[r[36]]},"-moz-border-radius-bottomleft":{cssExtra:e[0],cssPropBits:5},"-moz-border-radius-bottomright":{cssExtra:e[0],cssPropBits:5},"-moz-border-radius-topleft":{cssExtra:e[0],cssPropBits:5},"-moz-border-radius-topright":{cssExtra:e[0],cssPropBits:5},"-moz-box-shadow":{cssExtra:e[2],cssAlternates:["boxShadow"],cssPropBits:7,cssLitGroup:[r[0],r[35],r[48],r[54]]},"-moz-opacity":{cssPropBits:1,cssLitGroup:[r[47]]},"-moz-outline":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[r[0],r[9],r[34],r[46],r[47],r[48],r[49],r[52],r[54]]},"-moz-outline-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[r[0],r[47],r[49]]},"-moz-outline-style":{cssPropBits:0,cssLitGroup:[r[9],r[46],r[47],r[48],r[54]]},"-moz-outline-width":{cssPropBits:5,cssLitGroup:[r[34],r[47],r[52]]},"-o-text-overflow":{cssPropBits:0,cssLitGroup:[r[25]]},"-webkit-border-bottom-left-radius":{cssExtra:e[0],cssPropBits:5},"-webkit-border-bottom-right-radius":{cssExtra:e[0],cssPropBits:5},"-webkit-border-radius":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[r[36]]},"-webkit-border-radius-bottom-left":{cssExtra:e[0],cssPropBits:5},"-webkit-border-radius-bottom-right":{cssExtra:e[0],cssPropBits:5},"-webkit-border-radius-top-left":{cssExtra:e[0],cssPropBits:5},"-webkit-border-radius-top-right":{cssExtra:e[0],cssPropBits:5},"-webkit-border-top-left-radius":{cssExtra:e[0],cssPropBits:5},"-webkit-border-top-right-radius":{cssExtra:e[0],cssPropBits:5},"-webkit-box-shadow":{cssExtra:e[2],cssAlternates:["boxShadow"],cssPropBits:7,cssLitGroup:[r[0],r[35],r[48],r[54]]},azimuth:{cssPropBits:5,cssLitGroup:[r[6],r[30],r[42],r[47]]},background:{cssExtra:RegExp("^ *(?:\\s*"+t[0]+"){0,2} *$","i"),cssPropBits:23,cssLitGroup:[r[0],r[14],r[17],r[24],r[30],r[35],r[36],r[38],r[42],r[45],r[47],r[51],r[54],r[57],r[58],r[62]]},"background-size":{cssExtra:RegExp("^ *(?:\\s*"+t[0]+"){0,2} *$","i"),cssPropBits:23,cssLitGroup:[r[0],r[14],r[17],r[24],r[30],r[35],r[36],r[38],r[42],r[45],r[47],r[51],r[54],r[57],r[58],r[62]]},"background-attachment":{cssExtra:e[0],cssPropBits:0,cssLitGroup:[r[35],r[45],r[51],r[58]]},"background-color":{cssExtra:e[1],cssPropBits:130,cssLitGroup:[r[0],r[47],r[62]]},"background-image":{cssExtra:RegExp(".*","i"),cssPropBits:16,cssLitGroup:[r[35],r[54]]},"background-position":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[r[24],r[30],r[35],r[42]]},"background-repeat":{cssExtra:e[0],cssPropBits:0,cssLitGroup:[r[17],r[35],r[57]]},border:{cssExtra:e[1],cssPropBits:7,cssLitGroup:[r[0],r[9],r[34],r[46],r[47],r[48],r[52],r[54],r[62]]},"border-bottom":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[r[0],r[9],r[34],r[46],r[47],r[48],r[52],r[54],r[62]]},"border-bottom-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[r[0],r[47],r[62]]},"border-bottom-left-radius":{cssExtra:e[0],cssPropBits:5},"border-bottom-right-radius":{cssExtra:e[0],cssPropBits:5},"border-bottom-style":{cssPropBits:0,cssLitGroup:[r[9],r[46],r[47],r[48],r[54]]},"border-bottom-width":{cssPropBits:5,cssLitGroup:[r[34],r[47],r[52]]},"border-collapse":{cssPropBits:0,cssLitGroup:[r[44],r[47],r[59]]},"border-color":{cssExtra:RegExp("^ *(?:\\s*"+t[0]+"){1,4} *$","i"),cssPropBits:2,cssLitGroup:[r[0],r[47],r[62]]},"border-left":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[r[0],r[9],r[34],r[46],r[47],r[48],r[52],r[54],r[62]]},"border-left-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[r[0],r[47],r[62]]},"border-left-style":{cssPropBits:0,cssLitGroup:[r[9],r[46],r[47],r[48],r[54]]},"border-left-width":{cssPropBits:5,cssLitGroup:[r[34],r[47],r[52]]},"border-radius":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[r[36]]},"border-right":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[r[0],r[9],r[34],r[46],r[47],r[48],r[52],r[54],r[62]]},"border-right-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[r[0],r[47],r[62]]},"border-right-style":{cssPropBits:0,cssLitGroup:[r[9],r[46],r[47],r[48],r[54]]},"border-right-width":{cssPropBits:5,cssLitGroup:[r[34],r[47],r[52]]},"border-spacing":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[r[47]]},"border-style":{cssPropBits:0,cssLitGroup:[r[9],r[46],r[47],r[48],r[54]]},"border-top":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[r[0],r[9],r[34],r[46],r[47],r[48],r[52],r[54],r[62]]},"border-top-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[r[0],r[47],r[62]]},"border-top-left-radius":{cssExtra:e[0],cssPropBits:5},"border-top-right-radius":{cssExtra:e[0],cssPropBits:5},"border-top-style":{cssPropBits:0,cssLitGroup:[r[9],r[46],r[47],r[48],r[54]]},"border-top-width":{cssPropBits:5,cssLitGroup:[r[34],r[47],r[52]]},"border-width":{cssPropBits:5,cssLitGroup:[r[34],r[47],r[52]]},bottom:{cssPropBits:5,cssLitGroup:[r[38],r[47]]},"box-shadow":{cssExtra:e[2],cssPropBits:7,cssLitGroup:[r[0],r[35],r[48],r[54]]},"caption-side":{cssPropBits:0,cssLitGroup:[r[24],r[47]]},clear:{cssPropBits:0,cssLitGroup:[r[30],r[40],r[47],r[54]]},clip:{cssExtra:/^ *\s*rect\(\s*(?:0|[+\-]?\d+(?:\.\d+)?(?:[cem]m|ex|in|p[ctx])|auto)\s*,\s*(?:0|[+\-]?\d+(?:\.\d+)?(?:[cem]m|ex|in|p[ctx])|auto)\s*,\s*(?:0|[+\-]?\d+(?:\.\d+)?(?:[cem]m|ex|in|p[ctx])|auto)\s*,\s*(?:0|[+\-]?\d+(?:\.\d+)?(?:[cem]m|ex|in|p[ctx])|auto) *\) *$/i,cssPropBits:0,cssLitGroup:[r[38],r[47]]},color:{cssExtra:e[1],cssPropBits:130,cssLitGroup:[r[0],r[47]]},content:{cssPropBits:8,cssLitGroup:[r[54],r[55]]},"counter-increment":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[r[47],r[54]]},"counter-reset":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[r[47],r[54]]},cue:{cssPropBits:16,cssLitGroup:[r[47],r[54]]},"cue-after":{cssPropBits:16,cssLitGroup:[r[47],r[54]]},"cue-before":{cssPropBits:16,cssLitGroup:[r[47],r[54]]},cursor:{cssExtra:e[0],cssPropBits:144,cssLitGroup:[r[1],r[35],r[38],r[47]]},direction:{cssPropBits:0,cssLitGroup:[r[31],r[47]]},display:{cssPropBits:32,cssLitGroup:[r[2],r[47],r[54]]},elevation:{cssPropBits:5,cssLitGroup:[r[13],r[47]]},"empty-cells":{cssPropBits:0,cssLitGroup:[r[27],r[47]]},filter:{cssExtra:/^ *(?:\s*alpha\(\s*opacity\s*=\s*(?:0|\d+(?:\.\d+)?%|[+\-]?\d+(?:\.\d+)?) *\))+ *$/i,cssPropBits:32},"float":{cssAlternates:["cssFloat","styleFloat"],cssPropBits:32,cssLitGroup:[r[30],r[47],r[54]]},font:{cssExtra:e[0],cssPropBits:9,cssLitGroup:[r[4],r[7],r[11],r[15],r[29],r[35],r[36],r[47],r[52],r[55],r[60]]},"font-family":{cssExtra:e[0],cssPropBits:8,cssLitGroup:[r[15],r[35],r[47]]},"font-size":{cssPropBits:1,cssLitGroup:[r[7],r[47],r[52]]},"font-stretch":{cssPropBits:0,cssLitGroup:[r[5],r[55]]},"font-style":{cssPropBits:0,cssLitGroup:[r[29],r[47],r[55]]},"font-variant":{cssPropBits:0,cssLitGroup:[r[47],r[55],r[60]]},"font-weight":{cssPropBits:0,cssLitGroup:[r[4],r[47],r[55]]},height:{cssPropBits:37,cssLitGroup:[r[38],r[47]]},left:{cssPropBits:37,cssLitGroup:[r[38],r[47]]},"letter-spacing":{cssPropBits:5,cssLitGroup:[r[47],r[55]]},"line-height":{cssPropBits:1,cssLitGroup:[r[47],r[55]]},"list-style":{cssPropBits:16,cssLitGroup:[r[3],r[28],r[47],r[54]]},"list-style-image":{cssPropBits:16,cssLitGroup:[r[47],r[54]]},"list-style-position":{cssPropBits:0,cssLitGroup:[r[28],r[47]]},"list-style-type":{cssPropBits:0,cssLitGroup:[r[3],r[47],r[54]]},margin:{cssPropBits:5,cssLitGroup:[r[38],r[47]]},"margin-bottom":{cssPropBits:5,cssLitGroup:[r[38],r[47]]},"margin-left":{cssPropBits:5,cssLitGroup:[r[38],r[47]]},"margin-right":{cssPropBits:5,cssLitGroup:[r[38],r[47]]},"margin-top":{cssPropBits:5,cssLitGroup:[r[38],r[47]]},"max-height":{cssPropBits:1,cssLitGroup:[r[38],r[47],r[54]]},"max-width":{cssPropBits:1,cssLitGroup:[r[38],r[47],r[54]]},"min-height":{cssPropBits:1,cssLitGroup:[r[38],r[47]]},"min-width":{cssPropBits:1,cssLitGroup:[r[38],r[47]]},opacity:{cssPropBits:33,cssLitGroup:[r[47]]},outline:{cssExtra:e[1],cssPropBits:7,cssLitGroup:[r[0],r[9],r[34],r[46],r[47],r[48],r[49],r[52],r[54]]},"outline-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[r[0],r[47],r[49]]},"outline-style":{cssPropBits:0,cssLitGroup:[r[9],r[46],r[47],r[48],r[54]]},"outline-width":{cssPropBits:5,cssLitGroup:[r[34],r[47],r[52]]},overflow:{cssPropBits:32,cssLitGroup:[r[38],r[46],r[47],r[58],r[63]]},"overflow-x":{cssPropBits:0,cssLitGroup:[r[32],r[38],r[46],r[58],r[63]]},"overflow-y":{cssPropBits:0,cssLitGroup:[r[32],r[38],r[46],r[58],r[63]]},padding:{cssPropBits:1,cssLitGroup:[r[47]]},"padding-bottom":{cssPropBits:33,cssLitGroup:[r[47]]},"padding-left":{cssPropBits:33,cssLitGroup:[r[47]]},"padding-right":{cssPropBits:33,cssLitGroup:[r[47]]},"padding-top":{cssPropBits:33,cssLitGroup:[r[47]]},"page-break-after":{cssPropBits:0,cssLitGroup:[r[30],r[37],r[38],r[39],r[47]]},"page-break-before":{cssPropBits:0,cssLitGroup:[r[30],r[37],r[38],r[39],r[47]]},"page-break-inside":{cssPropBits:0,cssLitGroup:[r[38],r[39],r[47]]},pause:{cssPropBits:5,cssLitGroup:[r[47]]},"pause-after":{cssPropBits:5,cssLitGroup:[r[47]]},"pause-before":{cssPropBits:5,cssLitGroup:[r[47]]},pitch:{cssPropBits:5,cssLitGroup:[r[19],r[47],r[52]]},"pitch-range":{cssPropBits:5,cssLitGroup:[r[47]]},"play-during":{cssExtra:e[0],cssPropBits:16,cssLitGroup:[r[38],r[47],r[53],r[54],r[57]]},position:{cssPropBits:32,cssLitGroup:[r[20],r[47]]},quotes:{cssExtra:e[0],cssPropBits:8,cssLitGroup:[r[47],r[54]]},richness:{cssPropBits:5,cssLitGroup:[r[47]]},right:{cssPropBits:37,cssLitGroup:[r[38],r[47]]},speak:{cssPropBits:0,cssLitGroup:[r[47],r[54],r[55],r[61]]},"speak-header":{cssPropBits:0,cssLitGroup:[r[37],r[47],r[56]]},"speak-numeral":{cssPropBits:0,cssLitGroup:[r[26],r[47]]},"speak-punctuation":{cssPropBits:0,cssLitGroup:[r[43],r[47],r[54]]},"speech-rate":{cssPropBits:5,cssLitGroup:[r[12],r[47],r[52]]},stress:{cssPropBits:5,cssLitGroup:[r[47]]},"table-layout":{cssPropBits:0,cssLitGroup:[r[38],r[45],r[47]]},"text-align":{cssPropBits:0,cssLitGroup:[r[30],r[42],r[47],r[50]]},"text-decoration":{cssPropBits:0,cssLitGroup:[r[18],r[47],r[54]]},"text-indent":{cssPropBits:5,cssLitGroup:[r[47]]},"text-overflow":{cssPropBits:0,cssLitGroup:[r[25]]},"text-shadow":{cssExtra:e[2],cssPropBits:7,cssLitGroup:[r[0],r[35],r[48],r[54]]},"text-transform":{cssPropBits:0,cssLitGroup:[r[21],r[47],r[54]]},"text-wrap":{cssPropBits:0,cssLitGroup:[r[33],r[54],r[55]]},top:{cssPropBits:37,cssLitGroup:[r[38],r[47]]},"unicode-bidi":{cssPropBits:0,cssLitGroup:[r[23],r[47],r[55]]},"vertical-align":{cssPropBits:5,cssLitGroup:[r[10],r[24],r[47]]},visibility:{cssPropBits:32,cssLitGroup:[r[44],r[46],r[47],r[63]]},"voice-family":{cssExtra:e[0],cssPropBits:8,cssLitGroup:[r[22],r[35],r[47]]},volume:{cssPropBits:1,cssLitGroup:[r[16],r[47],r[52]]},"white-space":{cssPropBits:0,cssLitGroup:[r[8],r[47],r[55]]},width:{cssPropBits:33,cssLitGroup:[r[38],r[47]]},"word-spacing":{cssPropBits:5,cssLitGroup:[r[47],r[55]]},"word-wrap":{cssPropBits:0,cssLitGroup:[r[41],r[55]]},"z-index":{cssPropBits:69,cssLitGroup:[r[38],r[47]]},zoom:{cssPropBits:1,cssLitGroup:[r[55]]}}}(),URI,decodeCss,html,html4,html_sanitize,lexCss,parseCssDeclarations,parseCssStylesheet,sanitizeCssProperty,sanitizeCssSelectors,sanitizeStylesheet,sanitizeStylesheetWithExternals;if("undefined"!=typeof window&&(window.cssSchema=cssSchema),function(){function t(t){var e=parseInt(t.substring(1),16);return e>65535?(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e))):e==e?String.fromCharCode(e):t[1]<" "?"":t[1]}function e(t,e){return'"'+t.replace(/[\u0000-\u001f\\\"\x3c\x3e]/g,e)+'"'}function r(t){return z[t]||(z[t]="\\"+t.charCodeAt(0).toString(16)+" ")}function n(t){return q[t]||(q[t]=("">t?"%0":"%")+t.charCodeAt(0).toString(16))}var i,o,s,a,l,u,c,p,h,d,f,g,m,v,y,b,w,x,_,S,E,T,A,C,P,R,L,M,k,B,I,O,H,F,N,D,j,$,G,U,z,q;z={"\\":"\\\\"},q={"\\":"%5c"},G="[\\t\\n\\f ]",$=G+"*",x="[\\n\\f]",O="[\\ud800-\\udbff][\\udc00-\\udfff]",E="[\\u0080-\\ud7ff\\ue000-\\ufffd]|"+O,N="[0-9a-fA-F]{1,6}"+G+"?",H="\\\\"+N,g="(?:"+N+"|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|"+O+")",f="\\\\"+g,j="(?:[\\t\\x21\\x23-\\x26\\x28-\\x5b\\x5d-\\x7e]|"+E+"|"+f+")",k="[^'\"\\n\\f\\\\]|\\\\[\\s\\S]",M="\"(?:'|"+k+')*"|\'(?:"|'+k+")*'",T="[-+]?(?:[0-9]+(?:[.][0-9]+)?|[.][0-9]+)",S="(?:[a-zA-Z_]|"+E+"|"+f+")",_="(?:[a-zA-Z0-9_-]|"+E+"|"+f+")",w=_+"+",y="-?"+S+_+"*",i="@"+y,v="#"+w,A=T,U="(?:@?-?"+S+"|#)"+_+"*",P=T+"%",d=T+y,C=T+"(?:%|"+y+")?",D="url[(]"+$+"(?:"+M+"|"+j+"*)"+$+"[)]",F="U[+][0-9A-F?]{1,6}(?:-[0-9A-F]{1,6})?",a="<!--",s="-->",L=G+"+",c="/(?:[*][^*]*[*]+(?:[^/][^*]*[*]+)*/|/[^\\n\\f]*)",m="(?!url[(])"+y+"[(]",b="~=",h="[|]=",R="[^]=",I="[$]=",B="[*]=",u="[~|^$*]=",l="[^\"'\\\\/]|/(?![/*])",o="\\uFEFF",p=new RegExp([o,F,D,m,U,M,C,a,s,L,c,u,l].join("|"),"gi"),decodeCss=function(e){return e.replace(new RegExp("\\\\(?:"+g+"|"+x+")","g"),t)},lexCss=function(t){var i,o,l,u,c,h,d,f;for(t=""+t,f=t.replace(/\r\n?/g,"\n").match(p)||[],l=0,u=" ",o=0,h=f.length;h>o;++o)d=decodeCss(f[o]),c=d.length,i=d.charCodeAt(0),d=i=='"'.charCodeAt(0)||i=="'".charCodeAt(0)?e(d.substring(1,c-1),r):i=="/".charCodeAt(0)&&c>1||"\\"==d||d==s||d==a||"\ufeff"==d||i<=" ".charCodeAt(0)?" ":/url\(/i.test(d)?"url("+e(d.replace(new RegExp("^url\\("+$+"[\"']?|[\"']?"+$+"\\)$","gi"),""),n)+")":d,(u!=d||" "!=d)&&(f[l++]=u=d);return f.length=l,f}}(),"undefined"!=typeof window&&(window.lexCss=lexCss,window.decodeCss=decodeCss),URI=function(){function t(t){var e=(""+t).match(g);return e?new l(u(e[1]),u(e[2]),u(e[3]),u(e[4]),u(e[5]),u(e[6]),u(e[7])):null}function e(t,e,o,s,a,u,c){var p=new l(n(t,f),n(e,f),r(o),s>0?s.toString():null,n(a,d),null,r(c));return u&&("string"==typeof u?p.setRawQuery(u.replace(/[^?\x26=0-9A-Za-z_\-~.%]/g,i)):p.setAllParameters(u)),p}function r(t){return"string"==typeof t?encodeURIComponent(t):null}function n(t,e){return"string"==typeof t?encodeURI(t).replace(e,i):null}function i(t){var e=t.charCodeAt(0);return"%"+"0123456789ABCDEF".charAt(e>>4&15)+"0123456789ABCDEF".charAt(15&e)}function o(t){return t.replace(/(^|\/)\.(?:\/|$)/g,"$1").replace(/\/{2,}/g,"/")}function s(t){var e,r,n;if(null===t)return null;for(e=o(t),n=h;(r=e.replace(n,"$1"))!=e;e=r);return e}function a(t,e){var r,n,i,o,a=t.clone(),l=e.hasScheme();return l?a.setRawScheme(e.getRawScheme()):l=e.hasCredentials(),l?a.setRawCredentials(e.getRawCredentials()):l=e.hasDomain(),l?a.setRawDomain(e.getRawDomain()):l=e.hasPort(),n=e.getRawPath(),i=s(n),l?(a.setPort(e.getPort()),i=i&&i.replace(c,"")):(l=!!n,l?47!==i.charCodeAt(0)&&(r=s(a.getRawPath()||"").replace(c,""),o=r.lastIndexOf("/")+1,i=s((o?r.substring(0,o):"")+s(n)).replace(c,"")):(i=i&&i.replace(c,""),i!==n&&a.setRawPath(i))),l?a.setRawPath(i):l=e.hasQuery(),l?a.setRawQuery(e.getRawQuery()):l=e.hasFragment(),l&&a.setRawFragment(e.getRawFragment()),a}function l(t,e,r,n,i,o,s){this.scheme_=t,this.credentials_=e,this.domain_=r,this.port_=n,this.path_=i,this.query_=o,this.fragment_=s,this.paramCache_=null
}function u(t){return"string"==typeof t&&t.length>0?t:null}var c,p,h,d,f,g;return p=new RegExp("(/|^)(?:[^./][^/]*|\\.{2,}(?:[^./][^/]*)|\\.{3,}[^/]*)/\\.\\.(?:/|$)"),h=new RegExp(p),c=/^(?:\.\.\/)*(?:\.\.$)?/,l.prototype.toString=function(){var t=[];return null!==this.scheme_&&t.push(this.scheme_,":"),null!==this.domain_&&(t.push("//"),null!==this.credentials_&&t.push(this.credentials_,"@"),t.push(this.domain_),null!==this.port_&&t.push(":",this.port_.toString())),null!==this.path_&&t.push(this.path_),null!==this.query_&&t.push("?",this.query_),null!==this.fragment_&&t.push("#",this.fragment_),t.join("")},l.prototype.clone=function(){return new l(this.scheme_,this.credentials_,this.domain_,this.port_,this.path_,this.query_,this.fragment_)},l.prototype.getScheme=function(){return this.scheme_&&decodeURIComponent(this.scheme_).toLowerCase()},l.prototype.getRawScheme=function(){return this.scheme_},l.prototype.setScheme=function(t){return this.scheme_=n(t,f),this},l.prototype.setRawScheme=function(t){return this.scheme_=t?t:null,this},l.prototype.hasScheme=function(){return null!==this.scheme_},l.prototype.getCredentials=function(){return this.credentials_&&decodeURIComponent(this.credentials_)},l.prototype.getRawCredentials=function(){return this.credentials_},l.prototype.setCredentials=function(t){return this.credentials_=n(t,f),this},l.prototype.setRawCredentials=function(t){return this.credentials_=t?t:null,this},l.prototype.hasCredentials=function(){return null!==this.credentials_},l.prototype.getDomain=function(){return this.domain_&&decodeURIComponent(this.domain_)},l.prototype.getRawDomain=function(){return this.domain_},l.prototype.setDomain=function(t){return this.setRawDomain(t&&encodeURIComponent(t))},l.prototype.setRawDomain=function(t){return this.domain_=t?t:null,this.setRawPath(this.path_)},l.prototype.hasDomain=function(){return null!==this.domain_},l.prototype.getPort=function(){return this.port_&&decodeURIComponent(this.port_)},l.prototype.setPort=function(t){if(t){if(t=Number(t),t!==(65535&t))throw new Error("Bad port number "+t);this.port_=""+t}else this.port_=null;return this},l.prototype.hasPort=function(){return null!==this.port_},l.prototype.getPath=function(){return this.path_&&decodeURIComponent(this.path_)},l.prototype.getRawPath=function(){return this.path_},l.prototype.setPath=function(t){return this.setRawPath(n(t,d))},l.prototype.setRawPath=function(t){return t?(t=String(t),this.path_=!this.domain_||/^\//.test(t)?t:"/"+t):this.path_=null,this},l.prototype.hasPath=function(){return null!==this.path_},l.prototype.getQuery=function(){return this.query_&&decodeURIComponent(this.query_).replace(/\+/g," ")},l.prototype.getRawQuery=function(){return this.query_},l.prototype.setQuery=function(t){return this.paramCache_=null,this.query_=r(t),this},l.prototype.setRawQuery=function(t){return this.paramCache_=null,this.query_=t?t:null,this},l.prototype.hasQuery=function(){return null!==this.query_},l.prototype.setAllParameters=function(t){var e,r,n,i,o,s,a;if("object"==typeof t&&!(t instanceof Array)&&(t instanceof Object||"[object Array]"!==Object.prototype.toString.call(t))){i=[],e=-1;for(n in t)a=t[n],"string"==typeof a&&(i[++e]=n,i[++e]=a);t=i}for(this.paramCache_=null,o=[],s="",r=0;r<t.length;)n=t[r++],a=t[r++],o.push(s,encodeURIComponent(n.toString())),s="&",a&&o.push("=",encodeURIComponent(a.toString()));return this.query_=o.join(""),this},l.prototype.checkParameterCache_=function(){var t,e,r,n,i,o;if(!this.paramCache_)if(o=this.query_){for(t=o.split(/[\x26\?]/),i=[],r=-1,e=0;e<t.length;++e)n=t[e].match(/^([^=]*)(?:=(.*))?$/),i[++r]=decodeURIComponent(n[1]).replace(/\+/g," "),i[++r]=decodeURIComponent(n[2]||"").replace(/\+/g," ");this.paramCache_=i}else this.paramCache_=[]},l.prototype.setParameterValues=function(t,e){var r,n,i,o,s;for("string"==typeof e&&(e=[e]),this.checkParameterCache_(),i=0,s=this.paramCache_,o=[],r=0,n=0;r<s.length;r+=2)t===s[r]?i<e.length&&o.push(t,e[i++]):o.push(s[r],s[r+1]);for(;i<e.length;)o.push(t,e[i++]);return this.setAllParameters(o),this},l.prototype.removeParameter=function(t){return this.setParameterValues(t,[])},l.prototype.getAllParameters=function(){return this.checkParameterCache_(),this.paramCache_.slice(0,this.paramCache_.length)},l.prototype.getParameterValues=function(t){var e,r;for(this.checkParameterCache_(),r=[],e=0;e<this.paramCache_.length;e+=2)t===this.paramCache_[e]&&r.push(this.paramCache_[e+1]);return r},l.prototype.getParameterMap=function(){var t,e,r,n;for(this.checkParameterCache_(),r={},t=0;t<this.paramCache_.length;t+=2)e=this.paramCache_[t++],n=this.paramCache_[t++],e in r?r[e].push(n):r[e]=[n];return r},l.prototype.getParameterValue=function(t){var e;for(this.checkParameterCache_(),e=0;e<this.paramCache_.length;e+=2)if(t===this.paramCache_[e])return this.paramCache_[e+1];return null},l.prototype.getFragment=function(){return this.fragment_&&decodeURIComponent(this.fragment_)},l.prototype.getRawFragment=function(){return this.fragment_},l.prototype.setFragment=function(t){return this.fragment_=t?encodeURIComponent(t):null,this},l.prototype.setRawFragment=function(t){return this.fragment_=t?t:null,this},l.prototype.hasFragment=function(){return null!==this.fragment_},g=new RegExp("^(?:([^:/?#]+):)?(?://(?:([^/?#]*)@)?([^/?#:@]*)(?::([0-9]+))?)?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$"),f=/[#\/\?@]/g,d=/[\#\?]/g,l.parse=t,l.create=e,l.resolve=a,l.collapse_dots=s,l.utils={mimeTypeOf:function(e){var r=t(e);return/\.html$/.test(r.getPath())?"text/html":"application/javascript"},resolve:function(e,r){return e?a(t(e),t(r)).toString():""+r}},l}(),"undefined"!=typeof window&&(window.URI=URI),sanitizeCssProperty=void 0,sanitizeCssSelectors=void 0,sanitizeStylesheet=void 0,sanitizeStylesheetWithExternals=void 0,function(){function t(t){return"string"==typeof t?'url("'+t.replace(a,e)+'")':s}function e(t){return l[t]}function r(t,e){return t?URI.utils.resolve(t,e):e}function n(t,e,r){var n;return r?(n=(""+t).match(o),!n||n[1]&&!i.test(n[1])?null:r(t,e)):null}var i,o,s='url("about:blank")',a=/[\n\f\r\"\'()*\x3c\x3e]/g,l={"\n":"%0a","\f":"%0c","\r":"%0d",'"':"%22","'":"%27","(":"%28",")":"%29","*":"%2a","<":"%3c",">":"%3e"};o=new RegExp("^(?:([^:/?# ]+):)?"),i=/^(?:https?|mailto)$/i,sanitizeCssProperty=function(){function e(t){var e,r,n,i={};for(r=t.length;--r>=0;)for(e=t[r],n=e.length;--n>=0;)i[e[n]]=o;return i}function i(t,e){for(var r,n=1,i=e+1,o=t.length;o>i&&n;)r=t[i++],n+="("===r?1:")"===r?-1:0;return i}var o;return o={},function(a,l,u,c,p){for(var h,d,f,g,m,v,y,b,w,x=l.cssPropBits,_=x&(CSS_PROP_BIT_QSTRING_CONTENT|CSS_PROP_BIT_QSTRING_URL),S=0/0,E=0,T=0;E<u.length;++E)w=u[E].toLowerCase(),h=w.charCodeAt(0),w=h===" ".charCodeAt(0)?"":h==='"'.charCodeAt(0)?_===CSS_PROP_BIT_QSTRING_URL&&c?t(n(r(p,decodeCss(u[E].substring(1,w.length-1))),a,c)):_===CSS_PROP_BIT_QSTRING_CONTENT?w:"":h==="#".charCodeAt(0)&&/^#(?:[0-9a-f]{3}){1,2}$/.test(w)?x&CSS_PROP_BIT_HASH_VALUE?w:"":"0".charCodeAt(0)<=h&&h<="9".charCodeAt(0)?x&CSS_PROP_BIT_QUANTITY?x&CSS_PROP_BIT_Z_INDEX?w.match(/^\d{1,7}$/)?w:"":w:"":(d=w.charCodeAt(1),f=w.charCodeAt(2),m="0".charCodeAt(0)<=d&&d<="9".charCodeAt(0),v="0".charCodeAt(0)<=f&&f<="9".charCodeAt(0),h==="+".charCodeAt(0)&&(m||d===".".charCodeAt(0)&&v)?x&CSS_PROP_BIT_QUANTITY?x&CSS_PROP_BIT_Z_INDEX?w.match(/^\+\d{1,7}$/)?w:"":(m?"":"0")+w.substring(1):"":h==="-".charCodeAt(0)&&(m||d===".".charCodeAt(0)&&v)?x&CSS_PROP_BIT_NEGATIVE_QUANTITY?x&CSS_PROP_BIT_Z_INDEX?w.match(/^\-\d{1,7}$/)?w:"":(m?"-":"-0")+w.substring(1):x&CSS_PROP_BIT_QUANTITY?"0":"":h===".".charCodeAt(0)&&m?x&CSS_PROP_BIT_QUANTITY?"0"+w:"":"url("===w.substring(0,4)?c&&_&CSS_PROP_BIT_QSTRING_URL?t(n(r(p,u[E].substring(5,w.length-2)),a,c)):"":("("===w.charAt(w.length-1)&&(g=i(u,E),u.splice(E,g-E,w=u.slice(E,g).join(" "))),y=l.cssLitGroup,b=y?l.cssLitMap||(l.cssLitMap=e(y)):o,b[w]===o||l.cssExtra&&l.cssExtra.test(w)?w:/^\w+$/.test(w)&&_===CSS_PROP_BIT_QSTRING_CONTENT?S+1===T?(u[S]=u[S].substring(0,u[S].length-1)+" "+w+'"',w=""):(S=T,'"'+w+'"'):"")),w&&(u[T++]=w);1===T&&u[0]===s&&(T=0),u.length=T}}(),sanitizeCssSelectors=function(t,e,r){function n(n,i){function o(n,i){var o,s,a,l,u,h,d,f,g,m="";i>n&&(f=t[n],"*"===f?(++n,m=f):/^[a-zA-Z]/.test(f)&&(u=r(f.toLowerCase(),[]),u&&("tagName"in u&&(f=u.tagName),++n,m=f))),l="";for(;i>n;){if(f=t[n],"#"===f.charAt(0)){if(/^#_|__$|[^#0-9A-Za-z:_\-]/.test(f))return null;l+=f+"-"+e}else{if("."!==f)break;if(!(++n<i&&/^[0-9A-Za-z:_\-]+$/.test(f=t[n]))||/^_|__$/.test(f))return null;l+="."+f}++n}for(s="";i>n&&"["===t[n];){if(++n,o=t[n++],a=html4.ATTRIBS[m+"::"+o],a!==+a&&(a=html4.ATTRIBS["*::"+o]),a!==+a)return null;if(h="",g="",/^[~^$*|]?=$/.test(t[n])&&(h=t[n++],g=t[n++]),"]"!==t[n++])return null;switch(a){case html4.atype.NONE:case html4.atype.URI:case html4.atype.URI_FRAGMENT:case html4.atype.ID:case html4.atype.IDREF:case html4.atype.IDREFS:case html4.atype.GLOBAL_NAME:case html4.atype.LOCAL_NAME:case html4.atype.CLASSES:if(h&&a!==html4.atype.NONE)return null;s+="["+o+h+g+"]"}}if(d="",i>n&&":"===t[n])if(f=t[++n],p.test(f)){if(!/^[a*]?$/.test(m))return null;v=!0,d=":"+f,++n,m="a"}else c.test(f)&&(v=!1,d=":"+f,++n);return n===i?(m+l).replace(/[^ .*#\w-]/g,"\\$&")+s+d:null}var s,a,h,d,f,g,m,v=!1;for(" "===t[n]&&++n,i-1!==n&&" "===t[i]&&--i,f=[],d=n,s="",a=n;i>a;++a)if(m=t[a],h=">"===m,h||" "===m){if(s=o(d,a,!1),!s||h&&/^html/i.test(s))return;d=a+1,f.push(s,h?" > ":" ")}s=o(d,i,!0),s&&(f.push(s),g=f.join(""),g="."+e+" "+g,(v?l:u).push(g))}var i,o,s,a,l=[],u=[],c=/^(active|after|before|first-child|first-letter|focus|hover)$/,p=/^(link|visited)$/,h=0,d=0;for(i=0;i<t.length;++i)a=t[i],!(("("==a||"["==a?(++d,0):")"==a||"]"==a?(d&&--d,0):" "==t[i]&&(d||">"==t[i-1]||">"==t[i+1]))||!(t[h++]=t[i]));for(t.length=h,o=t.length,s=0,i=0;o>i;++i)","===t[i]&&(n(s,i),s=i+1);return n(s,o),[u,l]},function(){function t(t){var e,r,n,i=!1;for(e=0,r=t.length;r-1>e;++e)n=t[e],":"===t[e+1]&&(i=!(cssSchema[n].cssPropBits&CSS_PROP_BIT_ALLOWED_IN_LINK)),i&&(t[e]=""),";"===n&&(i=!1);return t.join("")}function e(t){var e,r=/^\s*["]([^"]*)["]\s*$/,n=/^\s*[']([^']*)[']\s*$/,i=/^\s*url\s*[(]["]([^"]*)["][)]\s*$/,o=/^\s*url\s*[(][']([^']*)['][)]\s*$/,s=/^\s*url\s*[(]([^)]*)[)]\s*$/;return(e=r.exec(t))?e[1]:(e=n.exec(t))?e[1]:(e=i.exec(t))?e[1]:(e=o.exec(t))?e[1]:(e=s.exec(t))?e[1]:null}function i(a,l,u,c,p,h,d){function f(){y=0!==v.length&&null!==v[v.length-1]&&"@"!==v[v.length-1][0]}var g=void 0,m=!1,v=[],y=!1;return parseCssStylesheet(l,{startStylesheet:function(){g=[]},endStylesheet:function(){},startAtrule:function(t,l){var f;y?t=null:"@media"===t?(l=l.filter(function(t){return s[t]==o}),l.length?g.push(t," ",l.join(",")):t=null):"@import"===t&&l.length>0&&("function"==typeof d?(m=!0,f=n(r(a,e(l[0])),function(t){var e=i(f,t.html,u,c,p,h,d);d(e.result,e.moreToCome)},p)):window.console&&window.console.log("@import "+l.join(" ")+" elided"),t=null),y=!t,v.push(t)},endAtrule:function(){v.pop();y||g.push(";"),f()},startBlock:function(){y||g.push("{")},endBlock:function(){y||(g.push("}"),y=!0)},startRuleset:function(t){var e,r,n,i=void 0,o=!1;y||(n=sanitizeCssSelectors(t,u,h),e=n[0],i=n[1],e.length||i.length?(r=e.join(", "),r||(r="head > html",o=!0),g.push(r,"{")):y=!0),v.push(y?null:{historySensitiveSelectors:i,endOfSelectors:g.length-1,removeHistoryInsensitiveSelectors:o})},endRuleset:function(){var e,r,n=v.pop(),i=g.length;y||(g.push("}"),n&&(e=n.historySensitiveSelectors,e.length&&(r=g.slice(n.endOfSelectors),g.push(e.join(", "),t(r))))),n&&n.removeHistoryInsensitiveSelectors&&g.splice(n.endOfSelectors-1,i+1),f()},declaration:function(t,e){var r;y||(r=cssSchema[t],r&&(sanitizeCssProperty(t,r,e,c,a),e.length&&g.push(t,":",e.join(" "),";")))}}),{result:g.join(""),moreToCome:m}}var o={},s={braille:o,embossed:o,handheld:o,print:o,projection:o,screen:o,speech:o,tty:o,tv:o};sanitizeStylesheet=function(t,e,r,n,o){return i(t,e,r,n,void 0,o,void 0).result},sanitizeStylesheetWithExternals=function(t,e,r,n,o,s,a){return i(t,e,r,n,o,s,a)}}()}(),"undefined"!=typeof window&&(window.sanitizeCssProperty=sanitizeCssProperty,window.sanitizeCssSelectors=sanitizeCssSelectors,window.sanitizeStylesheet=sanitizeStylesheet),"i"!=="I".toLowerCase())throw"I/i problem";if(function(){function t(t,r,i,o){var s;return i>r?(s=t[r],"@"===s.charAt(0)?e(t,r,i,o,!0):n(t,r,i,o)):r}function e(t,e,n,i,o){for(var s,a,l=e++;n>e&&"{"!==t[e]&&";"!==t[e];)++e;return n>e&&(o||";"===t[e])&&(a=l+1,s=e,n>a&&" "===t[a]&&++a,s>a&&" "===t[s-1]&&--s,i.startAtrule&&i.startAtrule(t[l].toLowerCase(),t.slice(a,s)),e="{"===t[e]?r(t,e,n,i):e+1,i.endAtrule&&i.endAtrule()),e}function r(t,i,o,s){var a;for(++i,s.startBlock&&s.startBlock();o>i;){if(a=t[i].charAt(0),"}"==a){++i;break}" "===a||";"===a?i+=1:i="@"===a?e(t,i,o,s,!1):"{"===a?r(t,i,o,s):n(t,i,o,s)}return s.endBlock&&s.endBlock(),i}function n(t,e,r,n){var s,a=e,l=i(t,e,r,!0);if(0>l)return l=~l,e===l?l+1:l;if(e=l,l>a&&" "===t[l-1]&&--l,s=t[e],++e,"{"!==s)return e;for(n.startRuleset&&n.startRuleset(t.slice(a,l));r>e;){if(s=t[e],"}"===s){++e;break}" "===s?e+=1:e=o(t,e,r,n)}return n.endRuleset&&n.endRuleset(),r>e?e+1:e}function i(t,e,r,n){for(var i,o=[],s=-1;r>e;++e)if(i=t[e].charAt(0),"["===i||"("===i)o[++s]=i;else if("]"===i&&"["===o[s]||")"===i&&"("===o[s])--s;else if("{"===i||"}"===i||";"===i||"@"===i||":"===i&&!n)break;return s>=0&&(e=~(e+1)),e}function o(t,e,r,n){var o,a,l,u,c,p,h=t[e++];if(!s.test(h))return e+1;if(r>e&&" "===t[e]&&++e,e==r||":"!==t[e]){for(;r>e&&";"!==(u=t[e])&&"}"!==u;)++e;return e}if(++e,r>e&&" "===t[e]&&++e,l=e,o=i(t,e,r,!1),0>o)o=~o;else{for(c=[],p=0,a=l;o>a;++a)u=t[a]," "!==u&&(c[p++]=u);if(r>o){do{if(u=t[o],";"===u||"}"===u)break;p=0}while(++o<r);";"===u&&++o}p&&n.declaration&&n.declaration(h.toLowerCase(),c)}return o}var s;parseCssStylesheet=function(e,r){var n,i,o=lexCss(e);for(r.startStylesheet&&r.startStylesheet(),n=0,i=o.length;i>n;)n=" "===o[n]?n+1:t(o,n,i,r);r.endStylesheet&&r.endStylesheet()},s=/^-?[a-z]/i,parseCssDeclarations=function(t,e){var r,n,i=lexCss(t);for(r=0,n=i.length;n>r;)r=" "!==i[r]?o(i,r,n,e):r+1}}(),"undefined"!=typeof window&&(window.parseCssStylesheet=parseCssStylesheet,window.parseCssDeclarations=parseCssDeclarations),html4={},html4.atype={NONE:0,URI:1,URI_FRAGMENT:11,SCRIPT:2,STYLE:3,HTML:12,ID:4,IDREF:5,IDREFS:6,GLOBAL_NAME:7,LOCAL_NAME:8,CLASSES:9,FRAME_TARGET:10,MEDIA_QUERY:13},html4.atype=html4.atype,html4.ATTRIBS={"*::class":9,"*::dir":0,"*::draggable":0,"*::hidden":0,"*::id":4,"*::inert":0,"*::itemprop":0,"*::itemref":6,"*::itemscope":0,"*::lang":0,"*::onblur":2,"*::onchange":2,"*::onclick":2,"*::ondblclick":2,"*::onfocus":2,"*::onkeydown":2,"*::onkeypress":2,"*::onkeyup":2,"*::onload":2,"*::onmousedown":2,"*::onmousemove":2,"*::onmouseout":2,"*::onmouseover":2,"*::onmouseup":2,"*::onreset":2,"*::onscroll":2,"*::onselect":2,"*::onsubmit":2,"*::onunload":2,"*::spellcheck":0,"*::style":3,"*::title":0,"*::accept":0,"span::name":7,"*::translate":0,"a::accesskey":0,"a::coords":0,"a::href":1,"a::hreflang":0,"a::name":7,"a::onblur":2,"a::onfocus":2,"a::shape":0,"a::tabindex":0,"a::target":10,"a::type":0,"area::accesskey":0,"area::alt":0,"area::coords":0,"area::href":1,"area::nohref":0,"area::onblur":2,"area::onfocus":2,"area::shape":0,"area::tabindex":0,"area::target":10,"audio::controls":0,"audio::loop":0,"audio::mediagroup":5,"audio::muted":0,"audio::preload":0,"bdo::dir":0,"blockquote::cite":1,"br::clear":0,"button::accesskey":0,"button::disabled":0,"button::name":8,"button::onblur":2,"button::onfocus":2,"button::tabindex":0,"button::type":0,"button::value":0,"canvas::height":0,"canvas::width":0,"caption::align":0,"col::align":0,"col::char":0,"col::charoff":0,"col::span":0,"col::valign":0,"col::width":0,"colgroup::align":0,"colgroup::char":0,"colgroup::charoff":0,"colgroup::span":0,"colgroup::valign":0,"colgroup::width":0,"command::checked":0,"command::command":5,"command::disabled":0,"command::icon":1,"command::label":0,"command::radiogroup":0,"command::type":0,"*::data-i18n":0,"*::data-i18n-dynamic":0,"*::data-i18n-vars":0,"*::data-i18n-placeholder":0,"*::data-i18n-title":0,"*::data-i18n-alt":0,"*::data-i18n-aria-label":0,"*::data-i18n-label":0,"data::value":0,"del::cite":1,"del::datetime":0,"details::open":0,"dir::compact":0,"div::align":0,"dl::compact":0,"fieldset::disabled":0,"font::color":0,"font::face":0,"font::size":0,"form::accept":0,"form::action":1,"form::autocomplete":0,"form::enctype":0,"form::method":0,"form::name":7,"form::novalidate":0,"form::onreset":2,"form::onsubmit":2,"form::target":10,"h1::align":0,"h2::align":0,"h3::align":0,"h4::align":0,"h5::align":0,"h6::align":0,"hr::align":0,"hr::noshade":0,"hr::size":0,"hr::width":0,"iframe::align":0,"iframe::frameborder":0,"iframe::height":0,"iframe::marginheight":0,"iframe::marginwidth":0,"iframe::width":0,"img::align":0,"img::alt":0,"img::border":0,"img::height":0,"img::hspace":0,"img::ismap":0,"img::name":7,"img::src":1,"img::usemap":11,"img::vspace":0,"img::width":0,"input::accept":0,"input::accesskey":0,"input::align":0,"input::alt":0,"input::autocomplete":0,"input::checked":0,"input::disabled":0,"input::inputmode":0,"input::ismap":0,"input::list":5,"input::max":0,"input::maxlength":0,"input::min":0,"input::multiple":0,"input::name":8,"input::onblur":2,"input::onchange":2,"input::onfocus":2,"input::onselect":2,"input::placeholder":0,"input::readonly":0,"input::required":0,"input::size":0,"input::src":1,"input::step":0,"input::tabindex":0,"input::type":0,"input::usemap":11,"input::value":0,"ins::cite":1,"ins::datetime":0,"label::accesskey":0,"label::for":5,"label::onblur":2,"label::onfocus":2,"legend::accesskey":0,"legend::align":0,"li::type":0,"li::value":0,"map::name":7,"menu::compact":0,"menu::label":0,"menu::type":0,"meter::high":0,"meter::low":0,"meter::max":0,"meter::min":0,"meter::value":0,"ol::compact":0,"ol::reversed":0,"ol::start":0,"ol::type":0,"optgroup::disabled":0,"optgroup::label":0,"option::disabled":0,"option::label":0,"option::selected":0,"option::value":0,"output::for":6,"output::name":8,"p::align":0,"pre::width":0,"progress::max":0,"progress::min":0,"progress::value":0,"q::cite":1,"select::autocomplete":0,"select::disabled":0,"select::multiple":0,"select::name":8,"select::onblur":2,"select::onchange":2,"select::onfocus":2,"select::required":0,"select::size":0,"select::tabindex":0,"source::type":0,"table::align":0,"table::bgcolor":0,"table::border":0,"table::cellpadding":0,"table::cellspacing":0,"table::frame":0,"table::rules":0,"table::summary":0,"table::width":0,"tbody::align":0,"tbody::char":0,"tbody::charoff":0,"tbody::valign":0,"td::abbr":0,"td::align":0,"td::axis":0,"td::bgcolor":0,"td::char":0,"td::charoff":0,"td::colspan":0,"td::headers":6,"td::height":0,"td::nowrap":0,"td::rowspan":0,"td::scope":0,"td::valign":0,"td::width":0,"textarea::accesskey":0,"textarea::autocomplete":0,"textarea::cols":0,"textarea::disabled":0,"textarea::inputmode":0,"textarea::name":8,"textarea::onblur":2,"textarea::onchange":2,"textarea::onfocus":2,"textarea::onselect":2,"textarea::placeholder":0,"textarea::readonly":0,"textarea::required":0,"textarea::rows":0,"textarea::tabindex":0,"textarea::wrap":0,"tfoot::align":0,"tfoot::char":0,"tfoot::charoff":0,"tfoot::valign":0,"th::abbr":0,"th::align":0,"th::axis":0,"th::bgcolor":0,"th::char":0,"th::charoff":0,"th::colspan":0,"th::headers":6,"th::height":0,"th::nowrap":0,"th::rowspan":0,"th::scope":0,"th::valign":0,"th::width":0,"thead::align":0,"thead::char":0,"thead::charoff":0,"thead::valign":0,"tr::align":0,"tr::bgcolor":0,"tr::char":0,"tr::charoff":0,"tr::valign":0,"track::default":0,"track::kind":0,"track::label":0,"track::srclang":0,"ul::compact":0,"ul::type":0,"video::controls":0,"video::height":0,"video::loop":0,"video::mediagroup":5,"video::muted":0,"video::poster":1,"video::preload":0,"video::width":0},html4.ATTRIBS=html4.ATTRIBS,html4.eflags={OPTIONAL_ENDTAG:1,EMPTY:2,CDATA:4,RCDATA:8,UNSAFE:16,FOLDABLE:32,SCRIPT:64,STYLE:128,VIRTUALIZED:256},html4.eflags=html4.eflags,html4.ELEMENTS={a:0,abbr:0,acronym:0,address:0,applet:272,area:2,article:0,aside:0,audio:0,b:0,base:274,basefont:274,bdi:0,bdo:0,big:0,blockquote:0,body:305,br:2,button:0,canvas:0,caption:0,center:0,cite:0,code:0,col:2,colgroup:1,command:2,data:0,datalist:0,dd:1,del:0,details:0,dfn:0,dialog:272,dir:0,div:0,dl:0,dt:1,em:0,fieldset:0,figcaption:0,figure:0,font:0,footer:0,form:0,frame:274,frameset:272,h1:0,h2:0,h3:0,h4:0,h5:0,h6:0,head:305,header:0,hgroup:0,hr:2,html:305,i:0,iframe:4,img:2,input:2,ins:0,isindex:274,kbd:0,keygen:274,label:0,legend:0,li:1,link:274,map:0,mark:0,menu:0,meta:274,meter:0,nav:0,nobr:0,noembed:276,noframes:276,noscript:276,object:272,ol:0,optgroup:0,option:1,output:0,p:1,param:274,pre:0,progress:0,q:0,s:0,samp:0,script:84,section:0,select:0,small:0,source:2,span:0,strike:0,strong:0,style:148,sub:0,summary:0,sup:0,table:0,tbody:1,td:1,textarea:8,tfoot:1,th:1,thead:1,time:0,title:280,tr:1,track:2,tt:0,u:0,ul:0,"var":0,video:0,wbr:2},html4.ELEMENTS=html4.ELEMENTS,html4.ELEMENT_DOM_INTERFACES={a:"HTMLAnchorElement",abbr:"HTMLElement",acronym:"HTMLElement",address:"HTMLElement",applet:"HTMLAppletElement",area:"HTMLAreaElement",article:"HTMLElement",aside:"HTMLElement",audio:"HTMLAudioElement",b:"HTMLElement",base:"HTMLBaseElement",basefont:"HTMLBaseFontElement",bdi:"HTMLElement",bdo:"HTMLElement",big:"HTMLElement",blockquote:"HTMLQuoteElement",body:"HTMLBodyElement",br:"HTMLBRElement",button:"HTMLButtonElement",canvas:"HTMLCanvasElement",caption:"HTMLTableCaptionElement",center:"HTMLElement",cite:"HTMLElement",code:"HTMLElement",col:"HTMLTableColElement",colgroup:"HTMLTableColElement",command:"HTMLCommandElement",data:"HTMLElement",datalist:"HTMLDataListElement",dd:"HTMLElement",del:"HTMLModElement",details:"HTMLDetailsElement",dfn:"HTMLElement",dialog:"HTMLDialogElement",dir:"HTMLDirectoryElement",div:"HTMLDivElement",dl:"HTMLDListElement",dt:"HTMLElement",em:"HTMLElement",fieldset:"HTMLFieldSetElement",figcaption:"HTMLElement",figure:"HTMLElement",font:"HTMLFontElement",footer:"HTMLElement",form:"HTMLFormElement",frame:"HTMLFrameElement",frameset:"HTMLFrameSetElement",h1:"HTMLHeadingElement",h2:"HTMLHeadingElement",h3:"HTMLHeadingElement",h4:"HTMLHeadingElement",h5:"HTMLHeadingElement",h6:"HTMLHeadingElement",head:"HTMLHeadElement",header:"HTMLElement",hgroup:"HTMLElement",hr:"HTMLHRElement",html:"HTMLHtmlElement",i:"HTMLElement",iframe:"HTMLIFrameElement",img:"HTMLImageElement",input:"HTMLInputElement",ins:"HTMLModElement",isindex:"HTMLUnknownElement",kbd:"HTMLElement",keygen:"HTMLKeygenElement",label:"HTMLLabelElement",legend:"HTMLLegendElement",li:"HTMLLIElement",link:"HTMLLinkElement",map:"HTMLMapElement",mark:"HTMLElement",menu:"HTMLMenuElement",meta:"HTMLMetaElement",meter:"HTMLMeterElement",nav:"HTMLElement",nobr:"HTMLElement",noembed:"HTMLElement",noframes:"HTMLElement",noscript:"HTMLElement",object:"HTMLObjectElement",ol:"HTMLOListElement",optgroup:"HTMLOptGroupElement",option:"HTMLOptionElement",output:"HTMLOutputElement",p:"HTMLParagraphElement",param:"HTMLParamElement",pre:"HTMLPreElement",progress:"HTMLProgressElement",q:"HTMLQuoteElement",s:"HTMLElement",samp:"HTMLElement",script:"HTMLScriptElement",section:"HTMLElement",select:"HTMLSelectElement",small:"HTMLElement",source:"HTMLSourceElement",span:"HTMLSpanElement",strike:"HTMLElement",strong:"HTMLElement",style:"HTMLStyleElement",sub:"HTMLElement",summary:"HTMLElement",sup:"HTMLElement",table:"HTMLTableElement",tbody:"HTMLTableSectionElement",td:"HTMLTableDataCellElement",textarea:"HTMLTextAreaElement",tfoot:"HTMLTableSectionElement",th:"HTMLTableHeaderCellElement",thead:"HTMLTableSectionElement",time:"HTMLTimeElement",title:"HTMLTitleElement",tr:"HTMLTableRowElement",track:"HTMLTrackElement",tt:"HTMLElement",u:"HTMLElement",ul:"HTMLUListElement","var":"HTMLElement",video:"HTMLVideoElement",wbr:"HTMLElement"},html4.ELEMENT_DOM_INTERFACES=html4.ELEMENT_DOM_INTERFACES,html4.ueffects={NOT_LOADED:0,SAME_DOCUMENT:1,NEW_DOCUMENT:2},html4.ueffects=html4.ueffects,html4.URIEFFECTS={"a::href":2,"area::href":2,"blockquote::cite":0,"command::icon":1,"del::cite":0,"form::action":2,"img::src":1,"input::src":1,"ins::cite":0,"q::cite":0,"video::poster":1},html4.URIEFFECTS=html4.URIEFFECTS,html4.ltypes={UNSANDBOXED:2,SANDBOXED:1,DATA:0},html4.ltypes=html4.ltypes,html4.LOADERTYPES={"a::href":2,"area::href":2,"blockquote::cite":2,"command::icon":1,"del::cite":2,"form::action":2,"img::src":1,"input::src":1,"ins::cite":2,"q::cite":2,"video::poster":1},html4.LOADERTYPES=html4.LOADERTYPES,"undefined"!=typeof window&&(window.html4=html4),"i"!=="I".toLowerCase())throw"I/i problem";html=function(t){function e(t){var e,r;return L.hasOwnProperty(t)?L[t]:(e=t.match(H),e?String.fromCharCode(parseInt(e[1],10)):(e=t.match(j))?String.fromCharCode(parseInt(e[1],16)):N&&K.test(t)?(N.innerHTML="&"+t+";",r=N.textContent,L[t]=r,r):"&"+t+";")}function r(t,r){return e(r)}function n(t){return t.replace(z,"")}function i(t){return t.replace(M,r)}function o(t){return(""+t).replace(B,"&amp;").replace(U,"&lt;").replace(D,"&gt;").replace(X,"&#34;")}function s(t){return t.replace(G,"&amp;$1").replace(U,"&lt;").replace(D,"&gt;")}function a(t){var e={cdata:t.cdata||t.cdata,comment:t.comment||t.comment,endDoc:t.endDoc||t.endDoc,endTag:t.endTag||t.endTag,pcdata:t.pcdata||t.pcdata,rcdata:t.rcdata||t.rcdata,startDoc:t.startDoc||t.startDoc,startTag:t.startTag||t.startTag};return function(t,r){return l(t,e,r)}}function l(t,e,r){var n=p(t),i={noMoreGT:!1,noMoreEndComments:!1};c(e,n,0,i,r)}function u(t,e,r,n,i){return function(){c(t,e,r,n,i)}}function c(e,r,n,i,o){var s,a,l,c,p,g,m,v,y,b;try{for(e.startDoc&&0==n&&e.startDoc(o),v=n,c=r.length;c>v;)switch(a=r[v++],g=r[v],a){case"&":k.test(g)?(e.pcdata&&e.pcdata("&"+g,o,I,u(e,r,v,i,o)),++v):e.pcdata&&e.pcdata("&amp;",o,I,u(e,r,v,i,o));break;case"</":(p=/^([-\w:]+)[^\'\"]*/.exec(g))?p[0].length===g.length&&">"===r[v+1]?(v+=2,b=p[1].toLowerCase(),e.endTag&&e.endTag(b,o,I,u(e,r,v,i,o))):v=h(r,v,e,o,I,i):e.pcdata&&e.pcdata("&lt;/",o,I,u(e,r,v,i,o));break;case"<":(p=/^([-\w:]+)\s*\/?/.exec(g))?p[0].length===g.length&&">"===r[v+1]?(v+=2,b=p[1].toLowerCase(),e.startTag&&e.startTag(b,[],o,I,u(e,r,v,i,o)),l=t.ELEMENTS[b],l&R&&(y={name:b,next:v,eflags:l},v=f(r,y,e,o,I,i))):v=d(r,v,e,o,I,i):e.pcdata&&e.pcdata("&lt;",o,I,u(e,r,v,i,o));break;case"<!--":if(!i.noMoreEndComments){for(m=v+1;c>m&&(">"!==r[m]||!/--$/.test(r[m-1]));++m);c>m?(e.comment&&(s=r.slice(v,m).join(""),e.comment(s.substr(0,s.length-2),o,I,u(e,r,m+1,i,o))),v=m+1):i.noMoreEndComments=!0}i.noMoreEndComments&&e.pcdata&&e.pcdata("&lt;!--",o,I,u(e,r,v,i,o));break;case"<!":if(/^\w/.test(g)){if(!i.noMoreGT){for(m=v+1;c>m&&">"!==r[m];++m);c>m?v=m+1:i.noMoreGT=!0}i.noMoreGT&&e.pcdata&&e.pcdata("&lt;!",o,I,u(e,r,v,i,o))}else e.pcdata&&e.pcdata("&lt;!",o,I,u(e,r,v,i,o));break;case"<?":if(!i.noMoreGT){for(m=v+1;c>m&&">"!==r[m];++m);c>m?v=m+1:i.noMoreGT=!0}i.noMoreGT&&e.pcdata&&e.pcdata("&lt;?",o,I,u(e,r,v,i,o));break;case">":e.pcdata&&e.pcdata("&gt;",o,I,u(e,r,v,i,o));break;case"":break;default:e.pcdata&&e.pcdata(a,o,I,u(e,r,v,i,o))}e.endDoc&&e.endDoc(o)}catch(w){if(w!==I)throw w}}function p(t){var e,r,n,i=/(\x3c\/|\x3c\!--|\x3c[!?]|[\x26\x3c\x3e])/g;if(t+="",Y)return t.split(i);for(n=[],e=0;null!==(r=i.exec(t));)n.push(t.substring(e,r.index)),n.push(r[0]),e=r.index+r[0].length;return n.push(t.substring(e)),n}function h(t,e,r,n,i,o){var s=g(t,e);return s?(r.endTag&&r.endTag(s.name,n,i,u(r,t,e,o,n)),s.next):t.length}function d(t,e,r,n,i,o){var s=g(t,e);return s?(r.startTag&&r.startTag(s.name,s.attrs,n,i,u(r,t,s.next,o,n)),s.eflags&R?f(t,s,r,n,i,o):s.next):t.length}function f(e,r,n,i,o,a){var l,c,p,h,d=e.length;for(F.hasOwnProperty(r.name)||(F[r.name]=new RegExp("^"+r.name+"(?:[\\s\\/]|$)","i")),h=F[r.name],c=r.next,p=r.next+1;d>p&&("</"!==e[p-1]||!h.test(e[p]));++p);if(d>p&&(p-=1),l=e.slice(c,p).join(""),r.eflags&t.eflags.CDATA)n.cdata&&n.cdata(l,i,o,u(n,e,p,a,i));else{if(!(r.eflags&t.eflags.RCDATA))throw new Error("bug");n.rcdata&&n.rcdata(s(l),i,o,u(n,e,p,a,i))}return p}function g(e,r){var n,i,o,s,a,l,u,c,p,h=/^([-\w:]+)/.exec(e[r]),d={};for(d.name=h[1].toLowerCase(),d.eflags=t.ELEMENTS[d.name],a=e[r].substr(h[0].length),u=r+1,l=e.length;l>u&&">"!==e[u];++u)a+=e[u];if(!(u>=l)){for(s=[];""!==a;)if(h=P.exec(a)){if(h[4]&&!h[5]||h[6]&&!h[7]){for(c=h[4]||h[6],p=!1,o=[a,e[u++]];l>u;++u){if(p){if(">"===e[u])break}else 0<=e[u].indexOf(c)&&(p=!0);o.push(e[u])}if(u>=l)break;a=o.join("");continue}n=h[1].toLowerCase(),i=h[2]?m(h[3]):"",s.push(n,i),a=a.substr(h[0].length)}else a=a.replace(/^[\s\S][^a-z\s]*/,"");return d.attrs=s,d.next=u+1,d}}function m(t){var e=t.charCodeAt(0);return(34===e||39===e)&&(t=t.substr(1,t.length-2)),i(n(t))}function v(e){var r,n,i=function(t,e){r||e.push(t)};return a({startDoc:function(){n=[],r=!1},startTag:function(i,s,a){var l,u,c,p,h,d,f,g,m;if(!r&&t.ELEMENTS.hasOwnProperty(i)&&(c=t.ELEMENTS[i],!(c&t.eflags.FOLDABLE))){if(u=e(i,s),!u)return void(r=!(c&t.eflags.EMPTY));if("object"!=typeof u)throw new Error("tagPolicy did not return object (old API?)");if(!("attribs"in u))throw new Error("tagPolicy gave no attribs");s=u.attribs,"tagName"in u?(g=u.tagName,p=t.ELEMENTS[g]):(g=i,p=c),c&t.eflags.OPTIONAL_ENDTAG&&(f=n[n.length-1],f&&f.orig===i&&(f.rep!==g||i!==g)&&a.push("</",f.rep,">")),c&t.eflags.EMPTY||n.push({orig:i,rep:g}),a.push("<",g);for(h=0,d=s.length;d>h;h+=2)l=s[h],m=s[h+1],null!==m&&void 0!==m&&a.push(" ",l,'="',o(m),'"');a.push(">"),c&t.eflags.EMPTY&&!(p&t.eflags.EMPTY)&&a.push("</",g,">")}},endTag:function(e,i){var o,s,a,l,u;if(r)return void(r=!1);if(t.ELEMENTS.hasOwnProperty(e)&&(o=t.ELEMENTS[e],!(o&(t.eflags.EMPTY|t.eflags.FOLDABLE)))){if(o&t.eflags.OPTIONAL_ENDTAG){for(a=n.length;--a>=0&&(l=n[a].orig,l!==e);)if(!(t.ELEMENTS[l]&t.eflags.OPTIONAL_ENDTAG))return}else for(a=n.length;--a>=0&&n[a].orig!==e;);if(0>a)return;for(s=n.length;--s>a;)u=n[s].rep,t.ELEMENTS[u]&t.eflags.OPTIONAL_ENDTAG||i.push("</",u,">");a<n.length&&(e=n[a].rep),n.length=a,i.push("</",e,">")}},pcdata:i,rcdata:i,cdata:i,endDoc:function(t){for(;n.length;--n.length)t.push("</",n[n.length-1].rep,">")}})}function y(t,e,r,n,i){var o,s;if(!i)return null;try{if(o=URI.parse(""+t),o&&(!o.hasScheme()||C.test(o.getScheme())))return s=i(o,e,r,n),s?s.toString():null}catch(a){return null}return null}function b(t,e,r,n,i){var o;r||t(e+" removed",{change:"removed",tagName:e}),n!==i&&(o="changed",n&&!i?o="removed":!n&&i&&(o="added"),t(e+"."+r+" "+o,{change:o,tagName:e,attribName:r,oldValue:n,newValue:i}))}function w(t,e,r){var n=e+"::"+r;return t.hasOwnProperty(n)?t[n]:(n="*::"+r,t.hasOwnProperty(n)?t[n]:void 0)}function x(e,r){return w(t.LOADERTYPES,e,r)}function _(e,r){return w(t.URIEFFECTS,e,r)}function S(e,r,n,i,o){var s,a,l,u,c,p,h;for(u=0;u<r.length;u+=2){if(a=r[u],h=r[u+1],c=h,l=null,s=e+"::"+a,(t.ATTRIBS.hasOwnProperty(s)||(s="*::"+a,t.ATTRIBS.hasOwnProperty(s)))&&(l=t.ATTRIBS[s]),null!==l)switch(l){case t.atype.NONE:break;case t.atype.SCRIPT:h=null,o&&b(o,e,a,c,h);break;case t.atype.STYLE:if("undefined"==typeof q){h=null,o&&b(o,e,a,c,h);break}p=[],q(h,{declaration:function(e,r){var i=e.toLowerCase(),o=O[i];o&&(V(i,o,r,n?function(e){return y(e,t.ueffects.SAME_DOCUMENT,t.ltypes.SANDBOXED,{TYPE:"CSS",CSS_PROP:i},n)}:null),p.push(e+": "+r.join(" ")))}}),h=p.length>0?p.join(" ; "):null,o&&b(o,e,a,c,h);break;case t.atype.ID:case t.atype.IDREF:case t.atype.IDREFS:case t.atype.GLOBAL_NAME:case t.atype.LOCAL_NAME:case t.atype.CLASSES:h=i?i(h):h,o&&b(o,e,a,c,h);break;case t.atype.URI:h=y(h,_(e,a),x(e,a),{TYPE:"MARKUP",XML_ATTR:a,XML_TAG:e},n),o&&b(o,e,a,c,h);break;case t.atype.URI_FRAGMENT:h&&"#"===h.charAt(0)?(h=h.substring(1),h=i?i(h):h,null!==h&&void 0!==h&&(h="#"+h)):h=null,o&&b(o,e,a,c,h);break;default:h=null,o&&b(o,e,a,c,h)}else h=null,o&&b(o,e,a,c,h);r[u+1]=h}return r}function E(e,r,n){return function(i,o){return t.ELEMENTS[i]&t.eflags.UNSAFE?void(n&&b(n,i,void 0,void 0,void 0)):{attribs:S(i,o,e,r,n)}}}function T(t,e){var r=[];return v(e)(t,r),r.join("")}function A(t,e,r,n){var i=E(e,r,n);return T(t,i)}var C,P,R,L,M,k,B,I,O,H,F,N,D,j,$,G,U,z,q,X,K,V,Y;return"undefined"!=typeof window&&(q=window.parseCssDeclarations,V=window.sanitizeCssProperty,O=window.cssSchema),L={lt:"<",LT:"<",gt:">",GT:">",amp:"&",AMP:"&",quot:'"',apos:"'",nbsp:"\xa0"},H=/^#(\d+)$/,j=/^#x([0-9A-Fa-f]+)$/,K=/^[A-Za-z][A-za-z0-9]+$/,N="undefined"!=typeof window&&window.document?window.document.createElement("textarea"):null,z=/\0/g,M=/\x26(#[0-9]+|#[xX][0-9A-Fa-f]+|\w+);/g,k=/^(#[0-9]+|#[xX][0-9A-Fa-f]+|\w+);/,B=/\x26/g,G=/\x26([^a-z#]|#(?:[^0-9x]|x(?:[^0-9a-f]|$)|$)|$)/gi,U=/[\x3c]/g,D=/\x3e/g,X=/\"/g,P=new RegExp("^\\s*([-.:\\w]+)(?:\\s*(=)\\s*((\")[^\"]*(\"|$)|(')[^']*('|$)|(?=[a-z][-\\w]*\\s*=)|[^\"'\\s]*))?","i"),Y=3==="a,b".split(/(,)/).length,R=t.eflags.CDATA|t.eflags.RCDATA,I={},F={},C=/^(?:https?|mailto)$/i,$={},$.escapeAttrib=$.escapeAttrib=o,$.makeHtmlSanitizer=$.makeHtmlSanitizer=v,$.makeSaxParser=$.makeSaxParser=a,$.makeTagPolicy=$.makeTagPolicy=E,$.normalizeRCData=$.normalizeRCData=s,$.sanitize=$.sanitize=A,$.sanitizeAttribs=$.sanitizeAttribs=S,$.sanitizeWithPolicy=$.sanitizeWithPolicy=T,$.unescapeEntities=$.unescapeEntities=i,$
}(html4),html_sanitize=html.sanitize,"undefined"!=typeof window&&(window.html=html,window.html_sanitize=html_sanitize);var UTF8={};UTF8.encode=function(t){for(var e=[],r=0;r<t.length;++r){var n=t.charCodeAt(r);128>n?e.push(n):2048>n?(e.push(192|n>>6),e.push(128|63&n)):65536>n?(e.push(224|n>>12),e.push(128|63&n>>6),e.push(128|63&n)):(e.push(240|n>>18),e.push(128|63&n>>12),e.push(128|63&n>>6),e.push(128|63&n))}return e},UTF8.decode=function(t){for(var e=[],r=0;r<t.length;){var n=t[r++];128>n||(224>n?(n=(31&n)<<6,n|=63&t[r++]):240>n?(n=(15&n)<<12,n|=(63&t[r++])<<6,n|=63&t[r++]):(n=(7&n)<<18,n|=(63&t[r++])<<12,n|=(63&t[r++])<<6,n|=63&t[r++])),e.push(String.fromCharCode(n))}return e.join("")};var BASE64={};if(function(t){var e=function(e){for(var r=0,n=[],i=0|e.length/3;0<i--;){var o=(e[r]<<16)+(e[r+1]<<8)+e[r+2];r+=3,n.push(t.charAt(63&o>>18)),n.push(t.charAt(63&o>>12)),n.push(t.charAt(63&o>>6)),n.push(t.charAt(63&o))}if(2==e.length-r){var o=(e[r]<<16)+(e[r+1]<<8);n.push(t.charAt(63&o>>18)),n.push(t.charAt(63&o>>12)),n.push(t.charAt(63&o>>6)),n.push("=")}else if(1==e.length-r){var o=e[r]<<16;n.push(t.charAt(63&o>>18)),n.push(t.charAt(63&o>>12)),n.push("==")}return n.join("")},r=function(){for(var e=[],r=0;r<t.length;++r)e[t.charCodeAt(r)]=r;return e["=".charCodeAt(0)]=0,e}(),n=function(t){for(var e=0,n=[],i=0|t.length/4;0<i--;){var o=(r[t.charCodeAt(e)]<<18)+(r[t.charCodeAt(e+1)]<<12)+(r[t.charCodeAt(e+2)]<<6)+r[t.charCodeAt(e+3)];e+=4,n.push(255&o>>16),n.push(255&o>>8),n.push(255&o)}return n&&("="==t.charAt(e-2)?(n.pop(),n.pop()):"="==t.charAt(e-1)&&n.pop()),n},i={};i.encode=function(t){for(var e=[],r=0;r<t.length;++r)e.push(t.charCodeAt(r));return e},i.decode=function(){for(var t=0;t<s.length;++t)a[t]=String.fromCharCode(a[t]);return a.join("")},BASE64.encodeASCII=function(t){var r=i.encode(t);return e(r)},BASE64.decodeASCII=function(t){var e=n(t);return i.decode(e)},BASE64.encode=function(t){var r=UTF8.encode(t);return e(r)},BASE64.decode=function(t){var e=n(t);return UTF8.decode(e)}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),void 0===btoa)var btoa=BASE64.encode;if(void 0===atob)var atob=BASE64.decode;(function(){var t,e,r,n=function(t,e){return function(){return t.apply(e,arguments)}};t=function(){function t(){this.translate=n(this.translate,this),this.data={values:{},contexts:[]},this.globalContext={}}return t.prototype.translate=function(t,e,r,n,i){var o,s,a,l;return null==i&&(i=this.globalContext),a=function(t){var e;return e=typeof t,"function"===e||"object"===e&&!!t},a(e)?(o=null,l=null,s=e,i=r||this.globalContext):"number"==typeof e?(o=null,l=e,s=r,i=n||this.globalContext):(o=e,"number"==typeof r?(l=r,s=n,i=i):(l=null,s=r,i=n||this.globalContext)),a(t)?(a(t.i18n)&&(t=t.i18n),this.translateHash(t,i)):this.translateText(t,l,s,i,o)},t.prototype.add=function(t){var e,r,n,i,o,s,a,l;if(null!=t.values){s=t.values;for(r in s)n=s[r],this.data.values[r]=n}if(null!=t.contexts){for(a=t.contexts,l=[],i=0,o=a.length;o>i;i++)e=a[i],l.push(this.data.contexts.push(e));return l}},t.prototype.setContext=function(t,e){return this.globalContext[t]=e},t.prototype.clearContext=function(t){return this.lobalContext[t]=null},t.prototype.reset=function(){return this.data={values:{},contexts:[]},this.globalContext={}},t.prototype.resetData=function(){return this.data={values:{},contexts:[]}},t.prototype.resetContext=function(){return this.globalContext={}},t.prototype.translateHash=function(t,e){var r,n;for(r in t)n=t[r],"string"==typeof n&&(t[r]=this.translateText(n,null,null,e));return t},t.prototype.translateText=function(t,e,r,n,i){var o,s;return null==n&&(n=this.globalContext),null==this.data?this.useOriginalText(i||t,e,r):(o=this.getContextData(this.data,n),null!=o&&(s=this.findTranslation(t,e,r,o.values,i)),null==s&&(s=this.findTranslation(t,e,r,this.data.values,i)),null==s?this.useOriginalText(i||t,e,r):s)},t.prototype.findTranslation=function(t,e,r,n){var i,o,s,a,l;if(s=n[t],null==s)return null;if(null==e){if("string"==typeof s)return this.applyFormatting(s,e,r)}else if(s instanceof Array||s.length)for(a=0,l=s.length;l>a;a++)if(o=s[a],(e>=o[0]||null===o[0])&&(e<=o[1]||null===o[1]))return i=this.applyFormatting(o[2].replace("-%n",String(-e)),e,r),this.applyFormatting(i.replace("%n",String(e)),e,r);return null},t.prototype.getContextData=function(t,e){var r,n,i,o,s,a,l,u;if(null==t.contexts)return null;for(l=t.contexts,s=0,a=l.length;a>s;s++){r=l[s],n=!0,u=r.matches;for(i in u)o=u[i],n=n&&o===e[i];if(n)return r}return null},t.prototype.useOriginalText=function(t,e,r){return null==e?this.applyFormatting(t,e,r):this.applyFormatting(t.replace("%n",String(e)),e,r)},t.prototype.applyFormatting=function(t,e,r){var n,i;for(n in r)i=new RegExp("%{"+n+"}","g"),t=t.replace(i,r[n]);return t},t}(),r=new t,e=r.translate,e.translator=r,e.create=function(r){var n;return n=new t,null!=r&&n.add(r),n.translate.create=e.create,n.translate},("undefined"!=typeof module&&null!==module?module.exports=e:void 0)||(this.i18n=e)}).call(this),d20.utils={stattracker:{}},window.d20ext=window.d20ext||{},window.d20ext.utils=d20.utils,function(){void 0!==window.customcharsheet_translation&&(i18n.translator.add(JSON.parse(BASE64.decode(window.customcharsheet_translation))),console.log("Custom Sheet Translation")),"undefined"!=typeof JS_TRANSLATIONS&&i18n.translator.add({values:JS_TRANSLATIONS});var t={};d20.utils.htmlTranslator=function(e,r){if(""===e)return"";"undefined"==typeof r&&(r=!1);var n="jQuery";"string"==typeof e?(n="string",e=$(e)):e instanceof jQuery||(n="html",e=$(e));var i="[data-i18n],[data-i18n-placeholder],[data-i18n-title],[data-i18n-alt],[data-i18n-aria-label],[data-i18n-label]";switch(r&&(i+=",[data-i18n-dynamic]"),e.find(i).each(function(){var e=$(this),n=["-placeholder","-title","-alt","-aria-label","-label",""];r&&n.push("-dynamic"),$.each(n,function(){try{if("undefined"==typeof e.attr("data-i18n"+this))return;var n=""!==this?this.substr(1):!1,i=r&&"dynamic"===n,o=i?e.text():e.attr("data-i18n"+this),s=(e.attr("data-i18n-vars")||"").split("|"),a=n?"["+o+"]":'<span style="color: red;">['+o+"]</span>",l=i18n(o,a);if(t[o]=n?e.attr(n):e.html(),l=0===s.length?l:l.replace(/{{([0-9]+)}}/g,function(t,e){return s[e]?s[e]:"{{"+e+"}}"}),!n||i)return e.html(l),!1;e.attr(n,l)}catch(u){console.log("Translation Error:",u),console.log(e)}})}),window.i18nOutput=JSON.stringify(t),n){case"string":return e.prop("outerHTML");case"html":return e[0];default:return e}},d20.utils.playerZoneHeight=function(){var t=$("#playerzone .player").height()+65;return $("#macrobar").is(":visible")&&(t+=$("#macrobar").height()),console.log(t),t},d20.utils.strip_tags=function(t,e,r){r||void 0===e||(t=html_sanitize(t,function(t,e,r,n){var i=t.toString();if(n&&"a"===n.XML_TAG)return i;var o="https://s3.amazonaws.com/files.d20.io",s="http://imgsrv.roll20.net",a="https://imgsrv.roll20.net";return i.substring(0,o.length)===o||i.substring(0,s.length)===s||i.substring(0,a.length)===a?i:/^https?:\/\//.test(i)?"http://imgsrv.roll20.net/?src="+escape(i.replace("http://","").replace("https://","")):""},function(t){var e=t.split(" ");return _.each(e,function(t,r){e[r]="userscript-"===t.substring(0,11)||"sheet-"===t.substring(0,6)?t:"userscript-"+t}),e.join(" ")})),e=(((e||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var n=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,i=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return t.replace(i,"").replace(n,function(t,r){return e.indexOf("<"+r.toLowerCase()+">")>-1?t:""})},d20.utils.htmlAllowed="<code><span><div><label><a><br><br /><p><b><i><del><strike><u><img><video><audio><param><blockquote><mark><cite><small><ul><ol><li><hr><dl><dt><dd><sup><sub><big><pre><code><figure><figcaption><strong><em><table><tr><td><th><tbody><thead><tfoot><caption><h1><h2><h3><h4><h5><h6>",d20.utils.handleHTMLInput=function(t){return escape(d20.utils.strip_tags(d20.utils.autoLink(t),d20.utils.htmlAllowed))},d20.utils.handleHTMLOutput=function(t){return d20.utils.strip_tags(unescape(t),d20.utils.htmlAllowed)},d20.utils.showOverQuota=function(){var t=$("<div><p>We're sorry, but it looks like you've uploaded more than your allotted quota of storage space on Roll20. You can increase your quota by <a href='/account/supporter/?quotainapp' target='_blank'>becoming a Plus user</a> (or upgrading your Plus account if you already have one), or by <a href='http://help.roll20.net/sidebar-art-library/' target='_blank'>deleting items from your Art Library</a>.</div>");t.dialog({modal:!0,title:"Quota Exceeded",buttons:{"Upgrade Account":function(){window.open("/account/supporter/?quotainapp"),t.dialog("destroy")},"No Thanks":function(){t.dialog("destroy")}},beforeClose:function(){t.dialog("destroy")}})},d20.utils.showBadConvert=function(){var t=$("<div><p>There was an error trying to convert the PDF. Be sure you didn't specify an invalid page number. It's also possible the PDF is corrupted or isn't supported by our conversion software.</div>");t.dialog({modal:!0,title:"PDF Conversion Error",buttons:{"Drat!":function(){t.dialog("destroy")}},beforeClose:function(){t.dialog("destroy")}})},d20.utils.setupAvatar=function(t,e){t.bind("uploadcomplete",function(t,r){return t.stopPropagation(),"overquota"==r?(d20.utils.showOverQuota(),!1):(e.updateModel(),void e.model.save({avatar:r.base.replace("/original.","/med.")+(-1===r.base.indexOf("?")?"?"+Math.floor((new Date).getTime()/1e3):"")}))}),t.dndUploader({url:"/image_library/newupload",method:"POST",allowMultiple:!1}),t.bind("removeimage",function(){e.updateModel(),e.model.save({avatar:""})}),t.on("click",".remove",function(){t.trigger("removeimage")}),t.droppable({drop:function(e,r){console.log("Dropped onto avatar!"),e.originalEvent.dropHandled=!0,t.trigger("uploadcomplete",[{base:r.draggable.attr("data-fullsizeurl")},!0]),e.preventDefault(),e.stopPropagation()},greedy:!0,accept:".resultimage, .library-item"})};d20.utils.defaultRedactorSettings={minHeight:50,maxHeight:300,plugins:["fontcolor"],buttons:["formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent","|","table","link","|","alignment","|","horizontalrule","|"],convertDivs:!0,linebreaks:!0,tidyHtml:!1,dragUpload:!1},d20.utils.addCSSRules=function(t){var e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e),window.createPopup||e.appendChild(document.createTextNode(""));var r=document.styleSheets[document.styleSheets.length-1];for(selector in t)if(r.insertRule)try{r.insertRule(selector+t[selector],r.cssRules.length)}catch(n){}else try{r.addRule(selector,t[selector])}catch(n){console.log("Error addding rule!"),console.log(n)}},d20.utils.defaultDiceTokens={d4:["https://s3.amazonaws.com/files.d20.io/images/779542/DEYaBdP8w9B1CUSK26im0A/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779540/P7yKde5fyGZCB1ud70UOzA/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779539/AO4m-45bGw5yOcnZXUAn9g/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779541/oWA-hmBAHNAijceHr8k-3A/thumb.png?1363050056"],d6:["https://s3.amazonaws.com/files.d20.io/images/779533/-gS85HUaXIvmE5SjGpoH4w/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779535/vkc_PT4z-d_ON1MvfHaCiA/thumb.png?1363049999","https://s3.amazonaws.com/files.d20.io/images/779534/mHDadFirie4L12_ii-HYqQ/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779531/nXqp2BhdwVsQn7cDR3cMlg/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779532/nQD5_IXYLWN7YCjnd5zugA/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779536/ttiwwiWE2PVkhD2d7fV3GA/thumb.png?1363049999"],d8:["https://s3.amazonaws.com/files.d20.io/images/779514/GPCh5vqdSwvt_ANka3yhaw/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779517/nnuf1Pe2Fq70BIs9FGI7mQ/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779516/WnwuwT7yb5VM3-KiJY3GOg/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779515/Gx21buVd6d6onPsALrGFWQ/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779518/4LqfUGiX8sBXrX9b5gUnLw/thumb.png?1363049803","https://s3.amazonaws.com/files.d20.io/images/779519/YOR5Wav0-3-L1fm4vD-LFQ/thumb.png?1363049803","https://s3.amazonaws.com/files.d20.io/images/779522/dGFXXsEJz0EPA8dRpZvOzA/thumb.png?1363049804","https://s3.amazonaws.com/files.d20.io/images/779521/QXm6GcIhK6zTdMvJZVS8Og/thumb.png?1363049804"],d10:["https://s3.amazonaws.com/files.d20.io/images/779498/fjup5Fz4iV-TFKxV9z1Qtg/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779500/ug7m7g1rII05ZFzyTrkRmw/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779499/QNZR5kGieM1x00yQvSYYbg/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779497/tkz2552-MqV8a_woAD8S4A/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779501/xKjqIxXzibpcx3Lp7UH6qg/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779502/Bpc1QATzO293LvGS3neBsQ/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779504/Bpw24T8na0nJNFdTKZX5aw/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779503/ukQbc7uDKfl62ng2EO6h6g/thumb.png?1363049719","https://s3.amazonaws.com/files.d20.io/images/779505/23948Y6_O0Bc0RuIve3BbA/thumb.png?1363049719","https://s3.amazonaws.com/files.d20.io/images/779506/VhwbFVDm2KOte5h2p97n7w/thumb.png?1363049719"],d12:["https://s3.amazonaws.com/files.d20.io/images/779476/FRkaR6XvyzUuZb0ZB7ysCA/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779474/UyTKDHxf-fU1zC3w6udl0w/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779475/kUK2UmBaD2No00Gp4Q_OCQ/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779477/OVnJDjAkMPLk29hjpFjUvw/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779478/2la9taZk_vqdKItYZ6JEfA/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779479/fa8f9OVIBt79oETji8C8Lg/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779480/CTuw9Yiijq24ra3G9YMuPA/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779481/d4onnc7NOAbNG5JbiL9mbg/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779482/Oy2dTkB3-NlxiMsTRj78nw/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779483/mO_KU8nlO7GDQKc2J_aNeg/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779484/3MYG5dYJhiKXsRZtSUpHZw/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779485/VxA3umVDmYrH5A_VBecUIQ/thumb.png?1363049492"],d20:["https://s3.amazonaws.com/files.d20.io/images/779445/OfLXGnbkNr2qKg1Qqk4cPg/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779447/br4TdShbuMIZ-D-lyeXsKA/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779454/2ARsJLoP4tExbCWrRaaxQg/thumb.png?1363049318","https://s3.amazonaws.com/files.d20.io/images/779444/3pryVOKRxMCBisEHpH3LWg/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779446/Yk4sSF3eWfnpeJd4DQpV2A/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779450/tdvjVviFHhM_KxjFRQomhA/thumb.png?1363049316","https://s3.amazonaws.com/files.d20.io/images/779456/twbHlPq0CFjFCpAyS59CTQ/thumb.png?1363049319","https://s3.amazonaws.com/files.d20.io/images/779449/PPHDirZfEowhjBHxQdxJiw/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779448/1SpNrrunpHwrNbsKcqpCzQ/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779458/VsueBYqaDlvp9BjlXl9wMQ/thumb.png?1363049320","https://s3.amazonaws.com/files.d20.io/images/779451/nWqhH9iMimUAJh_9jOFEog/thumb.png?1363049316","https://s3.amazonaws.com/files.d20.io/images/779452/TvksvU6AZm2wmpEQ2HkBlQ/thumb.png?1363049317","https://s3.amazonaws.com/files.d20.io/images/779459/L4pwmqIbQk0TfaCMExrYxQ/thumb.png?1363049320","https://s3.amazonaws.com/files.d20.io/images/779453/MDmeMWOQ_lARfvFoT1n3KQ/thumb.png?1363049317","https://s3.amazonaws.com/files.d20.io/images/779460/my8VEGyYcJIHZN2uXP6QXQ/thumb.png?1363049321","https://s3.amazonaws.com/files.d20.io/images/779455/nuz5AefdQSB6H4mvUXoqhw/thumb.png?1363049318","https://s3.amazonaws.com/files.d20.io/images/779457/kQBunq7iXGmHNqZQCa5MCA/thumb.png?1363049319","https://s3.amazonaws.com/files.d20.io/images/779463/6n_z7Gwd7eacm3-HC-f-mg/thumb.png?1363049322","https://s3.amazonaws.com/files.d20.io/images/779462/aVz3qCe2QM2nWhn3BoT9rg/thumb.png?1363049321","https://s3.amazonaws.com/files.d20.io/images/779461/4PuFJYddJWJjj4uL5S3mxQ/thumb.png?1363049321"]};for(var e in d20.utils.defaultDiceTokens)d20.utils.defaultDiceTokens[e]=_.map(d20.utils.defaultDiceTokens[e],function(t){return escape(t+"")});d20.utils.hexToRgb=function(t){return t[4]||(t=t.replace(/./g,"$&$&").slice(1)),["0x"+t[1]+t[2]|0,"0x"+t[3]+t[4]|0,"0x"+t[5]+t[6]|0]};var r={},n=function(){console.log("Do refresh link cache!");var t={};d20.Campaign.characters.each(function(e){var r=e.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(r,"all")||window.currentPlayer&&-1!==_.indexOf(r,window.currentPlayer.id))&&(t[e.get("name").toLowerCase()]={type:"character",id:e.id})}),d20.Campaign.handouts.each(function(e){var r=e.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(r,"all")||window.currentPlayer&&-1!==_.indexOf(r,window.currentPlayer.id))&&(t[e.get("name").toLowerCase()]={type:"handout",id:e.id})}),r=t};d20.utils.refreshLinkCache=_.debounce(n,100),d20.utils.autoLink=function(t){var e=/\[[^\]]+\]/g;return t=t.replace(e,function(t){t=t.substring(1,t.length-1);var e=r[t.toLowerCase()];return e?"<a href='http://journal.roll20.net/"+e.type+"/"+e.id+"'>"+t+"</a>":"["+t+"]"})};var i=$("#textchat-notifier"),o=!1;d20.utils.textchatNotify=function(t,e){(o!==!0||e===!0)&&(t===!1?i.hide():i.show().text(t),e===!0&&(o=t!==!1?!0:!1))},d20.utils.getParentsUntil=function(t,e,r){var n=[];if(r)var i=r.charAt(0);for(;t&&t!==document&&(!e||e!==t);t=t.parentNode)r?("."===i&&t.classList.contains(r.substr(1))&&n.push(t),"#"===i&&t.id===r.substr(1)&&n.push(t),"["===i&&t.hasAttribute(r.substr(1,r.length-1))&&n.push(t),t.tagName.toLowerCase()===r&&n.push(t)):n.push(t);return n}}(),window.ucfirst=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},function(t,e,r){function n(e,r){this.element=e,this.options=t.extend({},o,r),this._defaults=o,this._name=i,this.init()}var i="addClear",o={closeSymbol:"&#10006;",color:"#CCC",top:-1,right:8,returnFocus:!0,showOnLoad:!1,onClear:null,hideOnBlur:!1,tabbable:!0};n.prototype={init:function(){var e,n=t(this.element),i=this,o=this.options;n.wrap("<span style='position:relative;' class='add-clear-span'></span>");var s=o.tabbable?"":" tabindex='-1'";e=t("<a href='#clear' style='display: none;'"+s+">"+o.closeSymbol+"</a>"),n.after(e),n.next().css({color:o.color,"text-decoration":"none",display:"none","line-height":1,overflow:"hidden",position:"absolute",right:o.right,top:o.top},this),n.val().length>=1&&o.showOnLoad===!0&&e.css({display:"block"}),n.focus(function(){t(this).val().length>=1&&e.css({display:"block"})}),n.blur(function(t){o.hideOnBlur&&setTimeout(function(){var n=t.relatedTarget||t.explicitOriginalTarget||r.activeElement;n!==e[0]&&e.css({display:"none"})},0)});var a=function(){e.css(t(this).val().length>=1?{display:"block"}:{display:"none"})},l=function(){n.off("keyup",a),n.off("cut",a),l=a,a.call(this)};n.on("keyup",a),n.on("cut",function(){var t=this;setTimeout(function(){a.call(t)},0)}),n.on("input",function(){l.call(this)}),o.hideOnBlur&&e.blur(function(){e.css({display:"none"})}),e.click(function(e){var r=t(i.element);r.val("").trigger("keyup"),t(this).css({display:"none"}),o.returnFocus===!0&&r.focus(),o.onClear&&o.onClear(r),e.preventDefault()})}},t.fn[i]=function(e){return this.each(function(){t.data(this,"plugin_"+i)||t.data(this,"plugin_"+i,new n(this,e))})}}(jQuery,window,document);var d20=d20||{};d20.DicePEG=function(){function quote(t){return'"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var result={parse:function(input,startRule){function padLeft(t,e,r){for(var n=t,i=r-t.length,o=0;i>o;o++)n=e+n;return n}function escape(t){var e,r,n=t.charCodeAt(0);return 255>=n?(e="x",r=2):(e="u",r=4),"\\"+e+padLeft(n.toString(16).toUpperCase(),"0",r)}function matchFailed(t){rightmostFailuresPos>pos||(pos>rightmostFailuresPos&&(rightmostFailuresPos=pos,rightmostFailuresExpected=[]),rightmostFailuresExpected.push(t))}function parse_start(){var t,e,r,n,i;if(n=pos,i=pos,t=parse_rollExpression(),null!==t){for(e=[],input.length>pos?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("any character"));null!==r;)e.push(r),input.length>pos?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("any character"));null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,r){return Array.isArray(e)||(e=[e]),""!==r&&(r=r.join(""),r.trim().length>0&&e.push(new Comment(r))),e}(n,t[0],t[1])),null===t&&(pos=n),t}function parse_rollExpression(){var t,e,r,n,i;return n=pos,i=pos,t=parse_rollExpressionPrimary(),null!==t?(e=parse_labelAwareRollOperator(),null!==e?(r=parse_rollExpression(),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r,n){var i=e;return i=mergeExpressions(i,r),i=mergeExpressions(i,n)}(n,t[0],t[1],t[2])),null===t&&(pos=n),null===t&&(n=pos,i=pos,t=parse_rollExpressionPrimary(),null!==t?(e=parse_inlineLabelWithSpace(),null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){return mergeExpressions(e,r)}(n,t[0],t[1])),null===t&&(pos=n),null===t&&(n=pos,i=pos,t=parse_inlineLabelWithSpace(),null!==t?(e=parse_rollExpression(),null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){return mergeExpressions(e,r)}(n,t[0],t[1])),null===t&&(pos=n),null===t&&(n=pos,t=parse_rollExpressionPrimary(),null!==t&&(t=function(t,e){return Array.isArray(e)||(e=[e]),e}(n,t)),null===t&&(pos=n)))),t}function parse_rollExpressionPrimary(){var t,e,r,n,i,o,s,a;return o=pos,s=pos,t=parse_fullRoll(),null!==t?(a=pos,reportFailures++,e=parse_validRollSuffix(),reportFailures--,null!==e?(e="",pos=a):e=null,null!==e?t=[t,e]:(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return e}(o,t[0])),null===t&&(pos=o),null===t&&(o=pos,s=pos,t=parse_rollGroup(),null!==t?(a=pos,reportFailures++,e=parse_validRollSuffix(),reportFailures--,null!==e?(e="",pos=a):e=null,null!==e?t=[t,e]:(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return e}(o,t[0])),null===t&&(pos=o),null===t&&(o=pos,t=parse_number(),null!==t&&(t=function(t,e){return new MathExpression(e)}(o,t)),null===t&&(pos=o),null===t&&(o=pos,s=pos,"floor("===input.substr(pos,6)?(t="floor(",pos+=6):(t=null,0===reportFailures&&matchFailed('"floor("')),null!==t?(e=parse__(),null!==e?(r=parse_rollExpression(),null!==r?(n=parse__(),null!==n?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("floor(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o),null===t&&(o=pos,s=pos,"ceil("===input.substr(pos,5)?(t="ceil(",pos+=5):(t=null,0===reportFailures&&matchFailed('"ceil("')),null!==t?(e=parse__(),null!==e?(r=parse_rollExpression(),null!==r?(n=parse__(),null!==n?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("ceil(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o),null===t&&(o=pos,s=pos,"round("===input.substr(pos,6)?(t="round(",pos+=6):(t=null,0===reportFailures&&matchFailed('"round("')),null!==t?(e=parse__(),null!==e?(r=parse_rollExpression(),null!==r?(n=parse__(),null!==n?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("round(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o),null===t&&(o=pos,s=pos,"abs("===input.substr(pos,4)?(t="abs(",pos+=4):(t=null,0===reportFailures&&matchFailed('"abs("')),null!==t?(e=parse__(),null!==e?(r=parse_rollExpression(),null!==r?(n=parse__(),null!==n?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("abs(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o),null===t&&(o=pos,s=pos,40===input.charCodeAt(pos)?(t="(",pos++):(t=null,0===reportFailures&&matchFailed('"("')),null!==t?(e=parse__(),null!==e?(r=parse_rollExpression(),null!==r?(n=parse__(),null!==n?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o)))))))),t}function parse_validRollSuffix(){var t,e;return t=parse___(),null===t&&(t=parse_inlineLabelWithSpace(),null===t&&(125===input.charCodeAt(pos)?(t="}",pos++):(t=null,0===reportFailures&&matchFailed('"}"')),null===t&&(44===input.charCodeAt(pos)?(t=",",pos++):(t=null,0===reportFailures&&matchFailed('","')),null===t&&(41===input.charCodeAt(pos)?(t=")",pos++):(t=null,0===reportFailures&&matchFailed('")"')),null===t&&(e=pos,reportFailures++,t=parse_operator(),reportFailures--,null!==t?(t="",pos=e):t=null,null===t&&(e=pos,reportFailures++,input.length>pos?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("any character")),reportFailures--,null===t?t="":(t=null,pos=e))))))),t}function parse_rollGroup(){var t,e,r,n,i,o,s,a;return s=pos,a=pos,123===input.charCodeAt(pos)?(t="{",pos++):(t=null,0===reportFailures&&matchFailed('"{"')),null!==t?(e=parse__(),null!==e?(r=parse_rollGroupExpression(),null!==r?(n=parse__(),null!==n?(125===input.charCodeAt(pos)?(i="}",pos++):(i=null,0===reportFailures&&matchFailed('"}"')),null!==i?(o=parse_groupMods(),o=null!==o?o:"",null!==o?t=[t,e,r,n,i,o]:(t=null,pos=a)):(t=null,pos=a)):(t=null,pos=a)):(t=null,pos=a)):(t=null,pos=a)):(t=null,pos=a),null!==t&&(t=function(t,e,r){return new GroupExpression(e,r)}(s,t[2],t[5])),null===t&&(pos=s),t}function parse_rollGroupExpression(){var t,e,r,n,i,o,s;return o=pos,s=pos,t=parse_rollExpression(),null===t&&(t=parse_rollGroup()),null!==t?(e=parse__(),null!==e?(44===input.charCodeAt(pos)?(r=",",pos++):(r=null,0===reportFailures&&matchFailed('","')),null!==r?(n=parse__(),null!==n?(i=parse_rollGroupExpression(),null!==i?t=[t,e,r,n,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e,r){return Array.isArray(e)||(e=[e]),""!==r?[e].concat(r):e}(o,t[0],t[4])),null===t&&(pos=o),null===t&&(o=pos,t=parse_rollExpression(),null===t&&(t=parse_rollGroup()),null!==t&&(t=function(t,e){return[e]}(o,t)),null===t&&(pos=o)),t}function parse_labelAwareRollOperator(){var t,e,r,n,i;if(n=pos,i=pos,t=parse_rollOperator(),null!==t){for(e=[],r=parse_rollOperator(),null===r&&(r=parse_inlineLabelWithSpace());null!==r;)e.push(r),r=parse_rollOperator(),null===r&&(r=parse_inlineLabelWithSpace());null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,r){for(var n=e,i=0;i<r.length;i++)n=mergeExpressions(n,r[i]);return n}(n,t[0],t[1])),null===t&&(pos=n),null===t&&(n=pos,i=pos,t=parse_inlineLabelWithSpace(),null!==t?(e=parse_labelAwareRollOperator(),null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){return mergeExpressions(e,r)}(n,t[0],t[1])),null===t&&(pos=n)),t}function parse_rollOperator(){var t,e,r,n,i,o,s,a,l;return a=pos,l=pos,t=parse__(),null!==t?(e=parse_operator(),null!==e?(r=parse__(),null!==r?(n=parse_mathExpressionPrimary(),null!==n?(i=parse__(),null!==i?(o=parse_rollOperator(),null!==o?(s=parse__(),null!==s?t=[t,e,r,n,i,o,s]:(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=function(t,e,r,n){return e+r+n}(a,t[1],t[3],t[5])),null===t&&(pos=a),null===t&&(a=pos,l=pos,t=parse__(),null!==t?(e=parse_operator(),null!==e?(r=parse__(),null!==r?t=[t,e,r]:(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=function(t,e){return e}(a,t[1])),null===t&&(pos=a)),t}function parse_fullRoll(){var t,e,r,n,i;return n=pos,i=pos,t=parse_coreRoll(),null!==t?(e=parse_rollMods(),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){return""!==r&&(e.mods=r),e}(n,t[0],t[1])),null===t&&(pos=n),null===t&&(n=pos,i=pos,t=parse_numberOfDice(),null!==t?("t"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"t"')),null!==e?(r=parse_inlineLabel(),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){return new TableRollExpression(e,r.text)}(n,t[0],t[2])),null===t&&(pos=n)),t}function parse_coreRoll(){var t,e,r,n,i;return n=pos,i=pos,t=parse_numberOfDice(),null!==t?("d"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"d"')),null!==e?("f"===input.substr(pos,1).toLowerCase()?(r=input.substr(pos,1),pos++):(r=null,0===reportFailures&&matchFailed('"f"')),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e){return new FateRollExpression(e)}(n,t[0])),null===t&&(pos=n),null===t&&(n=pos,i=pos,t=parse_numberOfDice(),null!==t?("d"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"d"')),null!==e?(r=parse_numberOfSides(),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){return new RollExpression(e,r)}(n,t[0],t[2])),null===t&&(pos=n)),t}function parse_numberOfDice(){var result0,result1,result2,result3,result4,pos0,pos1;return result0=parse_integer(),null===result0&&(pos0=pos,pos1=pos,40===input.charCodeAt(pos)?(result0="(",pos++):(result0=null,0===reportFailures&&matchFailed('"("')),null!==result0?(result1=parse__(),null!==result1?(result2=parse_mathExpression(),null!==result2?(result3=parse__(),null!==result3?(41===input.charCodeAt(pos)?(result4=")",pos++):(result4=null,0===reportFailures&&matchFailed('")"')),null!==result4?result0=[result0,result1,result2,result3,result4]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,expr){return Math.round(eval("("+expr+")"))}(pos0,result0[2])),null===result0&&(pos=pos0),null===result0&&(pos0=pos,result0="",null!==result0&&(result0=function(){return 1}(pos0)),null===result0&&(pos=pos0))),result0}function parse_numberOfSides(){var result0,result1,result2,result3,result4,pos0,pos1;return result0=parse_integer(),null===result0&&(pos0=pos,pos1=pos,40===input.charCodeAt(pos)?(result0="(",pos++):(result0=null,0===reportFailures&&matchFailed('"("')),null!==result0?(result1=parse__(),null!==result1?(result2=parse_mathExpression(),null!==result2?(result3=parse__(),null!==result3?(41===input.charCodeAt(pos)?(result4=")",pos++):(result4=null,0===reportFailures&&matchFailed('")"')),null!==result4?result0=[result0,result1,result2,result3,result4]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,expr){return Math.round(eval("("+expr+")"))}(pos0,result0[2])),null===result0&&(pos=pos0),null===result0&&(pos0=pos,"f"===input.substr(pos,1).toLowerCase()?(result0=input.substr(pos,1),pos++):(result0=null,0===reportFailures&&matchFailed('"f"')),null!==result0&&(result0=function(){return"F"}(pos0)),null===result0&&(pos=pos0))),result0}function parse_groupMods(){var t,e,r,n,i;if(n=pos,i=pos,t=parse_keepMod(),null===t&&(t=parse_dropMod(),null===t&&(t=parse_multipleMod(),null===t&&(t=parse_successMod()))),null!==t){for(e=[],r=parse_groupMods();null!==r;)e.push(r),r=parse_groupMods();null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,r){return processMods(e,r)}(n,t[0],t[1])),null===t&&(pos=n),t}function parse_rollMods(){var t,e,r,n,i;if(n=pos,i=pos,t=parse_compoundingMod(),null===t&&(t=parse_penetratingMod(),null===t&&(t=parse_explodingMod(),null===t&&(t=parse_keepMod(),null===t&&(t=parse_dropMod(),null===t&&(t=parse_rerollOnceMod(),null===t&&(t=parse_rerollMod(),null===t&&(t=parse_customCritMod(),null===t&&(t=parse_customFumbleMod(),null===t&&(t=parse_sortMod(),null===t&&(t=parse_successMod())))))))))),null!==t){for(e=[],r=parse_rollMods();null!==r;)e.push(r),r=parse_rollMods();
null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,r){return processMods(e,r)}(n,t[0],t[1])),null===t&&(pos=n),t}function parse_explodingMod(){var t,e,r,n;return r=pos,n=pos,33===input.charCodeAt(pos)?(t="!",pos++):(t=null,0===reportFailures&&matchFailed('"!"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=n)):(t=null,pos=n),null!==t&&(t=function(t,e){return{exploding:e}}(r,t[1])),null===t&&(pos=r),t}function parse_compoundingMod(){var t,e,r,n;return r=pos,n=pos,"!!"===input.substr(pos,2)?(t="!!",pos+=2):(t=null,0===reportFailures&&matchFailed('"!!"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=n)):(t=null,pos=n),null!==t&&(t=function(t,e){return{compounding:e}}(r,t[1])),null===t&&(pos=r),t}function parse_penetratingMod(){var t,e,r,n,i;return n=pos,i=pos,33===input.charCodeAt(pos)?(t="!",pos++):(t=null,0===reportFailures&&matchFailed('"!"')),null!==t?("p"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"p"')),null!==e?(r=parse_comparisonPoint(),r=null!==r?r:"",null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e){return{penetrating:e}}(n,t[2])),null===t&&(pos=n),t}function parse_keepMod(){var t,e,r,n,i;return n=pos,i=pos,"k"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"k"')),null!==t?(/^['h'|'l']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['h'|'l']i")),e=null!==e?e:"",null!==e?(r=parse_integer(),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){return{keep:{end:e.toLowerCase()||"h",count:r}}}(n,t[1],t[2])),null===t&&(pos=n),t}function parse_dropMod(){var t,e,r,n,i;return n=pos,i=pos,"d"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"d"')),null!==t?(/^['h'|'l']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['h'|'l']i")),e=null!==e?e:"",null!==e?(r=parse_integer(),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){return{drop:{end:e.toLowerCase()||"l",count:r}}}(n,t[1],t[2])),null===t&&(pos=n),t}function parse_customCritMod(){var t,e,r,n,i;return n=pos,i=pos,"cs"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"cs"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?(r=parse_customCritMod(),r=null!==r?r:"",null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){var n={customCrit:""!==e?[e]:[{}]};return""!==r&&(n.customCrit=n.customCrit.concat(r.customCrit)),n}(n,t[1],t[2])),null===t&&(pos=n),t}function parse_customFumbleMod(){var t,e,r,n,i;return n=pos,i=pos,"cf"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"cf"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?(r=parse_customFumbleMod(),r=null!==r?r:"",null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){var n={customFumble:""!==e?[e]:[{}]};return""!==r&&(n.customFumble=n.customFumble.concat(r.customFumble)),n}(n,t[1],t[2])),null===t&&(pos=n),t}function parse_rerollMod(){var t,e,r,n,i;return n=pos,i=pos,"r"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"r"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?(r=parse_rerollMod(),r=null!==r?r:"",null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){var n={reroll:""!==e?[e]:[{}]};return""!==r&&(n.reroll=n.reroll.concat(r.reroll)),n}(n,t[1],t[2])),null===t&&(pos=n),t}function parse_rerollOnceMod(){var t,e,r,n,i;return n=pos,i=pos,"ro"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"ro"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?(r=parse_rerollMod(),r=null!==r?r:"",null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){var n={reroll:""!==e?[e]:[{}]};return""!==r&&(n.reroll=n.reroll.concat(r.reroll)),n.reroll&&n.reroll[0]&&(n.reroll[0].maxrerolls=1),n}(n,t[1],t[2])),null===t&&(pos=n),t}function parse_sortMod(){var t,e,r,n;return r=pos,n=pos,"s"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"s"')),null!==t?(/^['a'|'d']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['a'|'d']i")),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=n)):(t=null,pos=n),null!==t&&(t=function(t,e){return{sort:{order:e.toLowerCase()||"a"}}}(r,t[1])),null===t&&(pos=r),t}function parse_floorMod(){var t,e;return e=pos,"flr"===input.substr(pos,3)?(t="flr",pos+=3):(t=null,0===reportFailures&&matchFailed('"flr"')),null!==t&&(t=function(){return{round:{type:"floor"}}}(e)),null===t&&(pos=e),t}function parse_multipleMod(){var t,e,r,n;return r=pos,n=pos,"x"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"x"')),null!==t?(e=parse_integer(),null!==e?t=[t,e]:(t=null,pos=n)):(t=null,pos=n),null!==t&&(t=function(t,e){return{multiple:{times:e}}}(r,t[1])),null===t&&(pos=r),t}function parse_successMod(){var t,e,r,n,i,o;return n=pos,i=pos,t=parse_comparisonPoint(),null!==t?(o=pos,"f"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"f"')),null!==e?(r=parse_comparisonPoint(),null!==r?e=[e,r]:(e=null,pos=o)):(e=null,pos=o),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,r){var n={success:e};return""!==r&&(n.failure=r[1]),n}(n,t[0],t[1])),null===t&&(pos=n),t}function parse_comparisonPoint(){var t,e,r,n;return r=pos,n=pos,t=parse_comparison(),t=null!==t?t:"",null!==t?(e=parse_integer(),null!==e?t=[t,e]:(t=null,pos=n)):(t=null,pos=n),null!==t&&(t=function(t,e,r){return{comp:(""==e?"=":e)+"=",point:r}}(r,t[0],t[1])),null===t&&(pos=r),t}function parse_comparison(){var t;return/^[>|<|=]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[>|<|=]")),t}function parse_mathExpression(){var t,e,r,n,i,o,s,a,l;return a=pos,l=pos,t=parse__(),null!==t?(e=parse_mathExpressionPrimary(),null!==e?(r=parse__(),null!==r?(n=parse_operator(),null!==n?(i=parse__(),null!==i?(o=parse_mathExpression(),null!==o?(s=parse__(),null!==s?t=[t,e,r,n,i,o,s]:(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=function(t,e,r,n){return e+r+n}(a,t[1],t[3],t[5])),null===t&&(pos=a),null===t&&(a=pos,l=pos,t=parse__(),null!==t?(e=parse_mathExpressionPrimary(),null!==e?(r=parse__(),null!==r?t=[t,e,r]:(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=function(t,e){return e}(a,t[1])),null===t&&(pos=a)),t}function parse_mathExpressionPrimary(){var t,e,r,n,i,o,s;return o=pos,s=pos,t=parse__(),null!==t?(e=parse_number(),null!==e?(r=parse__(),null!==r?t=[t,e,r]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return e}(o,t[1])),null===t&&(pos=o),null===t&&(o=pos,s=pos,40===input.charCodeAt(pos)?(t="(",pos++):(t=null,0===reportFailures&&matchFailed('"("')),null!==t?(e=parse__(),null!==e?(r=parse_mathExpression(),null!==r?(n=parse__(),null!==n?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,r,n,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return"("+e+")"}(o,t[2])),null===t&&(pos=o)),t}function parse_inlineLabelWithSpace(){var t,e,r,n,i;return n=pos,i=pos,t=parse__(),null!==t?(e=parse_inlineLabel(),null!==e?(r=parse__(),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e){return e}(n,t[1])),null===t&&(pos=n),t}function parse_inlineLabel(){var t,e,r,n,i;if(n=pos,i=pos,91===input.charCodeAt(pos)?(t="[",pos++):(t=null,0===reportFailures&&matchFailed('"["')),null!==t){for(e=[],/^[^\]]/.test(input.charAt(pos))?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("[^\\]]"));null!==r;)e.push(r),/^[^\]]/.test(input.charAt(pos))?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("[^\\]]"));null!==e?(93===input.charCodeAt(pos)?(r="]",pos++):(r=null,0===reportFailures&&matchFailed('"]"')),null!==r?t=[t,e,r]:(t=null,pos=i)):(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e){return new Label(e.join(""))}(n,t[1])),null===t&&(pos=n),t}function parse_operator(){var t;return/^[+|\-|*|\/|%]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[+|\\-|*|\\/|%]")),t}function parse_number(){var t;return t=parse_exponent(),null===t&&(t=parse_float(),null===t&&(t=parse_signedInteger())),t}function parse_integer(){var t,e,r;if(r=pos,/^[0-9]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[0-9]")),null!==e)for(t=[];null!==e;)t.push(e),/^[0-9]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[0-9]"));else t=null;return null!==t&&(t=function(t,e){return parseInt(e.join(""),10)}(r,t)),null===t&&(pos=r),t}function parse_signedInteger(){var t,e,r,n;return r=pos,n=pos,/^[+|\-]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[+|\\-]")),t=null!==t?t:"",null!==t?(e=parse_integer(),null!==e?t=[t,e]:(t=null,pos=n)):(t=null,pos=n),null!==t&&(t=function(t,e,r){return"-"==e?-1*r:r}(r,t[0],t[1])),null===t&&(pos=r),t}function parse_float(){var t,e,r,n,i,o;if(i=pos,o=pos,t=parse_signedInteger(),t=null!==t?t:"",null!==t)if(46===input.charCodeAt(pos)?(e=".",pos++):(e=null,0===reportFailures&&matchFailed('"."')),null!==e){if(/^[0-9]/.test(input.charAt(pos))?(n=input.charAt(pos),pos++):(n=null,0===reportFailures&&matchFailed("[0-9]")),null!==n)for(r=[];null!==n;)r.push(n),/^[0-9]/.test(input.charAt(pos))?(n=input.charAt(pos),pos++):(n=null,0===reportFailures&&matchFailed("[0-9]"));else r=null;null!==r?t=[t,e,r]:(t=null,pos=o)}else t=null,pos=o;else t=null,pos=o;return null!==t&&(t=function(t,e,r){return 0===e&&0>1/e?-1*parseFloat(e+"."+r.join("")):parseFloat(e+"."+r.join(""))}(i,t[0],t[2])),null===t&&(pos=i),t}function parse_exponent(){var t,e,r,n,i,o,s;return o=pos,s=pos,t=parse_signedInteger(),t=null!==t?t:"",null!==t?(46===input.charCodeAt(pos)?(e=".",pos++):(e=null,0===reportFailures&&matchFailed('"."')),null!==e?(r=parse_integer(),null!==r?(101===input.charCodeAt(pos)?(n="e",pos++):(n=null,0===reportFailures&&matchFailed('"e"')),null!==n?(i=parse_signedInteger(),null!==i?t=[t,e,r,n,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e,r,n){return parseFloat(e+"."+r+"e"+n)}(o,t[0],t[2],t[4])),null===t&&(pos=o),null===t&&(o=pos,s=pos,t=parse_signedInteger(),null!==t?(101===input.charCodeAt(pos)?(e="e",pos++):(e=null,0===reportFailures&&matchFailed('"e"')),null!==e?(r=parse_signedInteger(),null!==r?t=[t,e,r]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e,r){return parseFloat(e+"e"+r)}(o,t[0],t[2])),null===t&&(pos=o)),t}function parse__(){var t,e,r;for(r=pos,t=[],/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));null!==e;)t.push(e),/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));return null!==t&&(t=function(t,e){return e.join("")}(r,t)),null===t&&(pos=r),t}function parse___(){var t,e,r;if(r=pos,/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]")),null!==e)for(t=[];null!==e;)t.push(e),/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));else t=null;return null!==t&&(t=function(t,e){return e.join("")}(r,t)),null===t&&(pos=r),t}function cleanupExpected(t){t.sort();for(var e=null,r=[],n=0;n<t.length;n++)t[n]!==e&&(r.push(t[n]),e=t[n]);return r}function computeErrorPosition(){for(var t=1,e=1,r=!1,n=0;n<Math.max(pos,rightmostFailuresPos);n++){var i=input.charAt(n);"\n"===i?(r||t++,e=1,r=!1):"\r"===i||"\u2028"===i||"\u2029"===i?(t++,e=1,r=!0):(e++,r=!1)}return{line:t,column:e}}function log(t){console.log(t)}function MathExpression(t){this.type=d20.dice.TYPE_MATH_EXPR,this.expr=void 0!=t?t:""}function RollExpression(t,e){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.sides=e,this.mods={}}function FateRollExpression(t){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.fate=!0,this.mods={}}function TableRollExpression(t,e){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.table=e,this.mods={}}function GroupExpression(t,e){this.type=d20.dice.TYPE_GROUP_EXPR,this.rolls=t,this.mods=e||{}}function Label(t){this.type=d20.dice.TYPE_LABEL,this.text=t}function Comment(t){this.type=d20.dice.TYPE_COMMENT,this.text=t}function mergeExpressions(t,e){if("string"==typeof t){if(0==t.length)return e;t=new MathExpression(t)}if("string"==typeof e){if(0==e.length)return t;e=new MathExpression(e)}if(Array.isArray(t)&&Array.isArray(e)){if(t[t.length-1].type==d20.dice.TYPE_MATH_EXPR&&e[0].type==d20.dice.TYPE_MATH_EXPR){var r=t.pop();e[0].expr=r.expr+e[0].expr}return t.concat(e)}return Array.isArray(t)?(t[t.length-1].type==d20.dice.TYPE_MATH_EXPR&&e.type==d20.dice.TYPE_MATH_EXPR?t[t.length-1].expr+=e.expr:t.push(e),t):Array.isArray(e)?(e[0].type==d20.dice.TYPE_MATH_EXPR&&t.type==d20.dice.TYPE_MATH_EXPR?e[0].expr=t.expr+e[0].expr:e.unshift(t),e):t.type==d20.dice.TYPE_MATH_EXPR&&e.type==d20.dice.TYPE_MATH_EXPR?(t.expr+=e.expr,t):[t,e]}function processMods(t,e){var r=t;if(e.length>0)for(var n in e[0]){if(void 0!=r[n])throw{message:"'"+n+"' roll modifier can only be specified once"};r[n]=e[0][n]}return r}var parseFunctions={start:parse_start,rollExpression:parse_rollExpression,rollExpressionPrimary:parse_rollExpressionPrimary,validRollSuffix:parse_validRollSuffix,rollGroup:parse_rollGroup,rollGroupExpression:parse_rollGroupExpression,labelAwareRollOperator:parse_labelAwareRollOperator,rollOperator:parse_rollOperator,fullRoll:parse_fullRoll,coreRoll:parse_coreRoll,numberOfDice:parse_numberOfDice,numberOfSides:parse_numberOfSides,groupMods:parse_groupMods,rollMods:parse_rollMods,explodingMod:parse_explodingMod,compoundingMod:parse_compoundingMod,penetratingMod:parse_penetratingMod,keepMod:parse_keepMod,dropMod:parse_dropMod,customCritMod:parse_customCritMod,customFumbleMod:parse_customFumbleMod,rerollMod:parse_rerollMod,rerollOnceMod:parse_rerollOnceMod,sortMod:parse_sortMod,floorMod:parse_floorMod,multipleMod:parse_multipleMod,successMod:parse_successMod,comparisonPoint:parse_comparisonPoint,comparison:parse_comparison,mathExpression:parse_mathExpression,mathExpressionPrimary:parse_mathExpressionPrimary,inlineLabelWithSpace:parse_inlineLabelWithSpace,inlineLabel:parse_inlineLabel,operator:parse_operator,number:parse_number,integer:parse_integer,signedInteger:parse_signedInteger,"float":parse_float,exponent:parse_exponent,_:parse__,__:parse___};if(void 0!==startRule){if(void 0===parseFunctions[startRule])throw new Error("Invalid rule name: "+quote(startRule)+".")}else startRule="start";var pos=0,reportFailures=0,rightmostFailuresPos=0,rightmostFailuresExpected=[],d20="undefined"!=typeof window&&void 0!==window.d20?window.d20:{};void 0==d20.dice&&(d20.dice=d20.dice||{},d20.dice.TYPE_MATH_EXPR="M",d20.dice.TYPE_ROLL_EXPR="R",d20.dice.TYPE_GROUP_EXPR="G",d20.dice.TYPE_LABEL="L",d20.dice.TYPE_COMMENT="C",d20.dice.TYPE_VALIDATED_ROLLS="V");var result=parseFunctions[startRule]();if(null===result||pos!==input.length){var offset=Math.max(pos,rightmostFailuresPos),found=offset<input.length?input.charAt(offset):null,errorPosition=computeErrorPosition();throw new this.SyntaxError(cleanupExpected(rightmostFailuresExpected),found,offset,errorPosition.line,errorPosition.column)}return result},toSource:function(){return this._source}};return result.SyntaxError=function(t,e,r,n,i){function o(t,e){var r,n;switch(t.length){case 0:r="end of input";break;case 1:r=t[0];break;default:r=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return n=e?quote(e):"end of input","Expected "+r+" but "+n+" found."}this.name="SyntaxError",this.expected=t,this.found=e,this.message=o(t,e),this.offset=r,this.line=n,this.column=i},result.SyntaxError.prototype=Error.prototype,result}(),d20.dice_formatter={},d20ext.dice_formatter=d20.dice_formatter,function(){var t=function(){},e=function(r){for(var n="",i=0;i<r.length;i++){if(r[i].type===d20.dice.TYPE_GROUP_EXPR){console.log("Descending into madness..."),n+="{<div class='parsegroup'>";for(var o=0;o<r[i].rolls.length;o++)n+="<div class='parsegroupitem ",r[i].results&&r[i].results[o].d&&(n+="dropped"),n+="'>",n+=e(r[i].rolls[o]),o+1<r[i].rolls.length&&(n+=" + "),n+="</div>";n+="</div>}"}if(r[i].type===d20.dice.TYPE_ROLL_EXPR){n+="<div class='dicegrouping' data-groupindex='"+i+"' ",r[i+1]&&r[i+1].type==d20.dice.TYPE_LABEL&&(n+="title='"+r[i+1].text.replace(/'/g,"&apos;")+"'"),n+=">",n+="(";for(var s=0;s<r[i].results.length;s++){n+="<div data-origindex='"+s+"' class='diceroll ",r[i].results.length>50&&(n+="withouticons "),r[i].fate?n+="d6":r[i].table||(n+="d"+r[i].sides),r[i].results[s].d===!0&&(n+=" dropped ");var a=!1,l=!1;if(r[i].mods&&r[i].mods.customCrit?_.each(r[i].mods.customCrit,function(t){"<="===t.comp?r[i].results[s].v<=t.point&&(a=!0):">="===t.comp?r[i].results[s].v>=t.point&&(a=!0):"=="===t.comp&&r[i].results[s].v===t.point&&(a=!0)}):r[i].results[s].v===r[i].sides&&(a=!0),a&&(n+=" critsuccess ",t()),r[i].mods&&r[i].mods.customFumble?_.each(r[i].mods.customFumble,function(t){"<="===t.comp?r[i].results[s].v<=t.point&&(l=!0):">="===t.comp?r[i].results[s].v>=t.point&&(l=!0):"=="===t.comp&&r[i].results[s].v===t.point&&(l=!0)}):1===r[i].results[s].v&&r[i].fate!==!0&&(l=!0),l&&(n+=" critfail "),n+="'><div class='dicon'><div class='didroll'>",r[i].fate===!0)switch(r[i].results[s].v){case 1:n+="+";break;case 0:n+="0";break;case-1:n+="-"}else n+=r[i].results[s].tableItem?r[i].results[s].tableItem.avatar&&""!=r[i].results[s].tableItem.avatar?"<img src='"+r[i].results[s].tableItem.avatar+"' title='"+d20ext.utils.strip_tags(r[i].results[s].tableItem.name).replace(/'/g,"&apos;")+"' />":d20ext.utils.strip_tags(r[i].results[s].tableItem.name):r[i].results[s].v;n+="</div><div class='backing'></div></div>",r[i].fate!==!0&&s+1<r[i].results.length&&(n+="+"),n+="</div>"}n+=")",n+="</div>"}else r[i].type===d20.dice.TYPE_MATH_EXPR&&(n+=r[i].expr)}return n},r=function(t){if(t){for(var e="",n=0;n<t.length;n++){if(t[n].type===d20.dice.TYPE_GROUP_EXPR){console.log("Descending into madness..."),e+="{";for(var i=0;i<t[n].rolls.length;i++)e+=r(t[n].rolls[i]),i+1<t[n].rolls.length&&(e+="+");e+="}"}if(t[n].type===d20.dice.TYPE_ROLL_EXPR){var o=void 0!==t[n].results?t[n].results.length:0;e+="(";for(var s=0;o>s;s++){if(e+="<span class='basicdiceroll",t[n].results[s].d)e+=" dropped";else{var a=!1,l=!1;t[n].mods&&t[n].mods.customCrit?_.each(t[n].mods.customCrit,function(e){"<="===e.comp?t[n].results[s].v<=e.point&&(a=!0):">="===e.comp?t[n].results[s].v>=e.point&&(a=!0):"=="===e.comp&&t[n].results[s].v===e.point&&(a=!0)}):t[n].results[s].v===t[n].sides&&(a=!0),a&&(e+=" critsuccess "),t[n].mods&&t[n].mods.customFumble?_.each(t[n].mods.customFumble,function(e){"<="===e.comp?t[n].results[s].v<=e.point&&(l=!0):">="===e.comp?t[n].results[s].v>=e.point&&(l=!0):"=="===e.comp&&t[n].results[s].v===e.point&&(l=!0)}):1===t[n].results[s].v&&t[n].fate!==!0&&(l=!0),l&&(e+=" critfail ")}if(e+="'>",t[n].fate===!0)switch(t[n].results[s].v){case 1:e+="+";break;case 0:e+="0";break;case-1:e+="-"}else e+=t[n].results[s].tableItem?d20ext.utils.strip_tags(t[n].results[s].tableItem.name):t[n].results[s].v;e+="</span>",t[n].fate!==!0&&s+1<t[n].results.length&&(e+="+")}e+=")"}else t[n].type===d20.dice.TYPE_MATH_EXPR&&(e+=t[n].expr)}return e}};d20.dice_formatter.checkForCrits=function(t,e){if(!t)return!1;for(var r=!1,n=!1,i=0;i<t.length;i++){if(t[i].type===d20.dice.TYPE_GROUP_EXPR)for(var o=0;o<t[i].rolls.length;o++)d20.dice_formatter.checkForCrits(t[i].rolls[o],e)===!0&&("crit"===e?r=!0:n=!0);if(t[i].type===d20.dice.TYPE_ROLL_EXPR)for(var s=void 0!==t[i].results?t[i].results.length:0,a=0;s>a;a++)t[i].results[a].d!==!0&&(t[i].mods&&t[i].mods.customCrit?_.each(t[i].mods.customCrit,function(e){"<="===e.comp?t[i].results[a].v<=e.point&&(r=!0):">="===e.comp?t[i].results[a].v>=e.point&&(r=!0):"=="===e.comp&&t[i].results[a].v===e.point&&(r=!0)}):t[i].results[a].v===t[i].sides&&(r=!0),t[i].mods&&t[i].mods.customFumble?_.each(t[i].mods.customFumble,function(e){"<="===e.comp?t[i].results[a].v<=e.point&&(n=!0):">="===e.comp?t[i].results[a].v>=e.point&&(n=!0):"=="===e.comp&&t[i].results[a].v===e.point&&(n=!0)}):1===t[i].results[a].v&&t[i].fate!==!0&&(n=!0))}return"crit"===e?r:n},d20.dice_formatter.getHtmlForResult=function(t){var r=e(t.rolls);return{formula:r,total:t.total+(t.resultType===d20.dice.ROLL_TYPE_SUCCESS?" Successes":"")}},d20.dice_formatter.replaceInlineRolls=function(t,e,n){return t=d20.utils.strip_tags(t,n),e.inlinerolls?t=t.replace(/\$\[\[[0-9]+\]\]/g,function(t){var i=t.substring(3,t.length-1),o=e.inlinerolls[parseInt(i,10)];if(!o||!o.results)return"INVALID INLINE ROLL!";o.expression=o.expression.replace("<","&lt;");var s="Rolling "+d20.utils.strip_tags(o.expression,n)+" = ";o.signature&&d20.textchat.verifyRoll(o.rollid,o.results,o.signature)&&(s="<img src='/images/quantumrollwhite.png' class='inlineqroll'> "+s),s+=r(o.results.rolls);var a=o.results.total;try{0==a&&o.results.rolls[0].results[0].tableItem&&(a=d20ext.utils.strip_tags(o.results.rolls[0].results[0].tableItem.name))}catch(l){}var u="<span class='inlinerollresult showtip tipsy-n",c=-1!==s.indexOf("critsuccess"),p=-1!==s.indexOf("critfail");return c&&p?u+=" importantroll":c?u+=" fullcrit":p&&(u+=" fullfail"),u+="' title='"+s.replace(/'/g,"&quot;")+"'>"+a+"</span>"}):t};var n={"@":"critsuccess","#":"critfail",_:"dropped"},i=function(t,e){for(var r in n){var o=new RegExp("\\{"+r+"(.+?)"+r+"\\}","g");if(null!=(match=o.exec(t)))return e.push(n[r]),i(match[1],e)}return t};d20.dice_formatter.oldformat=function(t){return void 0===t?"":t.replace(/\{([@#_])(.+?)\1\}/g,function(t,e,r){var o=[n[e]],r=i(r,o);return"<span class='"+o.sort().join(" ")+"'>"+r+"</span>"})}}();var d20=d20||{};d20.dice_engine=function(seed){function TaskCompletionCallback(t,e,r){var n=0,i=!1;this.taskComplete=function(){if(n==t)throw"All "+n+" tasks have already been completed for: "+r;n++,n==t&&(i=!0,e())},this.verify=function(){n!=t||i||e()}}function RollResult(t){this.i=t,this.v=0}function GroupResult(t){this.v=t}function ValidatedRollExpression(t,e){this.type=d20.dice.TYPE_VALIDATED_ROLLS,this.rolls=t,this.resultType=e}function ExpressionBuilder(){var expression="",groupMemeberCount=void 0,verifyInGroup=function(){if(void 0==groupMemeberCount)throw"Not currently in a group expression: '"+expression+"'"};this.addMathExpr=function(t){expression+=t},this.startGroup=function(){expression+="(",groupMemeberCount=0},this.addGroupValue=function(t){verifyInGroup(),groupMemeberCount>0&&(expression+="+"),expression+=t,groupMemeberCount++},this.addGroupSuccess=function(t,e){this.addGroupValue("("+t+e.comp+e.point+"?1:0)")},this.addGroupFailure=function(t,e){this.addGroupValue("("+t+e.comp+e.point+"?-1:0)")},this.endGroup=function(){verifyInGroup(),0==groupMemeberCount&&(expression+="0"),expression+=")",groupMemeberCount=void 0},this.eval=function(){log(expression);var result,thisexp=expression;return function(){"use strict";var floor=Math.floor,ceil=Math.ceil,round=Math.round,max=Math.max,min=Math.min,abs=Math.abs;try{result=eval(thisexp)}catch(e){result=0}}(),result}}d20.dice=d20.dice||{},d20.dice.TYPE_MATH_EXPR="M",d20.dice.TYPE_ROLL_EXPR="R",d20.dice.TYPE_GROUP_EXPR="G",d20.dice.TYPE_LABEL="L",d20.dice.TYPE_COMMENT="C",d20.dice.TYPE_VALIDATED_ROLLS="V",d20.dice.ROLL_TYPE_SUCCESS="success",d20.dice.ROLL_TYPE_TABLE="table",d20.dice.ROLL_TYPE_SUM="sum",void 0==d20.getTableElementCount&&(d20.getTableElementCount=function(t){return log("Using fallback getTableElementCount("+t+")"),t.length},d20.getTableElementValue=function(t,e){return log("Using fallback getTableElementValue("+t+", "+e+")"),parseInt(t,10)||0});var MAX_NUM_ROLLS=999,MAX_ROLL=9999999;console.log("Initializing new dice engine with randomness..."),void 0==seed?(console.log("Using random entropy"),Math.seedrandom(window.RANDOM_ENTROPY,!0)):Math.seedrandom(seed),this.random=Math.randomInt;var othis=this,log=function(t){},logerr=function(t){_.isFunction(t)&&(t=t()),console.log(t)},fallbackErrorHandler=function(t){throw logerr(t),t},diceRollToString=function(t){var e=t.dice+"d"+t.sides;return t.mods.compounding&&(e+="!!"+comparePointToString(t.mods.compounding)),t.mods.penetrating&&(e+="!p"+comparePointToString(t.mods.penetrating)),t.mods.exploding&&(e+="!"+comparePointToString(t.mods.exploding)),t.mods.keep&&(e+="k","h"!=t.mods.keep.end&&(e+=t.mods.keep.end),e+=t.mods.keep.count),t.mods.drop&&(e+="k","l"!=t.mods.drop.end&&(e+=t.mods.drop.end),e+=t.mods.drop.count),t.mods.reroll&&t.mods.reroll.forEach(function(t){e+="r"+comparePointToString(t)}),t.mods.sort&&(e+="s"+t.mods.sort.order),t.mods.success&&(e+=comparePointToString(t.mods.success,!0)),t.mods.failure&&(e+="f"+comparePointToString(t.mods.failure,!0)),e},comparePointToString=function(t,e){var r="";return t.point&&(("=="!=t.comp||e)&&(r+=t.comp.charAt(0)),r+=t.point),r},validateParseResult=function(t){for(var e=void 0,r=0;r<t.length;r++){if(t[r].type==d20.dice.TYPE_ROLL_EXPR||t[r].type==d20.dice.TYPE_GROUP_EXPR){var n=getRollType(t[r]);if(void 0==e)e=n;else if(e!=n)throw"Cannot mix "+e+" and "+n+" rolls in a single roll expression"}if(t[r].type==d20.dice.TYPE_ROLL_EXPR){if(t[r].fate?t[r].sides=3:void 0!=t[r].table&&(t[r].sides=d20.getTableElementCount(t[r].table)),t[r].fate&&void 0!=t[r].mods.compounding)throw"Compounding FATE dice are not legal, try ! instead of !! for exploding FATE dice";if(t[r].mods&&void 0!=t[r].mods.exploding&&t[r].sides<2)throw"You must roll a d2 or higher to roll exploding dice.";t[r].dice=Math.max(Math.min(t[r].dice,MAX_NUM_ROLLS),0),t[r].sides=Math.max(Math.min(t[r].sides,MAX_ROLL),0)}if(t[r].type==d20.dice.TYPE_GROUP_EXPR){if(1==t[r].rolls.length&&e==d20.dice.ROLL_TYPE_SUCCESS)for(var i=!1,o=0;o<t[r].rolls[0].length;o++)if(t[r].rolls[0][o].type==d20.dice.TYPE_ROLL_EXPR){if(i)throw"Only one roll expression is allowed in a single sub-roll expression success check";i=!0}else if(t[r].rolls[0][o].type==d20.dice.TYPE_GROUP_EXPR)throw t[r].rolls[0][o].type+" expression is not supported in a single sub-roll expression success check";for(var s=void 0,a=0;a<t[r].rolls.length;a++){var l=validateParseResult(t[r].rolls[a]);if(void 0==s)s=l;else if(s!=l)throw"Cannot mix "+s+" and "+l+" rolls in a  roll group"}t[r].resultType=s}}if(void 0==e){if(t[0].type===d20.dice.TYPE_MATH_EXPR)return d20.dice.TYPE_MATH_EXPR;throw"Could not determine result type of: "+JSON.stringify(t)}return e},getRollType=function(t){return t.mods&&void 0!==t.mods.success?d20.dice.ROLL_TYPE_SUCCESS:void 0!=t.sides&&t.sides.type==d20.dice.TYPE_LABEL?d20.dice.ROLL_TYPE_TABLE:d20.dice.ROLL_TYPE_SUM},parseRollString=function(t){log(function(){return"E parseRollString: "+t});var e=d20.DicePEG.parse(t);log(e);var r=validateParseResult(e),n=new ValidatedRollExpression(e,r);return log(n),log(JSON.stringify(n)),log(function(){return"L parseRollString: "+n.rolls.length+" expressions from: "+t}),n},initiateRolls=function(t,e,r){for(var n=0;n<t.length;n++)t[n].type==d20.dice.TYPE_ROLL_EXPR?doRolls(t[n],r):t[n].type==d20.dice.TYPE_GROUP_EXPR?initiateGroupRolls(t[n],e,r):r()},initiateGroupRolls=function(t,e,r){for(var n=new TaskCompletionCallback(t.rolls.length,function(){postProcessCompleteGroup(t,e),r()},"groupCompleteCallback"),i=0;i<t.rolls.length;i++)initiateSubGroupRolls(t.rolls[i],t.resultType,n)},initiateSubGroupRolls=function(t,e,r){var n=new TaskCompletionCallback(t.length,function(){r.taskComplete()},"subGroupCompleteCallback");initiateRolls(t,e,function(){n.taskComplete()})},doRolls=function(t,e){log(function(){return diceRollToString(t)+"	 - E doRolls"}),t.results=[];for(var r=new TaskCompletionCallback(t.dice,function(){diceRollCompleteCallback(t),e()},"rollCompleteCallback"),n=function(){r.taskComplete()},i=0;i<t.dice;i++)rollDie(i,t,n);r.verify(),log(function(){return diceRollToString(t)+"	 - L doRolls"})},diceRollCompleteCallback=function(t){if(log(function(){return diceRollToString(t)+"	 - E diceRollCompleteCallback"}),t.results.sort(function(t,e){var r=t.i-e.i;return 0!=r||t.d==e.d?r:t.d?-1:1}),t.results.forEach(function(t){delete t.i}),t.mods&&void 0!=t.mods.keep){var e="l"==t.mods.keep.end?"a":"d",r=sortRolls(t.results,e);keepRolls(r,t.mods.keep.count)}if(t.mods&&void 0!=t.mods.drop){var e="l"==t.mods.drop.end?"a":"d",r=sortRolls(t.results,e);dropRolls(r,t.mods.drop.count)}t.mods&&void 0!=t.mods.sort&&(t.results=sortRolls(t.results,t.mods.sort.order)),log(function(){return diceRollToString(t)+"	 - L diceRollCompleteCallback"})},postProcessCompleteGroup=function(t,e){if(log(function(){return"E postProcessCompleteGroup("+e+")"}),t.mods&&void 0!=t.mods.keep&&1==t.rolls.length){var r="l"==t.mods.keep.end?"a":"d",n=buildSubGroupRollsArray(t.rolls[0]);n=sortRolls(n,r),keepRolls(n,t.mods.keep.count),cleanupSubGroupValues(t.rolls[0])}if(t.mods&&void 0!=t.mods.drop&&1==t.rolls.length){var r="l"==t.mods.drop.end?"a":"d",n=buildSubGroupRollsArray(t.rolls[0]);n=sortRolls(n,r),dropRolls(n,t.mods.drop.count),cleanupSubGroupValues(t.rolls[0])}if(totalResult(t,e),t.mods&&void 0!=t.mods.keep&&t.rolls.length>1){var r="l"==t.mods.keep.end?"a":"d",i=sortRolls(t.results,r);keepRolls(i,t.mods.keep.count)}if(t.mods&&void 0!=t.mods.drop&&t.rolls.length>1){var r="l"==t.mods.drop.end?"a":"d",i=sortRolls(t.results,r);dropRolls(i,t.mods.drop.count)}log(function(){return"L postProcessCompleteGroup"})},buildSubGroupRollsArray=function(t){for(var e=[],r=0;r<t.length;r++)t[r].type==d20.dice.TYPE_ROLL_EXPR?e=e.concat(t[r].results):t[r].type==d20.dice.TYPE_GROUP_EXPR&&(t[r].v=totalResult(t[r],t[r].resultType).eval(),e.push(t[r]));return e},cleanupSubGroupValues=function(t){t.forEach(function(t){t.type==d20.dice.TYPE_GROUP_EXPR&&delete t.v})},keepRolls=function(t,e){for(var r=0,n=0;n<t.length;n++)t[n].d||(e>r?r++:t[n].d=!0)},dropRolls=function(t,e){for(var r=0,n=0;n<t.length&&e>r;n++)t[n].d||(t[n].d=!0,r++)},sortRolls=function(t,e){var r="d"==e?-1:1;return t.slice(0).sort(function(t,e){return(t.v-e.v)*r})},asyncRand=function(t,e,r,n){if(0===t)setTimeout(function(){e(0)},0);else{if("undefined"==typeof Firebase&&d20.tddice&&d20.tddice.canRoll3D()&&!r)return void d20.tddice.roller(t,e,n);if(6===t&&d20.textchat&&d20.textchat.egg_clickhole&&!$("#lightly-overlay").is(":visible")){var i=[["2990",1,4],["2991",1,7],["2992",1,12],["2993",2,7],["2994",2,5],["2995",2,38],["2996",2,11],["2997",3,13],["2998",3,16],["2999",3,6],["3000",3,16],["3001",4,17],["3002",4,18],["3003",4,16],["3004",5,7],["3006",5,24],["3005",5,14],["3007",5,27],["3008",6,7],["3009",6,6],["3010",6,5],["3012",6,10]],o=i[othis.random(i.length)];d20.textchat.sendShout({type:"playclickhole",playerid:window.currentPlayer.id,content:o,time:(new Date).getTime()}),window.fakeLightly&&window.fakeLightly("http://v.theonion.com/onionstudios/video/"+o[0]+"/640.mp4"),setTimeout(function(){e(o[1]),$("#lightly-overlay").hide()},1e3*o[2]+2e3)}else setTimeout(function(){e(othis.random(t)+1)},0)}},compareToPoint=function(value,cp,defaultPoint){if(void 0!=cp.comp){var cpFormula=value+cp.comp+cp.point,cpResult=eval(cpFormula);return cpResult}return value==defaultPoint},rollDie=function(t,e,r,n){var i=new RollResult(t);e.results.push(i),function(t){asyncRand(e.sides,function(i){individualRollCallback(e,t,i,r,n)},void 0!==e.table,e.rollid)}(i)},individualRollCallback=function(t,e,r,n,i){if(i=i||0,log(function(){return diceRollToString(t)+"	 - E individualRollCallback("+i+") "+r}),void 0!==t.table?(e.tableidx=r-1,e.v+=d20.getTableElementValue(t.table,e.tableidx)):e.v+=r,t.fate&&(e.v-=2),t.mods&&void 0!=t.mods.penetrating&&i>0&&(e.v-=1),i>MAX_NUM_ROLLS)n();else if(t.mods&&void 0!=t.mods.exploding&&compareToPoint(r,t.mods.exploding,t.sides))rollDie(e.i,t,n,i+1);else if(t.mods&&void 0!=t.mods.compounding&&compareToPoint(r,t.mods.compounding,t.sides))asyncRand(t.sides,function(r){individualRollCallback(t,e,r,n,i+1)},void 0!==t.table,t.rollid);else if(t.mods&&void 0!=t.mods.penetrating&&compareToPoint(r,t.mods.penetrating,t.sides))rollDie(e.i,t,n,i+1);
else if(t.mods&&void 0!=t.mods.reroll){var o=t.mods.reroll.some(function(o){if(o.maxrerolls)for(var s=0,a=0;a<t.results.length;a++)t.results[a].i===e.i&&t.results[a].d===!0&&s++;return compareToPoint(r,o,1)?o.maxrerolls&&s>=o.maxrerolls?!1:(e.d=!0,rollDie(e.i,t,n,i+1),!0):!1});o||n()}else n();log(function(){return diceRollToString(t)+"	 - L individualRollCallback("+i+") "+r})},postProcessCompleteRolls=function(t,e,r){if(log(function(){return"E postProcessCompleteRolls"}),t.type==d20.dice.TYPE_VALIDATED_ROLLS){var n=postProcessCompleteRolls(t.rolls,t.resultType);return t.total=n,n}var i=totalResults(t,e,r);return log(function(){return"L postProcessCompleteRolls - "+i}),i},totalResults=function(t,e,r,n){for(var n=n||new ExpressionBuilder,n=new ExpressionBuilder,i=0;i<t.length;i++)totalResult(t[i],e,r,n);return n.eval()},totalResult=function(t,e,r,n){var n=n||new ExpressionBuilder;if(t.type==d20.dice.TYPE_ROLL_EXPR){n.startGroup();for(var i=0;i<t.results.length;i++)t.results[i].d||addResultValue(n,e,t.results[i].v,t);n.endGroup()}else if(t.type==d20.dice.TYPE_MATH_EXPR)n.addMathExpr(t.expr);else if(t.type==d20.dice.TYPE_GROUP_EXPR){if(n.startGroup(),!t.d)if(void 0==t.results||r)if(t.results=[],1==t.rolls.length&&e==d20.dice.ROLL_TYPE_SUCCESS){for(var o="",s=void 0,a="",l=0;l<t.rolls[0].length;l++)if(t.rolls[0][l].type==d20.dice.TYPE_ROLL_EXPR){if(void 0!=s)throw"Only one roll expression is allowed in a single sub-roll expression success check";s=t.rolls[0][l]}else if(t.rolls[0][l].type==d20.dice.TYPE_MATH_EXPR)void 0==s?o+=t.rolls[0][l].expr:a+=t.rolls[0][l].expr;else if(t.rolls[0][l].type==d20.dice.TYPE_GROUP_EXPR)throw t.rolls[0][l].type+" expression is not supported in a single sub-roll expression success check";for(var l=0;l<s.results.length;l++)if(!s.results[l].d){var u=new ExpressionBuilder;u.startGroup(),u.addMathExpr(o),u.addGroupValue(s.results[l].v),u.addMathExpr(a),u.endGroup(),t.results.push(new GroupResult(u.eval()))}}else for(var c=0;c<t.rolls.length;c++){var p=totalResults(t.rolls[c],t.resultType,r);t.results.push(new GroupResult(p)),addResultValue(n,e,p,t)}else t.results.forEach(function(r){r.d||addResultValue(n,e,r.v,t)});n.endGroup()}return n},addResultValue=function(t,e,r,n){if(e==d20.dice.ROLL_TYPE_SUM)t.addGroupValue(r);else{if(e!=d20.dice.ROLL_TYPE_SUCCESS)throw"Unsupported resultType: "+e;t.addGroupSuccess(r,n.mods.success),n.mods&&void 0!=n.mods.failure&&t.addGroupFailure(r,n.mods.failure)}};this.reprocess=function(t,e,r){r=r||fallbackErrorHandler;try{postProcessCompleteRolls(t,void 0,!0),e(t)}catch(n){r(n)}};var remoteRollQueue=[],remoteRollCallbacks={},performRemoteRoll=function(t,e,r,n,i){remoteRollQueue.push({vre:t,rollid:e,rolltype:r}),remoteRollCallbacks[e]={success:n,error:i},debounced_doRemoteRollRequest()},_doRemoteRollRequest=function(){if(0!==remoteRollQueue.length)if(!window.is_playerapp&&window.currentPlayer.get("tddiceenabled")&&window.currentPlayer.get("disableagency")===!1){if($("#tdagencyoverlay").is(":visible"))return;$("#tdagencyoverlay").show(),numberofdice=remoteRollQueue[0].vre.rolls[0].dice?remoteRollQueue[0].vre.rolls[0].dice:1,d20.tddice.playsound("dicecup",numberofdice);var t={},e=$("#tdagencyoverlay svg line"),r=!1;$("#tdagencyoverlay").on("mousedown",function(n){t.startx=n.clientX/$(window).width(),t.starty=n.clientY/$(window).height(),e.attr("x1",n.clientX).attr("y1",n.clientY).attr("x2",n.clientX).attr("y2",n.clientY),r=!0}),$("#tdagencyoverlay").on("mousemove",function(n){if(r){xdist=Math.abs(t.startx-n.clientX/$(window).width()),ydist=Math.abs(t.starty-n.clientY/$(window).height());var i=Math.sqrt(xdist*xdist+ydist*ydist);.2>i?e.css("stroke","rgb(255,255,255)"):.5>i?e.css("stroke","rgb(245,238,44)"):e.css("stroke","rgb(245,44,44)"),e.attr("x2",n.clientX).attr("y2",n.clientY)}}),$("#tdagencyoverlay").on("mouseup",function(r){$("#tdagencyoverlay").off().hide(),e.attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0),t.startx?(t.stopx=r.clientX/$(window).width(),t.stopy=r.clientY/$(window).height(),_posthookrollrequest(t)):_posthookrollrequest()})}else setTimeout(function(){_posthookrollrequest()},50)},_posthookrollrequest=function(t){if(0!==remoteRollQueue.length){var e={cid:window.campaign_storage_path,fbnum:window.FIREBASE_ROOT,authkey:window.GNTKN,pid:window.currentPlayer.id,rolls:remoteRollQueue,use3d:window.currentPlayer.get(window.is_playerapp?"apptddiceenabled":"tddiceenabled")};if(t){var r={x:t.startx-t.stopx,y:t.starty-t.stopy};mindistance=.01,maxdistance=.3,Math.abs(r.x)<mindistance&&(r.x=r.x<0?-mindistance:mindistance),Math.abs(r.y)<mindistance&&(r.y=r.y<0?-mindistance:mindistance),Math.abs(r.x)>maxdistance&&(r.x=r.x<0?-maxdistance:maxdistance),Math.abs(r.y)>maxdistance&&(r.y=r.y<0?-maxdistance:maxdistance),e.deltas={x:80*r.x*-1,y:80*r.y*1}}else e.use3d===!0&&(e.deltas={x:10*Math.random()-5,y:20});$.ajax({url:"https://app.roll20.net/doroll",type:"POST",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){var e=t;for(var r in e)if(void 0==e[r].error){var n=JSON.parse(e[r].json);postProcessCompleteRolls(n),remoteRollCallbacks[r].success(n,r,e[r].signature,e[r].tdseed),d20.tutorial&&void 0!==e[r].shoutjson&&d20.tddice.remoteRoll(JSON.parse(e[r].shoutjson))}else remoteRollCallbacks[r].error("There was an error fetching your roll. "+e[r].error)},error:function(){console.log("Error fetching from QuantumRoll, fallback to local rolls."),_.each(e.rolls,function(t){var e=t.vre,r=new TaskCompletionCallback(e.rolls.length,function(){postProcessCompleteRolls(e),setTimeout(function(){remoteRollCallbacks[t.rollid].success(e,null,!1)},0)},"wholeRollCompleteCallback");initiateRolls(e.rolls,e.resultType,function(){r.taskComplete()})})}}),remoteRollQueue=[]}};this.flushRemoteQueue=function(){_doRemoteRollRequest()};var debounced_doRemoteRollRequest=_.debounce(_doRemoteRollRequest,100);return this.process=function(t,e,r){r=r||fallbackErrorHandler;try{var n=parseRollString(t);if(0==n.rolls)throw"There were no dice to roll!";var i=!1,o=!1,s=0,a=function(t){if(s++,void 0!==t)for(var e=0;e<t.length;e++)if(void 0!==t[e].table&&(i=!0),"R"===t[e].type&&(o=!0),(!i||!o)&&99>s&&void 0!==t[e].rolls&&t[e].rolls.length>0)for(var r=0;r<t[e].rolls.length;r++)a(t[e].rolls[r])};try{a(n.rolls)}catch(l){console.log("Error while checking for table existence. Ignoring.")}if(a=null,d20.textchat&&d20.textchat.egg_clickhole&&(i=!0),"undefined"==typeof Firebase||i===!0||o===!1){var u=new TaskCompletionCallback(n.rolls.length,function(){postProcessCompleteRolls(n),setTimeout(function(){e(n,null,!1)},0)},"wholeRollCompleteCallback");initiateRolls(n.rolls,n.resultType,function(){u.taskComplete()})}else if("undefined"==typeof $){var c=generateUUID(),p={vre:n,cid:CAMPAIGNID,fbnum:"https://"+FIREBASENUM+".firebaseio.com/",pid:"api",rid:c,use3d:!1,authkey:FIREBASETOKEN,rolltype:d20.textchat.currentRollType};request.post({url:"https://app.roll20.net/doroll",body:p,json:!0,timeout:5e3},function(t,n,i){if(t||200!=n.statusCode||""===i)r("There was an error communicating with the QuantumRoll server.");else{var o=i;if(void 0!==o.error)return void r("There was an error fetching your roll. "+o.error);var s=JSON.parse(o.json);postProcessCompleteRolls(s),e(s,c,o.signature)}})}else{var c=generateUUID();performRemoteRoll(n,c,d20.textchat.currentRollType,e,r)}}catch(l){r(l)}},this.handleRollReq=function(t,e){var r=new TaskCompletionCallback(t.rolls.length,function(){try{postProcessCompleteRolls(t)}catch(r){return void e({error:"There was an error processing this roll."})}setTimeout(function(){e(t)},0)},"wholeRollCompleteCallback");try{initiateRolls(t.rolls,t.resultType,function(){r.taskComplete()})}catch(n){e({error:"There was an error processing this roll."})}},this.handleRollString=function(t){var e=parseRollString(t);if(0==e.rolls)throw"There were no dice to roll!";return e},this},d20.textchat={commandhistory:[],commandIndex:0,currentRollType:"rollresult",commandInProgress:!1,lastChatBeep:0,talktomyself:!1,allowed3drolls:[],globalrolled:0,egg_clickhole:!1},$(function(){var t,e,r,n="",i=0,o=!0,s=!1,a=!1,l={},u={};d20.textchat.tabIsFocused=!0,d20.dice_engine&&(d20.textchat.diceengine=new d20.dice_engine),$(window).bind("focus",function(){o=!0}),$(window).bind("blur",function(){o=!1}),d20.textchat.$textarea=$("#textchat-input textarea"),d20.textchat.$speakingas=$("#speakingas"),d20.textchat.$textchat=$("#textchat");var c=new X509;c.readCertPEM("-----BEGIN CERTIFICATE-----MIICtTCCAl+gAwIBAgIJAJtwle/qkHJnMA0GCSqGSIb3DQEBBQUAMHIxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJLUzEQMA4GA1UEBxMHV2ljaGl0YTEPMA0GA1UEChMGUm9sbDIwMRMwEQYDVQQDEwpyb2xsMjAubmV0MR4wHAYJKoZIhvcNAQkBFg90ZWFtQHJvbGwyMC5uZXQwHhcNMTQwMzAzMTgwMTQ4WhcNMTQwNDAyMTgwMTQ4WjByMQswCQYDVQQGEwJVUzELMAkGA1UECBMCS1MxEDAOBgNVBAcTB1dpY2hpdGExDzANBgNVBAoTBlJvbGwyMDETMBEGA1UEAxMKcm9sbDIwLm5ldDEeMBwGCSqGSIb3DQEJARYPdGVhbUByb2xsMjAubmV0MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALJq8muAFnZMkJysXg9VJsevoQxtxV1NytYvCKHTtaCja/tyeLTRei0nu+NymPfNKKiRhv7R8D33oZLvIA/udusCAwEAAaOB1zCB1DAdBgNVHQ4EFgQUarGxVvODYDpzS5OKyKsTyCEmDSUwgaQGA1UdIwSBnDCBmYAUarGxVvODYDpzS5OKyKsTyCEmDSWhdqR0MHIxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJLUzEQMA4GA1UEBxMHV2ljaGl0YTEPMA0GA1UEChMGUm9sbDIwMRMwEQYDVQQDEwpyb2xsMjAubmV0MR4wHAYJKoZIhvcNAQkBFg90ZWFtQHJvbGwyMC5uZXSCCQCbcJXv6pByZzAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBBQUAA0EAjBHayltU3K4DCs2h4nC2quGGKzGE2h1nMCBzhQ1ed+vir+lLnWQvAOrqt50Nx7lMk+23uFGhGMysK2UyrqptMw==-----END CERTIFICATE-----");var p=/\/((roll)|(r)|(gmroll)|(gr))[ ]+/i,h=function(t,e){if(t.content=t.content+"",null!==t.content.match(p)){var r="rollresult";null!==t.content.match(/\/((gmroll)|(gr))[ ]+/i)&&(r="gmrollresult"),d20.textchat.currentRollType=r;try{var n=t.content.replace(p,"");n=n.replace(/\$\[\[[0-9]+\]\]/g,function(e){var r=e.substring(3,e.length-1),n=t.inlinerolls[parseInt(r,10)];return n?n.results.total:"INVALID INLINE ROLL"});var i=function(t,e){var r=0,n=!1;return e>99?void console.log("Too many subgroups, abort."):(_.each(t,function(t){if("G"===t.type)_.each(t.rolls,function(t){var o=i(t,e+1);void 0!==o&&(r+=o,n=!0)});else if(t.table){var o=d20.Campaign.rollabletables.findTableByName(t.table),s=o.getWeightedArray();o&&_.each(t.results,function(t){n=!0,t.tableItem=o.tableitems.get(s[t.tableidx]).toJSON(),void 0===t.d&&(r+=t.v)})}else t.results&&_.each(t.results,function(t){return t.d?!0:void(r+=t.v)})}),n?r:void 0)};d20.utils.textchatNotify("Rolling the dice..."),d20.textchat.diceengine.process(n,function(n,o,s,a){if(d20.textchat.globalrolled++,d20.utils.textchatNotify(!1),n.error){var l={who:"error",type:"error",content:n.error};d20.textchat.incoming(!1,l)}else{if(n.rolls&&n.rolls.length>0)try{var u=i(n.rolls,0);void 0!==u&&(s=null)}catch(c){console.log("ERROR matching table"),console.log(c)}var h={who:d20.textchat.$speakingas.find("option:selected").text(),type:r,content:JSON.stringify(n),signature:s,origRoll:t.content.replace(p,""),playerid:window.currentPlayer.id,avatar:t.avatar,_fbid:o};a&&(h.tdseed=a),t.opts&&t.opts.tracker&&g(t.currentSelected,n,t.opts.tracker),e(h)}},function(t){console.log(t);var e={who:"error",type:"error",content:"string"==typeof t?t:"There was an error with your formula. Please try again."};d20.textchat.incoming(!1,e),d20.utils.textchatNotify(!1)})}catch(o){console.log(o);var s={who:"error",type:"error",content:"string"==typeof o?o:"There was an error with your formula. Please try again."};d20.textchat.incoming(!1,s)}}else if("/em "===t.content.substring(0,4)||"/e "==t.content.substring(0,3)||"/me "==t.content.substring(0,4)){var a=t.content.replace("/em ","").replace("/e ","").replace("/me ",""),l={who:d20.textchat.$speakingas.find("option:selected").text(),type:"emote",content:a,playerid:window.currentPlayer.id,avatar:t.avatar};e(l)}else if("/ooc "===t.content.substring(0,5)||"/o "===t.content.substring(0,3)){var u=t.content.replace("/ooc ","").replace("/o ",""),l={who:d20.textchat.$speakingas.find("option:first-child").text(),type:"general",playerid:window.currentPlayer.id,content:u,avatar:"/users/avatar/"+window.currentPlayer.get("d20userid")+"/30"};e(l)}else if(window.is_gm&&"/as "===t.content.substring(0,4)){var u=t.content.substring(4,t.content.length),c=u.match(/\w+|"[^"]+"/);if(null==c||!c.length)throw'Invalid. Try /as "Name of Character" <message>';u=u.substring(c[0].length,u.length);var l={who:'"'===c[0][0]?c[0].substring(1,c[0].length-1):c[0],type:"general",playerid:window.currentPlayer.id,content:u};e(l)}else if(window.is_gm&&"/emas "===t.content.substring(0,6)){var u=t.content.substring(6,t.content.length),c=u.match(/\w+|"[^"]+"/);if(null==c||!c.length)throw'Invalid. Try /as "Name of Character" <message>';u=u.substring(c[0].length,u.length);var l={who:'"'===c[0][0]?c[0].substring(1,c[0].length-1):c[0],type:"emote",playerid:window.currentPlayer.id,content:u};e(l)}else if(window.is_gm&&"/desc "===t.content.substring(0,6)){var u=t.content.substring(6,t.content.length),l={who:"",type:"desc",playerid:window.currentPlayer.id,content:u};e(l)}else if("/w "===t.content.substring(0,3)){var h=t.content.split(" "),m=h.slice(2,h.length),v=/\"([^"]+)\"/i,y=h[1],b=function(t,e){return t.split(" ")[0].toLowerCase()===e.toLowerCase()};if('"'===h[1].substring(0,1)){var w=v.exec(t.content);w&&(y=w[1],m=t.content.replace(v,function(){return""}).split(" ").slice(1,h.length),b=function(t,e){return t.toLowerCase()===e.toLowerCase()})}var x=0;if("gm"==y.toLowerCase()&&(x="gm",targetname="GM"),0==x&&d20.Campaign.players.each(function(t){b(t.get("displayname"),y)&&(x=t.id,targetname=t.get("displayname"))}),0==x&&d20.Campaign.characters.each(function(t){b(t.get("name"),y)&&(t.get("controlledby")&&""!=t.get("controlledby")?(x=t.get("controlledby"),targetname=t.get("name")):(x="gm",targetname="GM"))}),0==x){var s={who:"error",type:"error",content:"Unable to find a player or character with name: "+y};return void d20.textchat.incoming(!1,s)}var S=m.join(" "),l={who:d20.textchat.$speakingas.find("option:selected").text(),type:"whisper",target:x,target_name:targetname,playerid:window.currentPlayer.id,content:S,avatar:t.avatar};e(l)}else if("/say "==t.content.substring(0,5)){var E=t.content.replace("/say ",""),T=d20.textchat.$speakingas.val();if(t.content=E,e(l),-1===T.indexOf("character|"))return;{T.split("|")[1]}}else if("/fx "==t.content.substring(0,4)){var A=t.content.split(" "),C=!1,y=t.currentSelected,P=!1,R=A[1],L=R.indexOf("-")>-1?R.split("-")[0]:R;if(d20.fx.presetEffects[L])-1===d20.fx.presetEffects[L].angle&&(C=!0);else if(window.Campaign.custFx){var M=window.Campaign.custFx.filter(function(t){return t.get("name").toLowerCase()===L.toLowerCase()})[0];if(M){R=M.id;var k=window.Campaign.custFx.get(R).get("definition");-1===k.angle&&(C=!0)}}if(-1===R.indexOf("|")?R+="|duration:25":-1===R.indexOf("duration")&&(R+=",duration:25"),A.length>2){var x=A[2];y=d20.Campaign.activePage().thegraphics.get(x).view.graphic}if(A.length>3){var B=A[3];P=d20.Campaign.activePage().thegraphics.get(B).view.graphic}if(y){var I=y.left,O=y.top;if(C)if(P){var H={};H.distance=f(P.left-y.left,P.top-y.top),H.angle=d(P.left-y.left,P.top-y.top),d20.fx.spawnFx(I,O,R,H)}else d20.fx.agencyFx(function(t){d20.fx.spawnFx(I,O,R,t)},I,O);else d20.fx.spawnFx(I,O,R)}else{var s={who:"error",type:"error",content:"The /fx command requires a selected token or token ID, but none was provided. Select a token and try again."};d20.textchat.incoming(!1,s)}e("noop")}else if("/talktomyself on"===t.content.substring(0,16)||"/talktomyself"===t.content||"/talktomyself off"===t.content.substring(0,17)){if("/talktomyself on"===t.content.substring(0,16)||"/talktomyself"===t.content&&d20.textchat.talktomyself===!1){d20.textchat.talktomyself=!0;var s={who:"system",type:"system",content:"<strong>You are now talking to yourself.</strong> Chat messages and dice rolls will <strong>NOT BE BROADCAST</strong> to others until you turn this off. Use <code>/talktomyself off</code> to disable."};d20.textchat.incoming(!1,s),d20.utils.textchatNotify("Talking to Yourself",!0)}else if("/talktomyself off"===t.content.substring(0,17)||"/talktomyself"===t.content&&d20.textchat.talktomyself===!0){d20.textchat.talktomyself=!1;var s={who:"system",type:"system",content:"<strong>You are no longer talking to yourself.</strong> Hooray!"};d20.textchat.incoming(!1,s),d20.utils.textchatNotify(!1,!0)}}else{var s={who:"error",type:"error",content:"Unrecognized command: "+t.content};d20.textchat.incoming(!1,s)}},d=function(t,e){var r=180*Math.atan2(e,t)/Math.PI;return 0>r&&(r=360+r),r%180>90?r+=r%90>45?10-r%45/4.5:r%45/4.5:r-=r%90>45?10-r%45/4.5:r%45/4.5,r},f=function(t,e){return Math.sqrt(Math.pow(t,2)+Math.pow(e,2))},g=function(t,e,r){if(t&&"image"===t.type)d20.Campaign.parentRef.child("campaign").child("turnorder").transaction(function(n){d20.Campaign.set("turnorder",n);var i=d20.Campaign.initiativewindow.cleanList(),o=!1;return _.each(i,function(n){if(n.id===t.model.id)switch(o=!0,r){case"+":n.pr=parseFloat(n.pr)+e.total;break;case"-":n.pr=parseFloat(n.pr)-e.total;break;default:n.pr=e.total}}),o||i.push({id:t.model.id,pr:e.total,custom:""}),JSON.stringify(i)});else{var n={who:"error",type:"error",content:"You wanted to send the result of this roll to the turn tracker, but no valid token was selected!"};d20.textchat.incoming(!1,n)}};d20.textchat.rawChatInput=function(t){var r=_.extend({who:d20.textchat.$speakingas.find("option:selected").text(),type:"general",playerid:window.currentPlayer.id,content:""},t);if(d20.textchat.talktomyself)d20.textchat.incoming(!0,r);else{var n=e.push().key();e.child(n).setWithPriority(r,Firebase.ServerValue.TIMESTAMP)}};var m=function(t,e,r){return"bar1"==t.toLowerCase()?e.get("max"==r?"bar1_max":"bar1_value"):"bar2"==t.toLowerCase()?e.get("max"==r?"bar2_max":"bar2_value"):"bar3"==t.toLowerCase()?e.get("max"==r?"bar3_max":"bar3_value"):"token_name"==t.toLowerCase()?e.get("name"):"token_id"===t.toLowerCase()?e.id:void 0};d20.textchat.doChatInput=function(t){if(!e)return void console.log("No document!");if(t=d20.utils.strip_tags(t),""!=t){d20.textchat.commandhistory.push(t),d20.textchat.commandhistory=_.last(d20.textchat.commandhistory,20),d20.textchat.commandIndex=0;var r=d20.textchat.$speakingas.find("option:selected").val(),n=!1;if(-1!==r.indexOf("player"))n="/users/avatar/"+window.currentPlayer.get("d20userid")+"/30";else{var i=d20.Campaign.characters.get(r.split("|")[1]);i&&(n=i.get("avatar"))}var o={who:d20.textchat.$speakingas.find("option:selected").text(),type:"general",content:$.trim(t),playerid:window.currentPlayer.id,avatar:n},s=!1;"`"===o.content.substring(0,1)&&(s=!0,o.content=o.content.substring(1,o.content.length));var a=d20.engine.selected();a.length>0&&a[0].model&&(o.currentSelected=a[0]);var l={};d20.Campaign.players.each(function(t){t.macros.each(function(e){(t.id==window.currentPlayer.id||e.visibleToCurrentPlayer())&&(l["#"+e.get("name")]=e.get("action"))})});var u={},c={},p=d20.engine.mode+"",d=/(#[^ \n]+)/gm,f=/(%{[^}]+})/gm,v=/&{[^}]+}/,y=/(@{[^}]+})/gm,b="",w=0,x=function(){try{var t=!1,e=!1;if(o.content=o.content.replace(/&{noerror}/g,function(){return e=!0,""}),o.content=o.content.replace(f,function(r){var n,i,s,a,l,u,p;r=r.substring(2,r.length-1);var h=r.split("|");if(4==h.length&&(n=h[1],i=h[0],charname=h[2],l=h[3],s=d20.Campaign.characters.get(i),s&&(a=s.abilities.get(n),u=a.get("action"))),2==h.length&&(charname=h[0],l=h[1]),3==h.length&&(charname=h[0],l=h[2]),"repeating_"===l.substring(0,10)&&(!d20.journal.customSheets||void 0===d20.journal.customSheets.availableRolls[l.toLowerCase()])){console.log("SUBBING ABILITY REPEATING STUFF");var d=l.split("_");l="repeating_"+d[1]+"_"+d.slice(3).join("_"),p="repeating_"+d[1]+"_"+d[2]+"_"}if("selected"==charname.toLowerCase()){if(!o.currentSelected)throw"You attempted to use a roll command looking for the value of a selected token, but no tokens are selected.";if(""===o.currentSelected.model.get("represents"))throw"You attempted to use a roll command looking for a selected token ability, but the selected token does not represent a Character, and therefore has no abilities.";s=d20.Campaign.characters.get(o.currentSelected.model.get("represents"))}else if("target"===charname.toLowerCase()){if(t||d20.engine.nextTargetCallback)return"%{"+r+"}";var f="target";if(h.length>2&&(f=h[1],l=h[2]),!l)throw"Syntax Error: You must specify a valid ability to fetch from the target.";return d20.engine.nextTargetCallback=function(t){return t===!1?(P(),void(d20.engine.nextTargetCallback=!1)):(o.content=o.content.replace(/%\${currentTarget\|[^}]+}/,function(n){var i=n.split("|")[1].replace("}","");if(""!==t.model.get("represents")){var o=d20.Campaign.characters.get(t.model.get("represents"));if(o){var s=void 0;return o.abilities.each(function(t){t.get("name").toLowerCase()==i.toLowerCase()&&(s="%{"+o.id+"|"+t.id+"|"+o.get("name")+"|"+t.get("name")+"}")}),void 0!==s?s:"%{"+o.get("name")+"|"+i+"}"}console.log("Couldn't find character that represents this token.")}if(!e){var a={who:"error",type:"error",content:"No ability was found for targeted token by the name of "+i};d20.textchat.incoming(!1,a)}return r}),d20.engine.nextTargetCallback=!1,c[f]=t,void x())},void 0!==c[f]?_.defer(function(){d20.engine.nextTargetCallback(c[f])}):(setMode("targeting"),$("#targetinginstructions .targetname").text(ucfirst(f))),t=!0,"%${currentTarget|"+l+"}"}if(s&&a||(s||d20.Campaign.characters.each(function(t){return t.get("name").toLowerCase()==charname.toLowerCase()||t.id===charname?(s=t,!1):void 0}),!a&&s&&s.abilities.each(function(t){return t.get("name").toLowerCase()==l.toLowerCase()||t.id===l?(a=t,u=a.get("action"),!1):void 0}),!a&&s&&d20.journal.customSheets&&d20.journal.customSheets.availableRolls&&void 0!==d20.journal.customSheets.availableRolls[l.toLowerCase()]&&(a=d20.journal.customSheets.availableRolls[l.toLowerCase()],u=a)),!(s&&a&&s.currentPlayerControls())){if(!e){var g={who:"error",type:"error",content:"No ability was found for %{"+charname+"|"+l+"}"};d20.textchat.incoming(!1,g)}return r}r=u;var m={};p&&s.attribs.each(function(t){t.get("name").substring(0,p.length)===p&&(m[t.get("name").substring(p.length,t.get("name").length)]=!0)});var v=/(@{[^}]+})/gm;return r=r.replace(v,function(t){var r=t.substring(2,t.length-1),n=r.split("|");if(n.length>1&&"max"!==n[1])return t;var i=void 0!==p?p.split("_")[1]:"";if("repeating_"===n[0].substring(0,10)&&-1!==n[0].indexOf("$")){var o=n[0].split("_");if(o.length>3&&void 0!==o[2]&&"$"===o[2].substring(0,1)){var a=parseInt(o[2].replace("$",""),10),l=[],u=o[0]+"_"+o[1];if(s.attribs.each(function(t){if(t.get("name").toLowerCase().substring(0,u.length)===u.toLowerCase()){var e=t.get("name").split("_");e.length>2&&void 0!==e[2]&&l.push(e[2])}}),l=_.uniq(l),l=s.repeatingKeyOrder(l,u),void 0!==l[a])o[2]=l[a],n[0]=o.join("_");else if(!e){var c={who:"error",type:"error",content:"You tried to use the repeating section row at index "+a+" for "+u+", but there doesn't seem to be a row at that index."};d20.textchat.incoming(!1,c)}}}return p&&void 0!==m[n[0]]?"@{"+s.get("name")+"|"+p+n[0]+(2==n.length?"|"+n[1]:"")+"}":p&&d20.journal.customSheets&&void 0!==d20.journal.customSheets.availableAttributes[("repeating_"+i+"_"+n[0]).toLowerCase()]&&void 0===d20.journal.customSheets.availableAttributes[n[0].toLowerCase()]?"@{"+s.get("name")+"|"+p+n[0]+(2==n.length?"|"+n[1]:"")+"}":"@{"+s.get("name")+"|"+n[0]+(2==n.length?"|"+n[1]:"")+"}"}),r=r.replace(/\(~[^\)]+\)/g,function(t){var e=t.split("|");if(e.length<2){var r=t.substring(2,t.length);if(p&&"repeating_"===r.substring(0,10)){var n=r.split("_");r=p+n.splice(2).join("_")}return"(~"+s.id+"|"+r}return t})}),o.content=o.content.replace(d,function(t){return void 0!==l[t]?l[t]:t}),o.content=o.content.replace(y,function(r){var n,i,s,a,l,u,p;r=r.substring(2,r.length-1);var h=r.split("|"),d="current",f=!1;if(4==h.length&&(n=h[1],i=h[0],l=h[2],u=h[3],s=d20.Campaign.characters.get(i),s&&(a=s.attribs.get(n))),!s)if(l=h[0],u=h[1],h.length>2&&("max"==(h[2]+"").toLowerCase()||"max"==(h[3]+"").toLowerCase())&&(d="max"),"selected"==l.toLowerCase()){if(!o.currentSelected)throw"You attempted to use a roll command looking for the value of a selected token, but no tokens are selected.";var g=m(u,o.currentSelected.model,d);if(void 0!==g)return g;if(""!==o.currentSelected.model.get("represents")){if(s=d20.Campaign.characters.get(o.currentSelected.model.get("represents")),"character_name"===u.toLowerCase())return s.get("name");if("character_id"===u.toLowerCase())return s.id}}else{if("target"===l.toLowerCase()){if(t||d20.engine.nextTargetCallback)return"@{"+r+"}";var v=(d20.engine.mode+"","target");if(h.length>2&&(v=h[1],u=h[2]),!u)throw"Syntax Error: You must specify a valid attribute to fetch from the target.";return d20.engine.nextTargetCallback=function(t){return t===!1?(d20.engine.nextTargetCallback=!1,P(),void setTimeout(function(){if("targeting"!=d20.engine.mode)for(var t=0;t<origtoken.length;t++)d20.engine.select(origtoken[t])},500)):(o.content=o.content.replace(/@\${currentTarget\|[^}]+}/,function(r){var n=r.split("|")[1].replace("}",""),i=m(n,t.model,d);if(void 0!==i)return i;if(""!==t.model.get("represents")){var o=d20.Campaign.characters.get(t.model.get("represents"));if(o)return"character_name"===u.toLowerCase()?o.get("name"):"character_id"===u.toLowerCase()?o.id:"@{TARGET:"+v+"|"+n+("max"===d?"|max":"")+"}";console.log("Couldn't find character that represents this token.")}if(!e){var s={who:"error",type:"error",content:"No attribute was found for targeted token by the name of "+n};d20.textchat.incoming(!1,s)}return""}),d20.engine.nextTargetCallback=!1,c[v]=t,x(),void setTimeout(function(){if("targeting"!=d20.engine.mode)for(var t=0;t<origtoken.length;t++)d20.engine.select(origtoken[t])},500))},void 0!==c[v]?_.defer(function(){d20.engine.nextTargetCallback(c[v])}):("targeting"!=d20.engine.mode&&(origtoken=d20.engine.selected()),setMode("targeting"),$("#targetinginstructions .targetname").text(ucfirst(v))),t=!0,"@${currentTarget|"+u+"}"}if("tracker"===l.toLowerCase()){var y,b=d20.Campaign.initiativewindow.cleanList();if(_.each(b,function(t){if(t.custom.toLowerCase()===u.toLowerCase())return y=t.pr,!1;if(t.id){var e=d20.Campaign.activePage().thegraphics.get(t.id);if(e&&e.get("name").toLowerCase()===u.toLowerCase())return y=t.pr,!1}}),void 0!==y)return y;if(!e){var w={who:"error",type:"error",content:"No turn order item was found by the name "+u};d20.textchat.incoming(!1,w)}return""}}if("repeating_"===u.substring(0,10)){var S=u.split("_");p="repeating_"+S[1]+"_"+S[2]+"_"}if(!(s&&a||(!s&&"TARGET:"===l.substring(0,7)&&c[l.substring(7,l.length)]&&(s=d20.Campaign.characters.get(c[l.substring(7,l.length)].model.get("represents")),f=!0),s||d20.Campaign.characters.each(function(t){return t.get("name").toLowerCase()==l.toLowerCase()?(s=t,!1):void 0}),a||!s))){if("repeating_"===u.substring(0,10)&&-1!==u.indexOf("$")){var E=u.split("_");if(E.length>3&&void 0!==E[2]&&"$"===E[2].substring(0,1)){var T=parseInt(E[2].replace("$",""),10),A=[],C=E[0]+"_"+E[1];if(s.attribs.each(function(t){if(t.get("name").toLowerCase().substring(0,C.length)===C.toLowerCase()){var e=t.get("name").split("_");e.length>2&&void 0!==e[2]&&A.push(e[2])}}),A=_.uniq(A),A=s.repeatingKeyOrder(A,C),void 0!==A[T])E[2]=A[T],u=E.join("_");else if(!e){var w={who:"error",type:"error",content:"You tried to use the repeating section row at index "+T+" for "+C+", but there doesn't seem to be a row at that index."};d20.textchat.incoming(!1,w)}}}a=s.attribs.find(function(t){return t.get("name").toLowerCase()===u.toLowerCase()})}if(!s){var w={who:"error",type:"error",content:"No character was found for '"+l+"'"};return d20.textchat.incoming(!1,w),r}var R={};p&&s.attribs.each(function(t){t.get("name").substring(0,p.length)===p&&(R[t.get("name").substring(p.length,t.get("name").length)]=!0)});var L=function(t){var e=/(@{[^}]+})/gm;return t=(t+"").replace(e,function(t){var e=t.substring(2,t.length-1),r=e.split("|");if(r.length>1&&"max"!==r[1])return t;var n=void 0!==p?p.split("_")[1]:"";return p&&void 0!==R[r[0]]?"@{"+(f?l:s.get("name"))+"|"+p+r[0]+(2==r.length?"|"+r[1]:"")+"}":p&&d20.journal.customSheets&&void 0!==d20.journal.customSheets.availableAttributes[("repeating_"+n+"_"+r[0]).toLowerCase()]&&void 0===d20.journal.customSheets.availableAttributes[r[0].toLowerCase()]?"@{"+(f?l:s.get("name"))+"|"+p+r[0]+(2==r.length?"|"+r[1]:"")+"}":"@{"+(f?l:s.get("name"))+"|"+r[0]+(2==r.length?"|"+r[1]:"")+"}"}),t=t.replace(/\(~[^\)]+\)/g,function(t){var e=t.split("|");if(e.length<2){var r=t.substring(2,t.length);if(p&&"repeating_"===r.substring(0,10)){var n=r.split("_");r=p+n.splice(2).join("_")}return"(~"+s.id+"|"+r}return t})};if("character_name"===u)return s.get("name");if("character_id"===u)return s.id;var M=void 0;if(a&&(s.currentPlayerControls()||f===!0)&&(M=a.get("max"==d?"max":"current")),void 0!==M&&""!==M)return L(M);var k=void 0,B=(u+("max"===d?"_max":"")).toLowerCase();if("repeating_"===B.substring(0,10)&&(!d20.journal.customSheets||void 0===d20.journal.customSheets.availableAttributes[B])){var I=B.split("_");isNaN(I[2])&&"-"!==I[2].substring(0,1)||(I.splice(2,1),B=I.join("_"))}if((s.currentPlayerControls()||f===!0)&&d20.journal.customSheets&&d20.journal.customSheets.availableAttributes&&void 0!==d20.journal.customSheets.availableAttributes[B]){var O=d20.journal.customSheets.availableAttributes[B];k=O}if(void 0!==M&&void 0===k)return L(M);if(void 0!==k)return L(k);if(!e){var w={who:"error",type:"error",content:"No attribute was found for @{"+l+"|"+u+"}"};d20.textchat.incoming(!1,w)}return r}),w++,t)return;void 0!==window.logRolls&&console.log(o.content),o.content==b||w>99?(console.log("Finished after going "+w+" levels deep."),C()):(b=o.content,x())}catch(r){var n={who:"error",type:"error",content:r+""};d20.textchat.incoming(!1,n)}},S=function(){var t=/{{[\s\S]*?}}/g;o.content=o.content.replace(t,function(t){return t.replace(/\n/g,"%NEWLINE%")});var r=o.content.split("\n"),n=[],i=0,a=function(){if(n&&!(i<n.length)){for(var t=0;t<n.length;t++)if("noop"!==n[t])if(n[t]._fbid){console.log("Found existing ID!");var r=n[t]._fbid;delete n[t]._fbid,d20.textchat.talktomyself?(n[t].id=r,n[t].timestamp=(new Date).getTime(),d20.textchat.incoming(!0,n[t])):e.child(r).setWithPriority(n[t],Firebase.ServerValue.TIMESTAMP)}else if(d20.textchat.talktomyself)n[t].id=e.push().key(),n[t].timestamp=(new Date).getTime(),d20.textchat.incoming(!0,n[t]);else{var o=e.push().key();e.child(o).setWithPriority(n[t],Firebase.ServerValue.TIMESTAMP)}P(),n=null}},l=0;_.each(r,function(t){n.push(!1);var e=_.clone(o);e.content=t,e.content=e.content.replace(/%NEWLINE%/g,"<br/>\n");var r,u=l+0,c=function(t){if("object"==typeof t&&(e.inlinerolls&&(t.inlinerolls=e.inlinerolls),r&&(t.rolltemplate=r),delete t.currentSelected,delete t.opts,"api"==t.type)){var o=d20.engine.selected();o&&o.length>0&&(t.selected=[],_.each(o,function(e){return void 0==e.model?!0:void t.selected.push({_type:"image"==e.model.get("type")?"graphic":e.model.get("type"),_id:e.model.id})}))}n[u]=t,i++,_.defer(function(){a()})},p=function(){console.log("Inline rolls complete!"),s||(e.content=e.content.replace(v,function(t){t=t.substring(2,t.length-1),e.opts||(e.opts={});for(var r=t.split(","),n=0;n<r.length;n++){var i=r[n].split(":");e.opts[i[0]]=i.length>1?i[1]:!0}return""})),e.opts&&void 0!==e.opts.template&&(r=e.opts.template),"//"===e.content.substring(0,2)?c("noop"):s||"/"!=e.content.substring(0,1)?(s||"!"!=e.content.substring(0,1)||(e.type="api"),c(e)):h(e,c)};s?p():(console.log("Begin processing op!"),E(e,p)),d20.textchat.diceengine.flushRemoteQueue(),l++})},E=function(t,e){var r=[],n=0,i=0,o=function(){n>i||(t.inlinerolls=r,e())},s=function(e,i){for(var o=[],s=[],l=!1,u=!1,c=0,p=!1;!p;){for(var h=0;h<e.length;h++)if("["===e[h])if("["===e[h-1]){if(c++,"$"===e[h-2]){l=!0;continue}o.push(h-1)}else"["===e[h+1]||(u=!0);else if("]"===e[h]){if(u){u=!1,s.push(h);continue}if("]"===e[h-1]&&-1===s.indexOf(h-1)){if(c--,l){l=!1;continue}var d=o.slice(-1)[0],f=e.substring(d,h+1);if(-1!==f.indexOf("$[[")){console.log("There's a nested inline roll in here. Ignore for now");continue}if(function(){var o=n+0,s=c+0;n++,e=e.substring(0,d)+"$[["+o+"]]"+e.substring(h+1,e.length),t.content=e,a(f,o,function(){console.log("Finished "+o),console.log("Levels deep: "+s),s>0&&(console.log("Substituting for "+o),t.content=t.content.replace("$[["+o+"]]",r[o].results.total)),i()})}(),console.log("Levels deep: "+c),c>0)return void d20.textchat.diceengine.flushRemoteQueue();break}}p=!0}i(e)},a=function(e,n,o){e=$.trim(e.substring(2,e.length-2));var s={};e=e.replace(v,function(t){t=t.substring(2,t.length-1);for(var e=t.split(","),r=0;r<e.length;r++){var n=e[r].split(":");s[n[0]]=n.length>1?n[1]:!0}return""}),d20.textchat.diceengine.process(e,function(a,l,u,c){if(d20.textchat.globalrolled++,a.rolls&&a.rolls.length>0)try{_.each(a.rolls,function(t){if(t.table){d20.utils.stattracker.rolltables||(d20.utils.stattracker.rolltables=!0);
var e=d20.Campaign.rollabletables.findTableByName(t.table),r=e.getWeightedArray();e&&_.each(t.results,function(t){t.tableItem=e.tableitems.get(r[t.tableidx]).toJSON()})}})}catch(p){console.log("ERROR matching table"),console.log(p)}r[n]={expression:e,results:a,signature:u,rollid:l},c&&(r[n].tdseed=c),s.tracker&&g(t.currentSelected,a,s.tracker),i++,o()})},l="",u=function(){l!==t.content?(l=t.content,s(t.content+"",u)):o()};s(t.content+"",u)},T=/(\?{[^}]+})/m,A=0,C=function(){var t=!1;o.content=o.content.replace(T,function(e){if(A>99)return e;t=!0,A++,e=$.trim(e.substring(2,e.length-1));var r=e.split("|");if(e=r[0],console.log(r.length),void 0!==u[e])return _.defer(function(){C()}),u[e];if(r.length<=2)var n=$("<div><p style='font-size: 1.15em;'><strong>"+d20.utils.strip_tags(e)+":</strong> <input type='text' style='width: 75px; margin-left: 5px;'></p></div>");else{options=[],r.each(function(t){opt=t.split(","),optlabel=opt[0],optvalue=opt[1]?opt[1]:opt[0],optvalue=optvalue.replace(/'/g,"&#39"),opt!=e&&options.push("<option value='"+d20.utils.strip_tags(optvalue)+"'>"+d20.utils.strip_tags(optlabel)+"</option>")});var n=$("<div><p style='font-size: 1.15em;'><strong>"+d20.utils.strip_tags(e)+":</strong> <select style='width: 150px; margin-left: 5px;'>"+options.join("")+"</select></p></div>")}return n.dialog({title:"Input Value",beforeClose:function(){return!1},buttons:{Submit:function(){r.length<3?(u[e]=n.find("input").val(),o.content=o.content.replace("?${1}",n.find("input").val())):(u[e]=n.find("select").val(),o.content=o.content.replace("?${1}",n.find("select").val())),n.off(),n.dialog("destroy").remove(),C(),d20.textchat.$textarea.focus()},Cancel:function(){n.off(),n.dialog("destroy").remove(),P()}}}),n.on("keydown","input, select",function(t){13==t.which&&(r.length<3?(u[e]=n.find("input").val(),o.content=o.content.replace("?${1}",n.find("input").val())):(u[e]=n.find("select").val(),o.content=o.content.replace("?${1}",n.find("select").val())),n.off(),n.dialog("destroy").remove(),C(),t.stopPropagation(),t.preventDefault(),d20.textchat.$textarea.focus())}),_.defer(function(){r.length<=2?(2===r.length&&n.find("input").val(r[1]).select(),n.find("input").focus()):n.find("select").focus()}),"?${1}"}),t||S()},P=function(){x=null,E=null,S=null,C=null,inlinerolls=null,o=null,b=null,u=null,c=null,d20.engine.mode!==p&&setMode(p),p=null};s?S():x()}},$("#textchat-input").on("click","button",function(){var t=$.trim(d20.textchat.$textarea.val());d20.textchat.doChatInput(t),d20.textchat.$textarea.val("").focus()});var v=!1,y=function(t){var e=(new Date).getTime();v&&3e3>e-v||d20.textchat.talktomyself||(v=e,d20.textchat.sendShout({type:"istyping",playerid:window.currentPlayer.id,content:t,time:(new Date).getTime()}))};d20.textchat.$textarea.bind("keyup",function(){var t=$(this).val();if(t.length>1&&"#"!=t.substring(0,1)){var e=!1;if("/as "===t.substring(0,4)||"/emas "===t.substring(0,6)){t=t.replace("/as ","").replace("/emas ","");var r=t.match(/ /g);if(null==r||r.length<2)return;var n=t.match(/"/g);if('"'===t[0]&&null!==n&&n.length<2)return;var i=t.match(/\w+|"[^"]+"/);null!=i&&i.length&&i.length>0&&(e='"'===i[0][0]?i[0].substring(1,i[0].length-1):i[0])}else"/ooc "===t.substring(0,5)||"/o "===t.substring(0,3)||"/desc "===t.substring(0,6)||"/em "===t.substring(0,4)||"/me "===t.substring(0,4)||"/e "===t.substring(0,3)?e=d20.textchat.$speakingas.find("option:first-child").text():"/"!==t.substring(0,1)&&(e=d20.textchat.$speakingas.find("option:selected").text());e&&y(e)}}),d20.textchat.$textarea.bind("keydown",function(t){if(13===t.which){if(a)return!1;if(t.shiftKey===!0)return;$(this).parent().find("button").trigger("click"),t.preventDefault()}}),d20.textchat.$textarea.bind("keyup","up",function(){var t=d20.textchat.commandhistory[d20.textchat.commandhistory.length+d20.textchat.commandIndex];(""==$(this).val()||$(this).val()==t)&&(Math.abs(d20.textchat.commandIndex)<d20.textchat.commandhistory.length+1&&(d20.textchat.commandIndex=d20.textchat.commandIndex-1),$(this).val(d20.textchat.commandhistory[d20.textchat.commandhistory.length+d20.textchat.commandIndex]))}),d20.textchat.$textarea.bind("keyup","down",function(){var t=d20.textchat.commandhistory[d20.textchat.commandhistory.length+d20.textchat.commandIndex];(""==$(this).val()||$(this).val()==t)&&(d20.textchat.commandIndex<0&&(d20.textchat.commandIndex=d20.textchat.commandIndex+1),$(this).val(d20.textchat.commandhistory[d20.textchat.commandhistory.length+d20.textchat.commandIndex]))});var b=function(t,e){return t.substring(0,e.selectionStart).match(/[\w\xe4\xf6\xfc\xc4\xd6\xdc\xdf#%{]+$/)},w=function(t,e){if(t.setSelectionRange)t.setSelectionRange(e,e);else if(t.createTextRange){var r=t.createTextRange();r.collapse(!0),r.moveEnd("character",e),r.moveStart("character",e),r.select()}};d20.textchat.$textarea.autocomplete({delay:100,autoFocus:!0,position:{my:"left top",at:"left bottom"},source:function(t,e){var r=b(t.term,d20.textchat.$textarea[0]);if(r=null!=r?r[0]:"","%"===r[0]&&"{"!==r[1]&&(r="%{"+r.substring(1,r.length)),"#"==r.substring(0,1)){var n=[];d20.Campaign.players.each(function(t){t.macros.each(function(e){return""==e.get("name")?!0:void((t.id==window.currentPlayer.id||e.visibleToCurrentPlayer())&&n.push("#"+e.get("name")))})});var i=$.ui.autocomplete.filter(n,r);e(i)}else if("/w "==t.term.substring(0,3)&&t.term.split(" ").length<3){var i=$.ui.autocomplete.filter(_.union(["gm"],d20.Campaign.players.map(function(t){return t.get("displayname").split(" ")[0]}),d20.Campaign.characters.map(function(t){var e=t.get("inplayerjournals").split(",");return window.is_gm||-1!==_.indexOf(e,"all")||window.currentPlayer&&-1!==_.indexOf(e,window.currentPlayer.id)?t.get("name").split(" ")[0]:!1})),r);e(i)}else if("%{"===r.substring(0,2)){var n=[];d20.Campaign.characters.each(function(t){t.currentPlayerControls()&&t.abilities.each(function(e){-1!==e.get("name").toLowerCase().indexOf(r.substring(2,r.lenght).toLowerCase())&&n.push("%{"+t.get("name")+"|"+e.get("name")+"}")})}),e(n)}else e([])},focus:function(){return!1},select:function(t,e){e.item.value+=" ";var r=b(this.value,this)[0],n=this.value.substring(0,this.selectionStart-r.length);this.value=n+e.item.value+this.value.substring(this.selectionStart,this.value.length);var i=n.length+e.item.value.length;return w(this,i),t.preventDefault(),!1},search:function(){var t=b(this.value,this);return null!=t},open:function(){a=!0},close:function(){setTimeout(function(){a=!1},250)}});var x=$("#textchat .content");d20.textchat.incoming=function(e,r,a,l){var c=r.type;if("api"!==r.type){if(d20.tutorial&&d20.tutorial.active&&$(document).trigger("receivedChat",r),null===r.timestamp)r.timestamp="";else{var p=r.timestamp,h=Date.create(p),d=(new Date).getTime();r.timestamp=h.format(864e5>d-p?"{h}:{mm}{TT}":"{{Month}} {{dd}}, {{yyyy}} {h}:{mm}{TT}")}if(d20.Campaign&&r.playerid!=window.currentPlayer.id&&(delete u[r.playerid],d20.textchat.updateWhoIsTyping()),"gmrollresult"==r.type){if(!window.is_gm&&r.playerid!=window.currentPlayer.id)return void console.log("ignoring message, not gm, and not original player.");c="rollresult"}if("whisper"==r.type)if(r.playerid==window.currentPlayer.id)c="whispersent";else{if(c="whisperreceived","gm"==r.target){if(!window.is_gm)return}else if(-1===r.target.indexOf(window.currentPlayer.id))return;t=r}if(d20.Campaign){var f=x.height(),g=$(window).height(),m=d20.textchat.$textchat.scrollTop(),v=!1;g>f-m-200&&(v=!0)}if("rollresult"==c&&r.origRoll){c="newroll";try{var y=JSON.parse(r.content);r.signature&&(d20.textchat.verifyRoll(r.id,y,r.signature)?r.passedSignature=!0:r.failedSignature=!0),r.htmlcontent=d20.dice_formatter.getHtmlForResult(y),r.sanitizedOrigRoll=d20.dice_formatter.replaceInlineRolls(r.origRoll.replace("<","&lt;"),r,"")}catch(b){return}}else"rollresult"==c&&"object"==typeof r.content&&(r.content=r.content.origformula+"|"+r.content.formula+"|"+r.content.total);var w;if(w=$("#tmpl_chatmessage_"+c),l){var S=x.find(".message[data-messageid="+r.id+"]");r.showname=S.find(".avatar").length>0?!0:!1}else(r.who!==n||i>5)&&(r.showname=!0,i=0);if(r.rolltemplate||"rollresult"==c||"newroll"==c||"tokenroll"==c||"direct"==c||(r.content=Markdown.parse(r.content+"").autoLink()),r.rolltemplate){for(var E,T={},A=/{{([\s\S]*?}?)}}/gi;null!=(E=A.exec(r.content));){E.index===A.lastIndex&&A.lastIndex++;var C=E[1]+"",P=C.split("=");T[P[0]]=C.substring(P[0].length+1,C.length)}$.each(T,function(t,e){T[t]=e.replace(/\^{([^}]+)}/g,function(t,e){return e=$.trim(e),i18n(e,'<span style="color: red;">['+e+"]</span>")});var r=t.replace(/\^{([^}]+)}/g,function(t,e){return e=$.trim(e),i18n(e,"["+e+"]")});r!==t&&(T[r]=T[t],delete T[t])}),T["rollWasCrit()"]=function(){return function(t,e,n){try{var i=n.join(" ");if(void 0!==T[i]&&"string"==typeof T[i]){var o=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[o]&&d20.dice_formatter.checkForCrits(r.inlinerolls[o].results.rolls,"crit"))return e(t)}}catch(s){console.log("Error while checking for crit in roll...")}return null}},T["^rollWasCrit()"]=function(){return function(t,e,n){try{var i=n.join(" ");if(void 0!==T[i]&&"string"==typeof T[i]){var o=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[o]&&!d20.dice_formatter.checkForCrits(r.inlinerolls[o].results.rolls,"crit"))return e(t)}}catch(s){console.log("Error while checking for crit in roll...")}return null}},T["rollWasFumble()"]=function(){return function(t,e,n){try{var i=n.join(" ");if(void 0!==T[i]&&"string"==typeof T[i]){var o=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[o]&&d20.dice_formatter.checkForCrits(r.inlinerolls[o].results.rolls,"fumble"))return e(t)}}catch(s){console.log("Error while checking for fumble in roll...")}return null}},T["^rollWasFumble()"]=function(){return function(t,e,n){try{var i=n.join(" ");if(void 0!==T[i]&&"string"==typeof T[i]){var o=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[o]&&!d20.dice_formatter.checkForCrits(r.inlinerolls[o].results.rolls,"fumble"))return e(t)}}catch(s){console.log("Error while checking for fumble in roll...")}return null}},T["rollTotal()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1];if(lookingForTotal=void 0!==o&&isNaN(o)?r.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[s]&&r.inlinerolls[s].results.total===parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["^rollTotal()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1];if(lookingForTotal=void 0!==o&&isNaN(o)?r.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[s]&&r.inlinerolls[s].results.total!==parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["rollGreater()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1];if(lookingForTotal=void 0!==o&&isNaN(o)?r.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[s]&&r.inlinerolls[s].results.total>parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["^rollGreater()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1];if(lookingForTotal=void 0!==o&&isNaN(o)?r.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[s]&&r.inlinerolls[s].results.total<=parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["rollLess()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1];if(lookingForTotal=void 0!==o&&isNaN(o)?r.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[s]&&r.inlinerolls[s].results.total<parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["^rollLess()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1];if(lookingForTotal=void 0!==o&&isNaN(o)?r.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[s]&&r.inlinerolls[s].results.total>=parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["rollBetween()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1],s=n[2];if(lookingForTotal=void 0!==o&&isNaN(o)?r.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,lookingForTotal2=void 0!==s&&isNaN(s)?r.inlinerolls[T[s].split("$[[")[1].split("]]")[0]].results.total:s,void 0!==T[i]&&"string"==typeof T[i]){var a=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[a]&&r.inlinerolls[a].results.total>=parseInt(lookingForTotal,10)&&r.inlinerolls[a].results.total<=parseInt(lookingForTotal2,10))return e(t)}}catch(l){console.log("Error while checking for roll total...")}return null}},T["^rollBetween()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1],s=n[2];if(lookingForTotal=void 0!==o&&isNaN(o)?r.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,lookingForTotal2=void 0!==s&&isNaN(s)?r.inlinerolls[T[s].split("$[[")[1].split("]]")[0]].results.total:s,void 0!==T[i]&&"string"==typeof T[i]){var a=T[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[a]&&(r.inlinerolls[a].results.total<parseInt(lookingForTotal,10)||r.inlinerolls[a].results.total>parseInt(lookingForTotal2,10)))return e(t)}}catch(l){console.log("Error while checking for roll total...")}return null}},T["allprops()"]=function(){return function(t,e,r){try{var n="";for(var i in T)"name"!==i&&-1===r.indexOf(i)&&"function"!=typeof T[i]&&(n+=e(t.replace("{{key}}",ucfirst(i)).replace("{{value}}",T[i])));return n}catch(o){console.log("Error enumerating all properties")}return null}};var R="";if(d20.journal&&d20.journal.customSheets&&d20.journal.customSheets.rollTemplates[r.rolltemplate])R="<div class='sheet-rolltemplate-"+r.rolltemplate+"'>"+d20.journal.customSheets.rollTemplates[r.rolltemplate]+"</div>";else{var L=$("#sheet-rolltemplate-"+r.rolltemplate);0===L.length?console.error("Didn't find a roll template called '"+r.rolltemplate+"'"):R="<div class='"+L.attr("id")+"'>"+L.html()+"</div>"}r.content=Mustache.render(R,T),r.content=Markdown.parse(r.content),r.content=d20.utils.htmlTranslator(r.content,!0)}var M=w.jqote(r),k=":last-child";if(l?(S.replaceWith(M),k="[data-messageid="+r.id+"]"):x.append(M),("rollresult"==r.type||"gmrollresult"==r.type)&&d20.Campaign&&window.currentPlayer&&window.currentPlayer.get("diceiconsenabled")){x.find(".message"+k+" .rolled").draggable({revert:!0,distance:10,revertDuration:0,helper:"clone",appendTo:"body",scroll:!1}).addTouch();var B=x.find(".message"+k+" .formattedformula > .dicegrouping");B.find(".diceroll").length<20&&B.sortable({appendTo:document.body,helper:"clone",distance:10,items:"> .diceroll",update:function(t){d20.textchat.updateDiceOrdering(r,t)}}).addTouch(),B=null}if(d20.Campaign&&window.currentPlayer&&"newroll"==c&&r.playerid==window.currentPlayer.id)try{var I=$("#mylastrolls tbody tr").eq(0);(0==I.length||$.trim(I.find("td.formula").text())!=r.origRoll)&&($("#mylastrolls tbody").prepend($("#tmpl_recentroll").jqote(r)),$("#mylastrolls tbody tr").eq(10).remove())}catch(b){}if(!a&&x.find(".message").length>100&&x.find(".message").eq(0).remove(),l||(n="emote"==r.type||"gmrollresult"==r.type||"whisper"==r.type?"":r.who,i++),d20.Campaign&&(v||e===!1)){var O=x.height();d20.textchat.$textchat.scrollTop(O)}if(d20.Campaign&&$("#chatbeepenabled").is(":checked")&&(!o&&!s||!d20.textchat.tabIsFocused&&!d20.textchat.childWindow)&&0!=e&&!d20.textchat.chatstartingup){if((new Date).getTime()-d20.textchat.lastChatBeep>1e3){var H=new Audio;H.src="/images/sounds/beep."+(H.canPlayType("audio/ogg")?"ogg":"mp3"),H.play(),d20.textchat.lastChatBeep=(new Date).getTime()}d20.textchat.tabIsFocused||$("#textchattab").addClass("alertify")}if(-1!==document.body.className.indexOf("sidebarhidden")&&$("#sidebarcontrol").addClass("alertify"),!d20.textchat.chatstartingup){var F;void 0!==r.tdseed?F=r.id:void 0!==r.inlinerolls&&r.inlinerolls.length>0&&_.each(r.inlinerolls,function(t){return void 0!==t.tdseed?(F=t.rollid,!1):void 0}),F&&(x.find(".message[data-messageid="+r.id+"]").addClass("hidden3d"),d20.tddice.handleIncomingChatWith3DRoll(F,1),setTimeout(function(){d20.textchat.showHidden3DRolls()},d20.tddice.canRoll3D()?3e3:2e3),d20.textchat.allowed3drolls.push(F))}}},d20.textchat.showHidden3DRolls=function(){var t=!1;if(d20.Campaign){var e=x.height(),r=$(window).height(),n=d20.textchat.$textchat.scrollTop();r>e-n-200&&(t=!0)}if(x.find(".message.hidden3d").removeClass("hidden3d"),t){var i=x.height();d20.textchat.$textchat.scrollTop(i)}},d20.textchat.verifyRoll=function(t,e,r){var n=window.campaign_storage_path+"//"+t+"//"+e.total,i=c.subjectPublicKeyRSA.verifyString(n,r);return i},d20.textchat.updateDiceOrdering=function(t,r){var n=$(r.target),i=parseInt(n.attr("data-groupindex"),10),o=JSON.parse(t.content),s=[];n.find(".diceroll").each(function(){var t=parseInt($(this).attr("data-origindex"),10);return o.rolls[i]&&o.rolls[i].results[t]?void s.push(o.rolls[i].results[t]):void console.log("ERROR: Unable to find group "+i+" or result "+t)}),o.rolls[i].results=s,e.child(t.id).child("content").set(JSON.stringify(o))},d20.textchat.updateWhoIsTyping=function(){var t=x.height(),e=$(window).height(),r=d20.textchat.$textchat.scrollTop(),n=!1;e-150>t-r&&(n=!0);var i=_.values(u);if(0==i.length)$("#whoistyping").hide();else{var o="are";1==i.length&&(o="is"),$("#whoistyping .names").text(i.join(", ").replace(/,$/," and")+" "+o+" typing..."),$("#whoistyping").show()}if(n){var s=x.height();d20.textchat.$textchat.scrollTop(s)}};var S=function(t){if("istyping"==t.type){if(t.playerid==window.currentPlayer.id)return;l[t.playerid]&&clearTimeout(l[t.playerid]),u[t.playerid]=t.content,l[t.playerid]=setTimeout(function(){l[t.playerid]=!1,delete u[t.playerid],d20.textchat.updateWhoIsTyping()},5e3),d20.textchat.updateWhoIsTyping()}else if("shdw_update"==t.type||"shdw_kill"==t.type)d20.engine.handleShadows(t);else if("steal_request"==t.type)d20.decks.steal_request(t);else if("steal_response"==t.type)d20.decks.steal_response(t);else if("measuring"==t.type)d20.engine.receiveMeasureUpdate(t);else if("endmeasurement"==t.type)d20.engine.receiveEndMeasure(t);else if("mapping"==t.type)d20.engine.receiveMapping(t);else if("showhandout"==t.type)d20.journal.showHandoutFromShout(t);else if("showcharacter"==t.type)d20.journal.showCharacterFromShout(t);else if("showobject"==t.type){if(!t.id)return;d20.engine.zoomObject(t.id)}else if("3droll"==t.type)d20.tddice&&t.playerid!==window.currentPlayer.id&&d20.tddice.remoteRoll(t);else if("fx_start"==t.type||"fx_update"==t.type||"fx_kill"==t.type){if(t.playerid===window.currentPlayer.id)return;d20.fx.handleShout(t)}else"settingschanged"==t.type?(new Date).getTime()-t.time<5e3&&window.location.reload():"playclickhole"==t.type&&t.content.length>2&&(window.fakeLightly&&window.fakeLightly("http://v.theonion.com/onionstudios/video/"+t.content[0]+"/640.mp4"),setTimeout(function(){$("#lightly-overlay").hide()},1e3*t.content[2]+2e3))};d20.textchat.startup=function(){var t=new Firebase(window.FIREBASE_ROOT+window.campaign_storage_path+"/");r=t.child("shout"),e=t.child("chat"),textchatpopped=!1;var n,i=!1;d20.textchat.sendShout=function(t){!i||"istyping"!==t.type&&"measuring"!==t.type&&"endmeasurement"!==t.type&&"fx_start"!==t.type&&"fx_update"!==t.type&&"fx_kill"!==t.type?d20.tutorial&&d20.tutorial.active?S(t):d20.textchat.shoutref.set(JSON.stringify(t)):n.send(JSON.stringify({t:"msg",content:t}))},d20.textchat.shoutref=r,d20.textchat.chatstartingup=!0,r.on("value",function(t){if(!d20.textchat.chatstartingup){var e=t.val();e&&S(JSON.parse(e))}});var o=[],s=function(){for(var t=0;t<o.length;t++)d20.textchat.incoming(!d20.textchat.chatstartingup,o[t]);o=null,window.is_gm&&(window.is_offsite&&!window.is_playerapp?d20.textchat.incoming(!1,{who:"system",type:"system",content:"Invite other users to join this Google+ Hangout and they'll join your Roll20 game."}):$.get("/campaigns/sharelink/"+window.campaign_id,function(t){d20.textchat.incoming(!1,{who:"system",type:"system",content:"The player link for this campaign is: <div class='sharelink'><a href='"+t+"'>"+t+"</a></div> <div style='font-size: 0.9em;'>(Hover over with your mouse pointer to show)</div>"})})),d20.textchat.incoming(!1,{who:"system",type:"system",content:$("#tmpl_welcome_message").jqote()}),d20.textchat.chatstartingup=!1},a=_.debounce(s,1e3),l=e.limitToLast(100),u=[],c=!1,p=0,h=function(t){var e=t.val();e.timestamp=t.getPriority(),e.id=t.key(),-1===u.indexOf(e.id)?(u.push(e.id),c=e.id,p=(new Date).getTime(),d20.textchat.chatstartingup?(o.push(e),a()):d20.textchat.incoming(!d20.textchat.chatstartingup,e)):!d20.textchat.chatstartingup&&(c!==e.id||(new Date).getTime()-p>500)&&d20.textchat.incoming(!0,e,!0,!0)};l.on("child_added",function(t){h(t)}),l.on("child_changed",function(t){h(t)}),l.once("value",function(){a()})};var E;d20.textchat.opendialog=function(){E=$("#textchat").css("height"),$("#textchat").dialog({title:"Text Chat",beforeClose:function(){$(this).dialog("destroy"),$(this).appendTo("#rightsidebar"),$(this).css("height",E).css("width","auto"),$(this).show()}})},d20.textchat.showPopout=function(){if(textchatpopped!==!0){var t=$("#textchat"),e=$("#textchat-input"),r=t.parent();d20.textchat.childWindow=window.open("/editor/popoutchat","ChatPopout","menubar=0,location=0,toolbar=0,status=0,scrollbars=1,width=300,height=800"),window.allChildWindows.push(d20.textchat.childWindow),d20.textchat.childWindow.onload=function(){textchatpopped=!0,d20.journal.customSheets&&d20.journal.customSheets.styleel&&(console.log("Setting style element in child window."),$(d20.journal.customSheets.styleel).clone().appendTo(d20.textchat.childWindow.document.head)),t.appendTo(d20.textchat.childWindow.document.getElementById("containerdiv")),e.appendTo(d20.textchat.childWindow.document.body),d20.textchat.$textarea.autocomplete("widget").appendTo(d20.textchat.childWindow.document.body),d20.textchat.childWindow.document.title="Roll20 Chat",t.scrollTop(t[0].scrollHeight),$("#rightsidebar").find("ul.tabmenu li").eq(1).find("a").trigger("click");var r=function(){return $(this).hasClass("tipsy-w")?"w":$(this).hasClass("tipsy-e")?"e":$(this).hasClass("tipsy-n")?"n":$(this).hasClass("tipsy-s")?"s":$(this).hasClass("tipsy-side")?$(this).offset().left>$(document).scrollLeft()+$(window).width()/2?"e":"w":$(this).offset().top<$(document).scrollTop()+$(window).height()/2?"n":"s"};$(d20.textchat.childWindow.document.body).find(".showtip").tipsy({live:!0,gravity:r,opacity:.5,html:!0,containerel:$(d20.textchat.childWindow.document.body)}),$(d20.textchat.childWindow.document.body).find(".userscript-showtip").tipsy({live:!0,gravity:r,opacity:1,html:!0,filterhtml:!0,userscript:!0,containerel:$(d20.textchat.childWindow.document.body)}),s=!0,$(d20.textchat.childWindow.document).on("click","a",function(t){if(!($(this).hasClass("lightly")||$(this).parents(".redactor_box").length>0)){var e=$(this).attr("href");if(void 0!==e){if(-1!==e.indexOf("journal.roll20.net")){var r=e.split("/")[3],n=e.split("/")[4],i=d20.Campaign[r+"s"].get(n);if(i){var o=i.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(o,"all")||window.currentPlayer&&-1!==_.indexOf(o,window.currentPlayer.id))&&i.view.showDialog()}return $("#existing"+r+"s").find("tr[data-"+r+"id="+n+"]").trigger("click"),!1}if(-1!==e.indexOf("javascript:"))return!1;if("!"===e.substring(0,1))return d20.textchat.doChatInput(e),!1;if("~"===e.substring(0,1))return d20.textchat.doChatInput("%{"+e.substring(1,e.length)+"}"),!1;if(void 0!==e&&("external"===$(this).attr("rel")||-1===e.indexOf("javascript:")&&-1!==e.indexOf("://"))){t.stopPropagation(),t.preventDefault();var s=$('<div class="dialog dialog-danger">'+e+"<br /><br />This link will open up a new window (or tab) to an external site. Just close the new window/tab to return to the editor.</div>");s.dialog({modal:!0,title:"Confirm External Link",buttons:{Continue:function(){$(this).dialog("destroy").remove(),window.open(e)},Cancel:function(){$(this).dialog("destroy").remove()}},beforeClose:function(){$(this).dialog("destroy").remove()}})}}}})},d20.textchat.childWindow.onbeforeunload=function(){textchatpopped=!1,setTimeout(function(){$("#rightsidebar").find("a[href=#textchat]").trigger("click")},100),t.appendTo(r),e.appendTo($("body")),d20.textchat.$textarea.autocomplete("widget").appendTo($("body")),t.scrollTop(t[0].scrollHeight),window.allChildWindows=_.without(window.allChildWindows,d20.textchat.childWindow),s=!1,d20.textchat.childWindow=null},$(d20.textchat.childWindow).bind("focus",function(){s=!0}),$(d20.textchat.childWindow).bind("blur",function(){s=!1})}},$("#textchattab").on("dblclick",function(){d20.textchat.showPopout()}),$("#rightsidebar").resizable({handles:"w",alsoResize:"#textchat-input, #rightsidebar .tabmenu",minWidth:300,start:function(){$("#editor-wrapper, #canvas-overlay").addClass("noshow")},resize:function(){},stop:function(){$("#editor-wrapper, #canvas-overlay").removeClass("noshow"),$(window).trigger("resize"),$("#rightsidebar").css("left","").css("height","100%")}})}),function(t,e){"object"==typeof exports&&exports?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Mustache={})}(this,function(t){function e(t){return"function"==typeof t}function r(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function n(t,e){return f.call(t,e)}function i(t){return!n(g,t)}function o(t){return String(t).replace(/[&<>"'\/]/g,function(t){return m[t]})}function s(e,n){function o(){if(_&&!S)for(;m.length;)delete g[m.pop()];else m=[];_=!1,S=!1}function s(t){if("string"==typeof t&&(t=t.split(y,2)),!d(t)||2!==t.length)throw new Error("Invalid tags: "+t);c=new RegExp(r(t[0])+"\\s*"),p=new RegExp("\\s*"+r(t[1])),h=new RegExp("\\s*"+r("}"+t[1]))}if(!e)return[];var c,p,h,f=[],g=[],m=[],_=!1,S=!1;s(n||t.tags);for(var E,T,A,C,P,R,L=new u(e);!L.eos();){if(E=L.pos,A=L.scanUntil(c))for(var M=0,k=A.length;k>M;++M)C=A.charAt(M),i(C)?m.push(g.length):S=!0,g.push(["text",C,E,E+1]),E+=1,"\n"===C&&o();if(!L.scan(c))break;if(_=!0,T=L.scan(x)||"name",L.scan(v),"="===T?(A=L.scanUntil(b),L.scan(b),L.scanUntil(p)):"{"===T?(A=L.scanUntil(h),L.scan(w),L.scanUntil(p),T="&"):A=L.scanUntil(p),!L.scan(p))throw new Error("Unclosed tag at "+L.pos);if(P=[T,A,E,L.pos],g.push(P),"#"===T||"^"===T)f.push(P);else if("/"===T){if(R=f.pop(),!R)throw new Error('Unopened section "'+A+'" at '+E);if(R[1]!==A)throw new Error('Unclosed section "'+R[1]+'" at '+E)}else"name"===T||"{"===T||"&"===T?S=!0:"="===T&&s(A)}if(R=f.pop())throw new Error('Unclosed section "'+R[1]+'" at '+L.pos);return l(a(g))}function a(t){for(var e,r,n=[],i=0,o=t.length;o>i;++i)e=t[i],e&&("text"===e[0]&&r&&"text"===r[0]?(r[1]+=e[1],r[3]=e[3]):(n.push(e),r=e));return n}function l(t){for(var e,r,n=[],i=n,o=[],s=0,a=t.length;a>s;++s)switch(e=t[s],e[0]){case"#":case"^":i.push(e),o.push(e),i=e[4]=[];break;case"/":r=o.pop(),r[5]=e[2],i=o.length>0?o[o.length-1][4]:n;break;default:i.push(e)}return n}function u(t){this.string=t,this.tail=t,this.pos=0}function c(t,e){this.view=null==t?{}:t,this.cache={".":this.view},this.parent=e}function p(){this.cache={}}var h=Object.prototype.toString,d=Array.isArray||function(t){return"[object Array]"===h.call(t)},f=RegExp.prototype.test,g=/\S/,m={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},v=/\s*/,y=/\s+/,b=/\s*=/,w=/\s*\}/,x=/#|\^|\/|>|\{|&|=|!/;u.prototype.eos=function(){return""===this.tail},u.prototype.scan=function(t){var e=this.tail.match(t);if(!e||0!==e.index)return"";var r=e[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r},u.prototype.scanUntil=function(t){var e,r=this.tail.search(t);switch(r){case-1:e=this.tail,this.tail="";break;case 0:e="";break;default:e=this.tail.substring(0,r),this.tail=this.tail.substring(r)}return this.pos+=e.length,e},c.prototype.push=function(t){return new c(t,this)},c.prototype.lookup=function(t){var r,n=this.cache;if(t in n)r=n[t];else{for(var i,o,s=this;s;){if(t.indexOf(".")>0)for(r=s.view,i=t.split("."),o=0;null!=r&&o<i.length;)r=r[i[o++]];else"object"==typeof s.view&&(r=s.view[t]);if(null!=r)break;s=s.parent}n[t]=r}return e(r)&&(r=r.call(this.view)),r},p.prototype.clearCache=function(){this.cache={}},p.prototype.parse=function(t,e){var r=this.cache,n=r[t];return null==n&&(n=r[t]=s(t,e)),n},p.prototype.render=function(t,e,r){var n=this.parse(t),i=e instanceof c?e:new c(e);return this.renderTokens(n,i,r,t)},p.prototype.renderTokens=function(t,r,n,i){function o(t){return u.render(t,r,n)}for(var s,a,l="",u=this,c=0,p=t.length;p>c;++c)switch(s=t[c],s[0]){case"#":var h=(s[1]+"").split(" ");if("()"===h[0].substring(h[0].length-2,h[0].length)?(a=r.lookup(h[0]),h.splice(0,1)):a=r.lookup(s[1]),!a)continue;if(d(a))for(var f=0,g=a.length;g>f;++f)l+=this.renderTokens(s[4],r.push(a[f]),n,i);else if("object"==typeof a||"string"==typeof a)l+=this.renderTokens(s[4],r.push(a),n,i);else if(e(a)){if("string"!=typeof i)throw new Error("Cannot use higher-order sections without the original template");a=a.call(r.view,i.slice(s[3],s[5]),o,h),null!=a&&(l+=a)}else l+=this.renderTokens(s[4],r,n,i);break;case"^":a=r.lookup(s[1]),(!a||d(a)&&0===a.length)&&(l+=this.renderTokens(s[4],r,n,i));break;case">":if(!n)continue;a=e(n)?n(s[1]):n[s[1]],null!=a&&(l+=this.renderTokens(this.parse(a),r,n,a));break;case"&":a=r.lookup(s[1]),null!=a&&(l+=a);break;case"name":a=r.lookup(s[1]),null!=a&&(l+=a);break;case"text":l+=s[1]}return l},t.name="mustache.js",t.version="1.0.0",t.tags=["{{","}}"];var _=new p;t.clearCache=function(){return _.clearCache()},t.parse=function(t,e){return _.parse(t,e)},t.render=function(t,e,r){return _.render(t,e,r)},t.to_html=function(r,n,i,o){var s=t.render(r,n,i);return e(o)?void o(s):s},t.escape=o,t.Scanner=u,t.Context=c,t.Writer=p}),function(){window.Markdown={parse:function(t){{var e=t,r=[],n=[];-1!=e.indexOf("\r\n")?"\r\n":-1!=e.indexOf("\n")?"\n":""}return e=e.replace(/{{{([\s\S]*?)}}}/g,function(t){return r.push(t.substring(3,t.length-3)),"{{{}}}"}),e=e.replace(new RegExp("<pre>([\\s\\S]*?)</pre>","gi"),function(t){return n.push(t.substring(5,t.length-6)),"<pre></pre>"}),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/``(.*?)``/g,"<code>$1</code>"),e=e.replace(/\[([^\]]+)\]\(([^)]+(\.png|\.gif|\.jpg|\.jpeg))\)/g,'<a href="$2"><img src="$2" alt="$1" /></a>'),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2">$1</a>'),e=e.replace(new RegExp("<pre></pre>","g"),function(){return"<pre>"+n.shift()+"</pre>"}),e=e.replace(/{{{}}}/g,function(){return r.shift()})}}}(),function(){function t(t){return function(){return t}}function e(t){var e="Array"===t&&ir.isArray||function(e,r){return(r||pr.call(e))==="[object "+t+"]"};return mr[t]=e}function r(t,e){function r(r){return g(r)?pr.call(r)==="[object "+e+"]":typeof r===t}return mr[e]=r}function n(t){t.SugarMethods||(l(t,"SugarMethods",{}),i(t,!1,!0,{extend:function(e,r,n){i(t,!1!==n,r,e)},sugarRestore:function(){return s(this,t,arguments,function(t,e,r){l(t,e,r.method)})},sugarRevert:function(){return s(this,t,arguments,function(t,e,r){r.existed?l(t,e,r.original):delete t[e]})}}))}function i(t,e,r,i){var o=e?t.prototype:t;n(t),y(i,function(n,i){var s=o[n],u=f(o,n);Tr(r)&&s&&(i=a(s,i,r)),!1===r&&s||l(o,n,i),t.SugarMethods[n]={method:i,existed:u,original:s,instance:e}})}function o(t,e,r,n,o){var s={};n=xr(n)?n.split(","):n,n.forEach(function(t,e){o(s,t,e)}),i(t,e,r,s)}function s(t,e,r,n){var i=0===r.length,o=u(r),s=!1;return y(e.SugarMethods,function(e,r){(i||-1!==o.indexOf(e))&&(s=!0,n(r.instance?t.prototype:t,e,r))}),s}function a(t,e,r){return function(){return r.apply(this,arguments)?e.apply(this,arguments):t.apply(this,arguments)}}function l(t,e,r){dr?nr.defineProperty(t,e,{value:r,configurable:!0,enumerable:!1,writable:!0}):t[e]=r}function u(t,e,r){var n=[];r=r||0;var i;for(i=t.length;i>r;r++)n.push(t[r]),e&&e.call(t,t[r],r);return n}function c(t,e,r){var n=t[r||0];_r(n)&&(t=n,r=0),u(t,e,r)}function p(t){if(!t||!t.call)throw new TypeError("Callback is not callable")}function h(t){return void 0!==t}function d(t){return void 0===t}function f(t,e){return!!t&&hr.call(t,e)}function g(t){return!!t&&("object"==typeof t||fr&&Er(t))}function m(t){var e=typeof t;
return null==t||"string"===e||"number"===e||"boolean"===e}function v(t,e){e=e||pr.call(t);try{if(t&&t.constructor&&!f(t,"constructor")&&!f(t.constructor.prototype,"isPrototypeOf"))return!1}catch(r){return!1}return!!t&&"[object Object]"===e&&"hasOwnProperty"in t}function y(t,e){for(var r in t)if(f(t,r)&&!1===e.call(t,r,t[r],t))break}function b(t,e){for(var r=0;t>r;r++)e(r)}function w(t,e){return y(e,function(r){t[r]=e[r]}),t}function x(t){if(m(t)&&(t=nr(t)),gr&&xr(t))for(var e,r=t,n=0;e=r.charAt(n);)r[n++]=e;return t}function _(t){w(this,x(t))}function S(t,e,r){var n=Pr(10,Cr(e||0));return r=r||Mr,0>e&&(n=1/n),r(t*n)/n}function E(){return"	\n\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u2028\u2029\u3000\ufeff"}function T(t,e){var r="";for(t=t.toString();e>0;)1&e&&(r+=t),(e>>=1)&&(t+=t);return r}function A(t,e){var r,n;return r=t.replace(Ar,function(t){return t=jr[t],t===Nr&&(n=!0),t}),n?parseFloat(r):parseInt(r,e||10)}function C(t,e,r,n){return n=Cr(t).toString(n||10),n=T("0",e-n.replace(/\.\d+/,"").length)+n,(r||0>t)&&(n=(0>t?"-":"+")+n),n}function P(t){if(t>=11&&13>=t)return"th";switch(t%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function R(t,e){function r(t,r){(t||-1<e.indexOf(r))&&(n+=r)}var n="";return e=e||"",r(t.multiline,"m"),r(t.ignoreCase,"i"),r(t.global,"g"),r(t.u,"y"),n}function L(t){return xr(t)||(t=ar(t)),t.replace(/([\\/\'*+?|()\[\]{}.^$])/g,"\\$1")}function M(t,e){return t["get"+(t._utc?"UTC":"")+e]()}function k(t,e,r){return t["set"+(t._utc&&"ISOWeek"!=e?"UTC":"")+e](r)}function B(t,e){var r,n,i,o,s,a,l,u=typeof t;if("string"===u)return t;if(i=pr.call(t),r=v(t,i),n=_r(t,i),null!=t&&r||n){if(e||(e=[]),1<e.length)for(a=e.length;a--;)if(e[a]===t)return"CYC";for(e.push(t),r=t.valueOf()+ar(t.constructor),o=n?t:nr.keys(t).sort(),a=0,l=o.length;l>a;a++)s=n?a:o[a],r+=s+B(t[s],e);e.pop()}else r=-1/0===1/t?"-0":ar(t&&t.valueOf?t.valueOf():t);return u+i+r}function I(t,e){return t===e?0!==t||1/t===1/e:O(t)&&O(e)?B(t)===B(e):!1}function O(t){var e=pr.call(t);return vr.test(e)||v(t,e)}function H(t,e,r){var n,i=t.length,o=e.length,s=!1!==e[o-1];return o>(s?1:2)?(n=[],u(e,function(e){return br(e)?!1:void n.push(F(t,i,e,s,r))}),n):F(t,i,e[0],s,r)}function F(t,e,r,n,i){return n&&(r%=e,0>r&&(r=e+r)),i?t.charAt(r):t[r]}function N(t,e){o(e,!0,!1,t,function(t,e){t[e+("equal"===e?"s":"")]=function(){return nr[e].apply(null,[this].concat(u(arguments)))}})}function D(t,e,r,n){var i=t.length,o=-1==n,s=o?i-1:0;for(r=isNaN(r)?s:parseInt(r>>0),0>r&&(r=i+r),(!o&&0>r||o&&r>=i)&&(r=s);o&&r>=0||!o&&i>r;){if(t[r]===e)return r;r+=n}return-1}function j(t,e,r,n){var i=t.length,o=0,s=h(r);if(p(e),0==i&&!s)throw new TypeError("Reduce called on empty array with no initial value");for(s||(r=t[n?i-1:o],o++);i>o;)s=n?i-o-1:o,s in t&&(r=e(r,t[s],s,t)),o++;return r}function $(t){if(0===t.length)throw new TypeError("First argument must be defined")}function G(t){return t=or(t),function(e){return t.test(e)}}function U(t){var e=t.getTime();return function(t){return!(!t||!t.getTime)&&t.getTime()===e}}function z(t){return function(e,r,n){return e===t||t.call(this,e,r,n)}}function q(t){return function(e,r,n){return e===t||t.call(n,r,e,n)}}function X(t,e){var r={};return function(n,i,o){var s;if(!g(n))return!1;for(s in t)if(r[s]=r[s]||V(t[s],e),!1===r[s].call(o,n[s],i,o))return!1;return!0}}function K(t){return function(e){return e===t||I(e,t)}}function V(t,e){if(!m(t)){if(Er(t))return G(t);if(Sr(t))return U(t);if(Tr(t))return e?q(t):z(t);if(v(t))return X(t,e)}return K(t)}function Y(t,e,r,n){return e?e.apply?e.apply(r,n||[]):Tr(t[e])?t[e].call(t):t[e]:t}function W(t,e,r,n){var i=+t.length;for(0>r&&(r=t.length+r),r=isNaN(r)?0:r,!0===n&&(i+=r);i>r;){if(n=r%t.length,!(n in t)){Q(t,e,r);break}if(!1===e.call(t,t[n],n,t))break;r++}}function Q(t,e,r){var n,i=[];for(n in t)n in t&&n>>>0==n&&4294967295!=n&&n>=r&&i.push(parseInt(n));i.sort().each(function(r){return e.call(t,t[r],r,t)})}function J(t,e,r,n,i,o){var s,a,l;return 0<t.length&&(l=V(e),W(t,function(e,r){return l.call(o,e,r,t)?(s=e,a=r,!1):void 0},r,n)),i?a:s}function Z(t,e){var r,n=[],i={};return W(t,function(o,s){r=e?Y(o,e,t,[o,s,t]):o,ie(i,r)||n.push(o)}),n}function te(t,e,r){var n=[],i={};return e.each(function(t){ie(i,t)}),t.each(function(t){var e=B(t),o=!O(t);if(ne(i,e,t,o)!==r){var s=0;if(o)for(e=i[e];s<e.length;)e[s]===t?e.splice(s,1):s+=1;else delete i[e];n.push(t)}}),n}function ee(t,e,r){e=e||1/0,r=r||0;var n=[];return W(t,function(t){_r(t)&&e>r?n=n.concat(ee(t,e,r+1)):n.push(t)}),n}function re(t){var e=[];return u(t,function(t){e=e.concat(t)}),e}function ne(t,e,r,n){var i=e in t;return n&&(t[e]||(t[e]=[]),i=-1!==t[e].indexOf(r)),i}function ie(t,e){var r=B(e),n=!O(e),i=ne(t,r,e,n);return n?t[r].push(e):t[r]=e,i}function oe(t,e,r,n){var i,o,s,a=[],l="max"===r,u="min"===r,c=ir.isArray(t);for(i in t)if(t.hasOwnProperty(i)){if(r=t[i],s=Y(r,e,t,c?[r,parseInt(i),t]:[]),d(s))throw new TypeError("Cannot compare with undefined");s===o?a.push(r):(d(o)||l&&s>o||u&&o>s)&&(a=[r],o=s)}return c||(a=ee(a,1)),n?a:a[0]}function se(t,e){var r,n,i,o,s=0,a=0;r=ir[zr],n=ir[qr];var l=ir[Xr],u=ir[Ur],c=ir[Kr];t=ae(t,r,n),e=ae(e,r,n);do r=t.charAt(s),i=l[r]||r,r=e.charAt(s),o=l[r]||r,r=i?u.indexOf(i):null,n=o?u.indexOf(o):null,-1===r||-1===n?(r=t.charCodeAt(s)||null,n=e.charCodeAt(s)||null,c&&(r>=Ir&&Or>=r||r>=Hr&&Fr>=r)&&(n>=Ir&&Or>=n||n>=Hr&&Fr>=n)&&(r=A(t.slice(s)),n=A(e.slice(s)))):(i=i!==t.charAt(s),o=o!==e.charAt(s),i!==o&&0===a&&(a=i-o)),s+=1;while(null!=r&&null!=n&&r===n);return r===n?a:r-n}function ae(t,e,r){return xr(t)||(t=ar(t)),r&&(t=t.toLowerCase()),e&&(t=t.replace(e,"")),t}function le(t,e){o(nr,!1,!0,t,function(t,r){t[r]=function(t,n,i){var o,s=nr.keys(x(t));return e||(o=V(n,!0)),i=ir.prototype[r].call(s,function(r){var i=t[r];return e?Y(i,n,t,[r,i,t]):o(i,r,t)},i),_r(i)&&(i=i.reduce(function(e,r){return e[r]=t[r],e},{})),i}}),N(t,_)}function ue(t){w(this,t),this.g=an.concat()}function ce(t,e,r){var n,i,o=e[0],s=e[1],a=e[2];return e=t[r]||t.relative,Tr(e)?e.call(t,o,s,a,r):(i=t.units[8*(t.plural&&o>1?1:0)+s]||t.units[s],t.capitalizeUnit&&(i=ve(i)),n=t.modifiers.filter(function(t){return"sign"==t.name&&t.value==(a>0?1:-1)})[0],e.replace(/\{(.*?)\}/g,function(t,e){switch(e){case"num":return o;case"unit":return i;case"sign":return n.src}}))}function pe(t,e){return e=e||t.code,"en"===e||"en-US"===e?!0:t.variant}function he(t,e){return e.replace(or(t.num,"g"),function(e){return de(t,e)||""})}function de(t,e){var r;return wr(e)?e:e&&-1!==(r=t.numbers.indexOf(e))?(r+1)%10:1}function fe(t,e){var r;if(xr(t)||(t=""),r=pn[t]||pn[t.slice(0,2)],!1===e&&!r)throw new TypeError("Invalid locale.");return r||Zr}function ge(t,e){function r(t){var e=a[t];xr(e)?a[t]=e.split(","):e||(a[t]=[])}function n(t,e){t=t.split("+").map(function(t){return t.replace(/(.+):(.+)$/,function(t,e,r){return r.split("|").map(function(t){return e+t}).join("|")})}).join("|"),t.split("|").forEach(e)}function i(t,e,r){var i=[];a[t].forEach(function(t,o){e&&(t+="+"+t.slice(0,3)),n(t,function(t,e){i[e*r+o]=t.toLowerCase()})}),a[t]=i}function o(t,e,r){return t="\\d{"+t+","+e+"}",r&&(t+="|(?:"+ye(a.numbers)+")+"),t}function s(t,e){a[t]=a[t]||e}var a,l;return a=new ue(e),r("modifiers"),"months weekdays units numbers articles tokens timeMarker ampm timeSuffixes dateParse timeParse".split(" ").forEach(r),l=!a.monthSuffix,i("months",l,12),i("weekdays",l,7),i("units",!1,8),i("numbers",!1,10),s("code",t),s("date",o(1,2,a.digitDate)),s("year","'\\d{2}|"+o(4,4)),s("num",function(){var t=["-?\\d+"].concat(a.articles);return a.numbers&&(t=t.concat(a.numbers)),ye(t)}()),function(){var t=[];a.i={},a.modifiers.push({name:"day",src:"yesterday",value:-1}),a.modifiers.push({name:"day",src:"today",value:0}),a.modifiers.push({name:"day",src:"tomorrow",value:1}),a.modifiers.forEach(function(e){var r=e.name;n(e.src,function(n){var i=a[r];a.i[n]=e,t.push({name:r,src:n,value:e.value}),a[r]=i?i+"|"+n:n})}),a.day+="|"+ye(a.weekdays),a.modifiers=t}(),a.monthSuffix&&(a.month=o(1,2),a.months="1 2 3 4 5 6 7 8 9 10 11 12".split(" ").map(function(t){return t+a.monthSuffix})),a.full_month=o(1,2)+"|"+ye(a.months),0<a.timeSuffixes.length&&a.addFormat(Fe(a),!1,nn),a.addFormat("{day}",!0),a.addFormat("{month}"+(a.monthSuffix||"")),a.addFormat("{year}"+(a.yearSuffix||"")),a.timeParse.forEach(function(t){a.addFormat(t,!0)}),a.dateParse.forEach(function(t){a.addFormat(t)}),pn[t]=a}function me(t,e,r,n){t.g.unshift({r:n,locale:t,q:or("^"+e+"$","i"),to:r})}function ve(t){return t.slice(0,1).toUpperCase()+t.slice(1)}function ye(t){return t.filter(function(t){return!!t}).join("|")}function be(){var t=sr.SugarNewDate;return t?t():new sr}function we(t,e){var r;return g(t[0])?t:wr(t[0])&&!wr(t[1])?[t[0]]:xr(t[0])&&e?[xe(t[0]),t[1]]:(r={},en.forEach(function(e,n){r[e.name]=t[n]}),[r])}function xe(t){var e,r={};return(t=t.match(/^(\d+)?\s?(\w+?)s?$/i))&&(d(e)&&(e=parseInt(t[1])||1),r[t[2].toLowerCase()]=e),r}function _e(t,e,r){var n;for(d(r)&&(r=rn.length),e=e||0;r>e&&(n=rn[e],!1!==t(n.name,n,e));e++);}function Se(t,e){var r,n,i={};return e.forEach(function(e,o){r=t[o+1],d(r)||""===r||("year"===e&&(i.t=r.replace(/'/,"")),n=parseFloat(r.replace(/'/,"").replace(/,/,".")),i[e]=isNaN(n)?r.toLowerCase():n)}),i}function Ee(t){return t=t.trim().replace(/^just (?=now)|\.+$/i,""),Te(t)}function Te(t){return t.replace(tn,function(t,e,r){var n,i,o=0,s=1;return e?t:(r.split("").reverse().forEach(function(t){t=sn[t];var e=t>9;e?(n&&(o+=s),s*=t/(i||1),i=t):(!1===n&&(s*=10),o+=s*t),n=e}),n&&(o+=s),o)})}function Ae(t,e,r,n){function i(t){d.push(t)}function o(){d.forEach(function(t){t.call()})}function s(){var t=u.getWeekday();u.setWeekday(7*(m.num-1)+(t>w?w+7:w))}function a(){var t=f.i[m.edge];_e(function(t){return h(m[t])?(v=t,!1):void 0},4),"year"===v?m.e="month":("month"===v||"week"===v)&&(m.e="day"),u[(0>t.value?"endOf":"beginningOf")+ve(v)](),-2===t.value&&u.reset()}function l(){var t;_e(function(e,r,n){if("day"===e&&(e="date"),h(m[e])){if(n>=b)return u.setTime(0/0),!1;t=t||{},t[e]=m[e],delete m[e]}}),t&&i(function(){u.set(t,!0)})}var u,c,p,d,f,m,v,b,w,x,_;return u=be(),d=[],u.utc(n),Sr(t)?u.utc(t.isUTC()).setTime(t.getTime()):wr(t)?u.setTime(t):g(t)?(u.set(t,!0),m=t):xr(t)&&(p=fe(e),t=Ee(t),p&&y(p.o?[p.o].concat(p.g):p.g,function(r,n){var o=t.match(n.q);return o?(f=n.locale,m=Se(o,n.to),f.o=n,m.utc&&u.utc(),m.timestamp?(m=m.timestamp,!1):(n.r&&!xr(m.month)&&(xr(m.date)||pe(p,e))&&(_=m.month,m.month=m.date,m.date=_),m.year&&2===m.t.length&&(m.year=100*Mr(M(be(),"FullYear")/100)-100*Mr(m.year/100)+m.year),m.month&&(m.month=f.getMonth(m.month),m.shift&&!m.unit&&(m.unit=f.units[7])),m.weekday&&m.date?delete m.weekday:m.weekday&&(m.weekday=f.getWeekday(m.weekday),m.shift&&!m.unit&&(m.unit=f.units[5])),m.day&&(_=f.i[m.day])?(m.day=_.value,u.reset(),c=!0):m.day&&-1<(w=f.getWeekday(m.day))&&(delete m.day,m.num&&m.month?(i(s),m.day=1):m.weekday=w),m.date&&!wr(m.date)&&(m.date=he(f,m.date)),m.ampm&&m.ampm===f.ampm[1]&&12>m.hour?m.hour+=12:m.ampm===f.ampm[0]&&12===m.hour&&(m.hour=0),("offset_hours"in m||"offset_minutes"in m)&&(u.utc(),m.offset_minutes=m.offset_minutes||0,m.offset_minutes+=60*m.offset_hours,"-"===m.offset_sign&&(m.offset_minutes*=-1),m.minute-=m.offset_minutes),m.unit&&(c=!0,x=de(f,m.num),b=f.units.indexOf(m.unit)%8,v=Jr.units[b],l(),m.shift&&(x*=(_=f.i[m.shift])?_.value:0),m.sign&&(_=f.i[m.sign])&&(x*=_.value),h(m.weekday)&&(u.set({weekday:m.weekday},!0),delete m.weekday),m[v]=(m[v]||0)+x),m.edge&&i(a),"-"===m.year_sign&&(m.year*=-1),_e(function(t,e,r){e=m[t];var n=e%1;n&&(m[rn[r-1].name]=Mr(n*("second"===t?1e3:60)),m[t]=Lr(e))},1,4),!1)):void 0}),m?c?u.advance(m):(u._utc&&u.reset(),He(u,m,!0,!1,r)):("now"!==t&&(u=new sr(t)),n&&u.addMinutes(-u.getTimezoneOffset())),o(),u.utc(!1)),{c:u,set:m}}function Ce(t){var e,r=Cr(t),n=r,i=0;return _e(function(t,o,s){e=Lr(S(r/o.b(),1)),e>=1&&(n=e,i=s)},1),[n,i,t]}function Pe(t){var e=Ce(t.millisecondsFromNow());return(6===e[1]||5===e[1]&&4===e[0]&&t.daysFromNow()>=be().daysInMonth())&&(e[0]=Cr(t.monthsFromNow()),e[1]=6),e}function Re(t,e,r){function n(t,r){var n=M(t,"Month");return fe(r).months[n+12*e]}Le(t,n,r),Le(ve(t),n,r,1)}function Le(t,e,r,n){un[t]=function(t,i){var o=e(t,i);return r&&(o=o.slice(0,r)),n&&(o=o.slice(0,n).toUpperCase()+o.slice(n)),o}}function Me(t,e,r){un[t]=e,un[t+t]=function(t,r){return C(e(t,r),2)},r&&(un[t+t+t]=function(t,r){return C(e(t,r),3)},un[t+t+t+t]=function(t,r){return C(e(t,r),4)})}function ke(t){var e=t.match(/(\{\w+\})|[^{}]+/g);ln[t]=e.map(function(t){return t.replace(/\{(\w+)\}/,function(e,r){return t=un[r]||r,r}),t})}function Be(t,e,r,n){var i;if(!t.isValid())return"Invalid Date";if(Date[e]?e=Date[e]:Tr(e)&&(i=Pe(t),e=e.apply(t,i.concat(fe(n)))),!e&&r)return i=i||Pe(t),0===i[1]&&(i[1]=1,i[0]=1),t=fe(n),ce(t,i,0<i[2]?"future":"past");e=e||"long",("short"===e||"long"===e||"full"===e)&&(e=fe(n)[e]),ln[e]||ke(e);var o,s;for(i="",e=ln[e],o=0,r=e.length;r>o;o++)s=e[o],i+=Tr(s)?s(t,n):s;return i}function Ie(t,e,r,n,i){var o,s,a,l=0,u=0,c=0;return o=Ae(e,r,null,i),n>0&&(u=c=n,s=!0),o.c.isValid()?(o.set&&o.set.e&&(cn.forEach(function(e){e.name===o.set.e&&(l=e.b(o.c,t-o.c)-1)}),e=ve(o.set.e),(o.set.edge||o.set.shift)&&o.c["beginningOf"+e](),"month"===o.set.e&&(a=o.c.clone()["endOf"+e]().getTime()),!s&&o.set.sign&&"millisecond"!=o.set.e&&(u=50,c=-50)),s=t.getTime(),e=o.c.getTime(),a=Oe(t,e,a||e+l),s>=e-u&&a+c>=s):!1}function Oe(t,e,r){return e=new sr(e),t=new sr(r).utc(t.isUTC()),23!==M(t,"Hours")&&(e=e.getTimezoneOffset(),t=t.getTimezoneOffset(),e!==t&&(r+=(t-e).minutes())),r}function He(t,e,r,n,i){function o(t){return h(e[t])?e[t]:e[t+"s"]}function s(t){return h(o(t))}var a;if(wr(e)&&n)e={milliseconds:e};else if(wr(e))return t.setTime(e),t;h(e.date)&&(e.day=e.date),_e(function(n,i,o){var l="day"===n;return s(n)||l&&s("weekday")?(e.e=n,a=+o,!1):void(!r||"week"===n||l&&s("week")||k(t,i.method,l?1:0))}),cn.forEach(function(r){var i=r.name;r=r.method;var a;a=o(i),d(a)||(n?("week"===i&&(a=(e.day||0)+7*a,r="Date"),a=a*n+M(t,r)):"month"===i&&s("day")&&k(t,"Date",15),k(t,r,a),n&&"month"===i&&(i=a,0>i&&(i=i%12+12),i%12!=M(t,"Month")&&k(t,"Date",0)))}),n||s("day")||!s("weekday")||t.setWeekday(o("weekday"));var l;t:{switch(i){case-1:l=t>be();break t;case 1:l=t<be();break t}l=void 0}return l&&_e(function(e,r){return(r.k||"week"===e&&s("weekday"))&&!(s(e)||"day"===e&&s("weekday"))?(t[r.j](i),!1):void 0},a+1),t}function Fe(t,e){var r,n=on,i={h:0,m:1,s:2};return t=t||Jr,n.replace(/{([a-z])}/g,function(n,o){var s=[],a="h"===o,l=a&&!e;return"t"===o?t.ampm.join("|"):(a&&s.push(":"),(r=t.timeSuffixes[i[o]])&&s.push(r+"\\s*"),0===s.length?"":"(?:"+s.join("|")+")"+(l?"":"?"))})}function Ne(t,e,r){var n,i;return wr(t[1])?n=we(t)[0]:(n=t[0],i=t[1]),Ae(n,i,e,r).c}function De(t,e){function r(){return Mr(this*e)}function n(){return Ne(arguments)[t.j](this)}function i(){return Ne(arguments)[t.j](-this)}var o=t.name,s={};s[o]=r,s[o+"s"]=r,s[o+"Before"]=i,s[o+"sBefore"]=i,s[o+"Ago"]=i,s[o+"sAgo"]=i,s[o+"After"]=n,s[o+"sAfter"]=n,s[o+"FromNow"]=n,s[o+"sFromNow"]=n,lr.extend(s)}function je(t,e){this.start=$e(t),this.end=$e(e)}function $e(t){return Sr(t)?new sr(t.getTime()):null==t?t:Sr(t)?t.getTime():t.valueOf()}function Ge(t){return t=null==t?t:Sr(t)?t.getTime():t.valueOf(),!!t||0===t}function Ue(t,e){var r,n,i,o;return wr(e)?new sr(t.getTime()+e):(r=e[0],n=e[1],i=M(t,n),o=new sr(t.getTime()),k(o,n,i+r),o)}function ze(t,e){return ar.fromCharCode(t.charCodeAt(0)+e)}function qe(t,e){return t+e}function Xe(t,e,r,n,i){1/0!==e&&(t.timers||(t.timers=[]),wr(e)||(e=1),t.n=!1,t.timers.push(setTimeout(function(){t.n||r.apply(n,i||[])},e)))}function Ke(t,e,r,n,i,o){var s=t.toFixed(20),a=s.search(/\./),s=s.search(/[1-9]/),a=a-s;return a>0&&(a-=1),i=Br(kr(Lr(a/3),!1===i?r.length:i),-n),n=r.charAt(i+n-1),-9>a&&(i=-3,e=Cr(a)-9,n=r.slice(0,1)),r=o?Pr(2,10*i):Pr(10,3*i),S(t/r,e||0).format()+n.trim()}function Ve(t,e,r,n){var i,o,s;(o=e.match(/^(.+?)(\[.*\])$/))?(s=o[1],e=o[2].replace(/^\[|\]$/g,"").split("]["),e.forEach(function(e){i=!e||e.match(/^\d+$/),!s&&_r(t)&&(s=t.length),f(t,s)||(t[s]=i?[]:{}),t=t[s],s=e}),!s&&i&&(s=t.length.toString()),Ve(t,s,r,n)):t[e]=n&&"true"===r?!0:n&&"false"===r?!1:r}function Ye(t,e){var r;return _r(e)||g(e)&&e.toString===pr?(r=[],y(e,function(e,n){t&&(e=t+"["+e+"]"),r.push(Ye(e,n))}),r.join("&")):t?We(t)+"="+(Sr(e)?e.getTime():We(e)):""}function We(t){return t||!1===t||0===t?encodeURIComponent(t).replace(/%20/g,"+"):""}function Qe(t,e,r){var n,i=t instanceof _?new _:{};return y(t,function(t,o){n=!1,c(e,function(e){(Er(e)?e.test(t):g(e)?e[t]===o:t===ar(e))&&(n=!0)},1),n===r&&(i[t]=o)}),i}function Je(t){if(t=+t,0>t||1/0===t)throw new RangeError("Invalid number");return t}function Ze(t,e){return T(h(e)?e:" ",t)}function tr(t,e,r,n,i){var o;if(t.length<=e)return t.toString();switch(n=d(n)?"...":n,r){case"left":return t=i?er(t,e,!0):t.slice(t.length-e),n+t;case"middle":return r=Rr(e/2),o=Lr(e/2),e=i?er(t,r):t.slice(0,r),t=i?er(t,o,!0):t.slice(t.length-o),e+n+t;default:return e=i?er(t,e):t.slice(0,e),e+n}}function er(t,e,r){if(r)return er(t.reverse(),e).reverse();r=or("(?=["+E()+"])");var n=0;return t.split(r).filter(function(t){return n+=t.length,e>=n}).join("")}function rr(t,e,r){return xr(e)&&(e=t.indexOf(e),-1===e&&(e=r?t.length:0)),e}var nr=Object,ir=Array,or=RegExp,sr=Date,ar=String,lr=Number,ur=Math,cr="undefined"!=typeof global?global:this,pr=nr.prototype.toString,hr=nr.prototype.hasOwnProperty,dr=nr.defineProperty&&nr.defineProperties,fr="function"==typeof or(),gr=!("0"in new ar("a")),mr={},vr=/^\[object Date|Array|String|Number|RegExp|Boolean|Arguments\]$/,yr="Boolean Number String Array Date RegExp Function".split(" "),br=r("boolean",yr[0]),wr=r("number",yr[1]),xr=r("string",yr[2]),_r=e(yr[3]),Sr=e(yr[4]),Er=e(yr[5]),Tr=e(yr[6]);_.prototype.constructor=nr;var Ar,Cr=ur.abs,Pr=ur.pow,Rr=ur.ceil,Lr=ur.floor,Mr=ur.round,kr=ur.min,Br=ur.max,Ir=48,Or=57,Hr=65296,Fr=65305,Nr=".",Dr="",jr={};n(nr),y(yr,function(t,e){n(cr[e])});var $r,Gr;for(Gr=0;9>=Gr;Gr++)$r=ar.fromCharCode(Gr+Hr),Dr+=$r,jr[$r]=ar.fromCharCode(Gr+Ir);jr[","]="",jr["\uff0e"]=Nr,jr[Nr]=Nr,Ar=or("["+Dr+"\uff0e,"+Nr+"]","g"),i(nr,!1,!1,{keys:function(t){var e=[];if(!g(t)&&!Er(t)&&!Tr(t))throw new TypeError("Object required");return y(t,function(t){e.push(t)}),e}}),i(ir,!1,!1,{isArray:function(t){return _r(t)}}),i(ir,!0,!1,{every:function(t,e){var r=this.length,n=0;for($(arguments);r>n;){if(n in this&&!t.call(e,this[n],n,this))return!1;n++}return!0},some:function(t,e){var r=this.length,n=0;for($(arguments);r>n;){if(n in this&&t.call(e,this[n],n,this))return!0;n++}return!1},map:function(t,e){e=arguments[1];var r=this.length,n=0,i=Array(r);for($(arguments);r>n;)n in this&&(i[n]=t.call(e,this[n],n,this)),n++;return i},filter:function(t){var e=arguments[1],r=this.length,n=0,i=[];for($(arguments);r>n;)n in this&&t.call(e,this[n],n,this)&&i.push(this[n]),n++;return i},indexOf:function(t,e){return xr(this)?this.indexOf(t,e):D(this,t,e,1)},lastIndexOf:function(t,e){return xr(this)?this.lastIndexOf(t,e):D(this,t,e,-1)},forEach:function(t,e){var r=this.length,n=0;for(p(t);r>n;)n in this&&t.call(e,this[n],n,this),n++},reduce:function(t,e){return j(this,t,e)},reduceRight:function(t,e){return j(this,t,e,!0)}}),i(Function,!0,!1,{bind:function(t){var e,r=this,n=u(arguments,null,1);if(!Tr(this))throw new TypeError("Function.prototype.bind called on a non-function");return e=function(){return r.apply(r.prototype&&this instanceof r?this:t,n.concat(u(arguments)))},e.prototype=this.prototype,e}}),i(sr,!1,!1,{now:function(){return(new sr).getTime()}}),function(){var t=E().match(/^\s+$/);try{ar.prototype.trim.call([1])}catch(e){t=!1}i(ar,!0,!t,{trim:function(){return this.toString().trimLeft().trimRight()},trimLeft:function(){return this.replace(or("^["+E()+"]+"),"")},trimRight:function(){return this.replace(or("["+E()+"]+$"),"")}})}(),function(){var t=new sr(sr.UTC(1999,11,31)),t=t.toISOString&&"1999-12-31T00:00:00.000Z"===t.toISOString();o(sr,!0,!t,"toISOString,toJSON",function(t,e){t[e]=function(){return C(this.getUTCFullYear(),4)+"-"+C(this.getUTCMonth()+1,2)+"-"+C(this.getUTCDate(),2)+"T"+C(this.getUTCHours(),2)+":"+C(this.getUTCMinutes(),2)+":"+C(this.getUTCSeconds(),2)+"."+C(this.getUTCMilliseconds(),3)+"Z"}})}();var Ur="AlphanumericSortOrder",zr="AlphanumericSortIgnore",qr="AlphanumericSortIgnoreCase",Xr="AlphanumericSortEquivalents",Kr="AlphanumericSortNatural";i(ir,!1,!0,{create:function(){var t=[];return u(arguments,function(e){(!m(e)&&"length"in e&&("[object Arguments]"===pr.call(e)||e.callee)||!m(e)&&"length"in e&&!xr(e)&&!v(e))&&(e=ir.prototype.slice.call(e,0)),t=t.concat(e)}),t}}),i(ir,!0,!1,{find:function(t,e){return p(t),J(this,t,0,!1,!1,e)},findIndex:function(t,e){var r;return p(t),r=J(this,t,0,!1,!0,e),d(r)?-1:r}}),i(ir,!0,!0,{findFrom:function(t,e,r){return J(this,t,e,r)},findIndexFrom:function(t,e,r){return e=J(this,t,e,r,!0),d(e)?-1:e},findAll:function(t,e,r){var n,i=[];return 0<this.length&&(n=V(t),W(this,function(t,e,r){n(t,e,r)&&i.push(t)},e,r)),i},count:function(t){return d(t)?this.length:this.findAll(t).length},removeAt:function(t,e){return d(t)?this:(d(e)&&(e=t),this.splice(t,e-t+1),this)},include:function(t,e){return this.clone().add(t,e)},exclude:function(){return ir.prototype.remove.apply(this.clone(),arguments)},clone:function(){return w([],this)},unique:function(t){return Z(this,t)},flatten:function(t){return ee(this,t)},union:function(){return Z(this.concat(re(arguments)))},intersect:function(){return te(this,re(arguments),!1)},subtract:function(){return te(this,re(arguments),!0)},at:function(){return H(this,arguments)},first:function(t){return d(t)?this[0]:(0>t&&(t=0),this.slice(0,t))},last:function(t){return d(t)?this[this.length-1]:this.slice(0>this.length-t?0:this.length-t)},from:function(t){return this.slice(t)},to:function(t){return d(t)&&(t=this.length),this.slice(0,t)},min:function(t,e){return oe(this,t,"min",e)},max:function(t,e){return oe(this,t,"max",e)},least:function(t,e){return oe(this.groupBy.apply(this,[t]),"length","min",e)},most:function(t,e){return oe(this.groupBy.apply(this,[t]),"length","max",e)},sum:function(t){return t=t?this.map(t):this,0<t.length?t.reduce(function(t,e){return t+e}):0},average:function(t){return t=t?this.map(t):this,0<t.length?t.sum()/t.length:0},inGroups:function(t,e){var r=1<arguments.length,n=this,i=[],o=Rr(this.length/t);return b(t,function(t){t*=o;var s=n.slice(t,t+o);r&&s.length<o&&b(o-s.length,function(){s=s.add(e)}),i.push(s)}),i},inGroupsOf:function(t,e){var r,n=[],i=this.length,o=this;return 0===i||0===t?o:(d(t)&&(t=1),d(e)&&(e=null),b(Rr(i/t),function(i){for(r=o.slice(t*i,t*i+t);r.length<t;)r.push(e);n.push(r)}),n)},isEmpty:function(){return 0==this.compact().length},sortBy:function(t,e){var r=this.clone();return r.sort(function(n,i){var o,s;return o=Y(n,t,r,[n]),s=Y(i,t,r,[i]),(xr(o)&&xr(s)?se(o,s):s>o?-1:o>s?1:0)*(e?-1:1)}),r},randomize:function(){for(var t,e,r=this.concat(),n=r.length;n;)t=ur.random()*n|0,e=r[--n],r[n]=r[t],r[t]=e;return r},zip:function(){var t=u(arguments);return this.map(function(e,r){return[e].concat(t.map(function(t){return r in t?t[r]:null}))})},sample:function(t){var e=this.randomize();return 0<arguments.length?e.slice(0,t):e[0]},each:function(t,e,r){return W(this,t,e,r),this},add:function(t,e){return(!wr(lr(e))||isNaN(e))&&(e=this.length),ir.prototype.splice.apply(this,[e,0].concat(t)),this},remove:function(){var t=this;return u(arguments,function(e){var r=0;for(e=V(e);r<t.length;)e(t[r],r,t)?t.splice(r,1):r++}),t},compact:function(t){var e=[];return W(this,function(r){_r(r)?e.push(r.compact()):t&&r?e.push(r):t||null==r||r.valueOf()!==r.valueOf()||e.push(r)}),e},groupBy:function(t,e){var r,n=this,i={};return W(n,function(e,o){r=Y(e,t,n,[e,o,n]),i[r]||(i[r]=[]),i[r].push(e)}),e&&y(i,e),i},none:function(){return!this.any.apply(this,arguments)}}),i(ir,!0,!0,{all:ir.prototype.every,any:ir.prototype.some,insert:ir.prototype.add}),i(nr,!1,!0,{map:function(t,e){var r,n,i={};for(r in t)f(t,r)&&(n=t[r],i[r]=Y(n,e,t,[r,n,t]));return i},reduce:function(t){var e=nr.keys(x(t)).map(function(e){return t[e]});return e.reduce.apply(e,u(arguments,null,1))},each:function(t,e){return p(e),y(t,e),t},size:function(t){return nr.keys(x(t)).length}});var Vr="any all none count find findAll isEmpty".split(" "),Yr="sum average min max least most".split(" "),Wr=["map","reduce","size"],Qr=Vr.concat(Yr).concat(Wr);!function(){function t(){var t=arguments;return 0<t.length&&!Tr(t[0])}var e=ir.prototype.map;o(ir,!0,t,"every,all,some,filter,any,none,find,findIndex",function(t,e){var r=ir.prototype[e];t[e]=function(t){var e=V(t);return r.call(this,function(t,r){return e(t,r,this)})}}),i(ir,!0,t,{map:function(t){return e.call(this,function(e,r){return Y(e,t,this,[e,r,this])})}})}(),function(){ir[Ur]="A\xc1\xc0\xc2\xc3\u0104BC\u0106\u010c\xc7D\u010e\xd0E\xc9\xc8\u011a\xca\xcb\u0118FG\u011eH\u0131I\xcd\xcc\u0130\xce\xcfJKL\u0141MN\u0143\u0147\xd1O\xd3\xd2\xd4PQR\u0158S\u015a\u0160\u015eT\u0164U\xda\xd9\u016e\xdb\xdcVWXY\xddZ\u0179\u017b\u017d\xde\xc6\u0152\xd8\xd5\xc5\xc4\xd6".split("").map(function(t){return t+t.toLowerCase()}).join("");var t={};W("A\xc1\xc0\xc2\xc3\xc4 C\xc7 E\xc9\xc8\xca\xcb I\xcd\xcc\u0130\xce\xcf O\xd3\xd2\xd4\xd5\xd6 S\xdf U\xda\xd9\xdb\xdc".split(" "),function(e){var r=e.charAt(0);W(e.slice(1).split(""),function(e){t[e]=r,t[e.toLowerCase()]=r.toLowerCase()})}),ir[Kr]=!0,ir[qr]=!0,ir[Xr]=t}(),le(Vr),le(Yr,!0),N(Wr,_),ir.AlphanumericSort=se;var Jr,Zr,tn,en,rn,nn="ampm hour minute second ampm utc offset_sign offset_hours offset_minutes ampm".split(" "),on="({t})?\\s*(\\d{1,2}(?:[,.]\\d+)?)(?:{h}([0-5]\\d(?:[,.]\\d+)?)?{m}(?::?([0-5]\\d(?:[,.]\\d+)?){s})?\\s*(?:({t})|(Z)|(?:([+-])(\\d{2,2})(?::?(\\d{2,2}))?)?)?|\\s*({t}))",sn={},an=[],ln={},un={yyyy:function(t){return M(t,"FullYear")},yy:function(t){return M(t,"FullYear")%100},ord:function(t){return t=M(t,"Date"),t+P(t)},tz:function(t){return t.getUTCOffset()},isotz:function(t){return t.getUTCOffset(!0)},Z:function(t){return t.getUTCOffset()},ZZ:function(t){return t.getUTCOffset().replace(/(\d{2})$/,":$1")}},cn=[{name:"year",method:"FullYear",k:!0,b:function(t){return 864e5*(365+(t?t.isLeapYear()?1:0:.25))}},{name:"month",error:.919,method:"Month",k:!0,b:function(t,e){var r,n=30.4375;return t&&(r=t.daysInMonth(),e<=r.days()&&(n=r)),864e5*n}},{name:"week",method:"ISOWeek",b:t(6048e5)},{name:"day",error:.958,method:"Date",k:!0,b:t(864e5)},{name:"hour",method:"Hours",b:t(36e5)},{name:"minute",method:"Minutes",b:t(6e4)},{name:"second",method:"Seconds",b:t(1e3)},{name:"millisecond",method:"Milliseconds",b:t(1)}],pn={};ue.prototype={getMonth:function(t){return wr(t)?t-1:this.months.indexOf(t)%12},getWeekday:function(t){return this.weekdays.indexOf(t)%7},addFormat:function(t,e,r,n,i){var o,s=r||[],a=this;t=t.replace(/\s+/g,"[,. ]*"),t=t.replace(/\{([^,]+?)\}/g,function(t,e){var n,i,o,l=e.match(/\?$/);o=e.match(/^(\d+)\??$/);var u=e.match(/(\d)(?:-(\d))?/),c=e.replace(/[^a-z]+$/,"");return o?n=a.tokens[o[1]]:a[c]?n=a[c]:a[c+"s"]&&(n=a[c+"s"],u&&(i=[],n.forEach(function(t,e){var r=e%(a.units?8:n.length);r>=u[1]&&r<=(u[2]||u[1])&&i.push(t)}),n=i),n=ye(n)),o?o="(?:"+n+")":(r||s.push(c),o="("+n+")"),l&&(o+="?"),o}),e?(e=Fe(a,i),i=["t","[\\s\\u3000]"].concat(a.timeMarker),o=t.match(/\\d\{\d,\d\}\)+\??$/),me(a,"(?:"+e+")[,\\s\\u3000]+?"+t,nn.concat(s),n),me(a,t+"(?:[,\\s]*(?:"+i.join("|")+(o?"+":"*")+")"+e+")?",s.concat(nn),n)):me(a,t,s,n)}},i(sr,!1,!0,{create:function(){return Ne(arguments)},past:function(){return Ne(arguments,-1)},future:function(){return Ne(arguments,1)},addLocale:function(t,e){return ge(t,e)},setLocale:function(t){var e=fe(t,!1);return Zr=e,t&&t!=e.code&&(e.code=t),e},getLocale:function(t){return t?fe(t,!1):Zr},addFormat:function(t,e,r){me(fe(r),t,e)}}),i(sr,!0,!0,{set:function(){var t=we(arguments);return He(this,t[0],t[1])},setWeekday:function(t){return d(t)?void 0:k(this,"Date",M(this,"Date")+t-M(this,"Day"))},setISOWeek:function(t){var e=M(this,"Day")||7;return d(t)?void 0:(this.set({month:0,date:4}),this.set({weekday:1}),t>1&&this.addWeeks(t-1),1!==e&&this.advance({days:e-1}),this.getTime())},getISOWeek:function(){var t;t=this.clone();var e=M(t,"Day")||7;return t.addDays(4-e).reset(),1+Lr(t.daysSince(t.clone().beginningOfYear())/7)},beginningOfISOWeek:function(){var t=this.getDay();return 0===t?t=-6:1!==t&&(t=1),this.setWeekday(t),this.reset()},endOfISOWeek:function(){return 0!==this.getDay()&&this.setWeekday(7),this.endOfDay()},getUTCOffset:function(t){var e=this._utc?0:this.getTimezoneOffset(),r=!0===t?":":"";return!e&&t?"Z":C(Lr(-e/60),2,!0)+r+C(Cr(e%60),2)},utc:function(t){return l(this,"_utc",!0===t||0===arguments.length),this},isUTC:function(){return!!this._utc||0===this.getTimezoneOffset()},advance:function(){var t=we(arguments,!0);return He(this,t[0],t[1],1)},rewind:function(){var t=we(arguments,!0);return He(this,t[0],t[1],-1)},isValid:function(){return!isNaN(this.getTime())},isAfter:function(t,e){return this.getTime()>sr.create(t).getTime()-(e||0)},isBefore:function(t,e){return this.getTime()<sr.create(t).getTime()+(e||0)},isBetween:function(t,e,r){var n=this.getTime();t=sr.create(t).getTime();var i=sr.create(e).getTime();return e=kr(t,i),t=Br(t,i),r=r||0,n>e-r&&t+r>n},isLeapYear:function(){var t=M(this,"FullYear");return 0===t%4&&0!==t%100||0===t%400},daysInMonth:function(){return 32-M(new sr(M(this,"FullYear"),M(this,"Month"),32),"Date")},format:function(t,e){return Be(this,t,!1,e)},relative:function(t,e){return xr(t)&&(e=t,t=null),Be(this,t,!0,e)},is:function(t,e,r){var n,i;if(this.isValid()){if(xr(t))switch(t=t.trim().toLowerCase(),i=this.clone().utc(r),!0){case"future"===t:return this.getTime()>be().getTime();case"past"===t:return this.getTime()<be().getTime();case"weekday"===t:return 0<M(i,"Day")&&6>M(i,"Day");case"weekend"===t:return 0===M(i,"Day")||6===M(i,"Day");case-1<(n=Jr.weekdays.indexOf(t)%7):return M(i,"Day")===n;case-1<(n=Jr.months.indexOf(t)%12):return M(i,"Month")===n}return Ie(this,t,null,e,r)}},reset:function(t){var e,r={};return t=t||"hours","date"===t&&(t="days"),e=cn.some(function(e){return t===e.name||t===e.name+"s"}),r[t]=t.match(/^days?/)?1:0,e?this.set(r,!0):this},clone:function(){var t=new sr(this.getTime());return t.utc(!!this._utc),t}}),i(sr,!0,!0,{iso:function(){return this.toISOString()},getWeekday:sr.prototype.getDay,getUTCWeekday:sr.prototype.getUTCDay}),i(lr,!0,!0,{duration:function(t){return t=fe(t),ce(t,Ce(this),"duration")}}),Jr=Zr=sr.addLocale("en",{plural:!0,timeMarker:"at",ampm:"am,pm",months:"January,February,March,April,May,June,July,August,September,October,November,December",weekdays:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday",units:"millisecond:|s,second:|s,minute:|s,hour:|s,day:|s,week:|s,month:|s,year:|s",numbers:"one,two,three,four,five,six,seven,eight,nine,ten",articles:"a,an,the",tokens:"the,st|nd|rd|th,of","short":"{Month} {d}, {yyyy}","long":"{Month} {d}, {yyyy} {h}:{mm}{tt}",full:"{Weekday} {Month} {d}, {yyyy} {h}:{mm}:{ss}{tt}",past:"{num} {unit} {sign}",future:"{num} {unit} {sign}",duration:"{num} {unit}",modifiers:[{name:"sign",src:"ago|before",value:-1},{name:"sign",src:"from now|after|from|in|later",value:1},{name:"edge",src:"last day",value:-2},{name:"edge",src:"end",value:-1},{name:"edge",src:"first day|beginning",value:1},{name:"shift",src:"last",value:-1},{name:"shift",src:"the|this",value:0},{name:"shift",src:"next",value:1}],dateParse:["{month} {year}","{shift} {unit=5-7}","{0?} {date}{1}","{0?} {edge} of {shift?} {unit=4-7?}{month?}{year?}"],timeParse:"{num} {unit} {sign};{sign} {num} {unit};{0} {num}{1} {day} of {month} {year?};{weekday?} {month} {date}{1?} {year?};{date} {month} {year};{date} {month};{shift} {weekday};{shift} week {weekday};{weekday} {2?} {shift} week;{num} {unit=4-5} {sign} {day};{0?} {date}{1} of {month};{0?}{month?} {date?}{1?} of {shift} {unit=6-7}".split(";")}),rn=cn.concat().reverse(),en=cn.concat(),en.splice(2,1),o(sr,!0,!0,cn,function(t,e,r){function n(t){t/=l;var r=t%1,n=e.error||.999;return r&&Cr(r%1)>n&&(t=Mr(t)),0>t?Rr(t):Lr(t)}var i,o,s=e.name,a=ve(s),l=e.b();e.j="add"+a+"s",i=function(t,e){return n(this.getTime()-sr.create(t,e).getTime())},o=function(t,e){return n(sr.create(t,e).getTime()-this.getTime())},t[s+"sAgo"]=o,t[s+"sUntil"]=o,t[s+"sSince"]=i,t[s+"sFromNow"]=i,t[e.j]=function(t,e){var r={};return r[s]=t,this.advance(r,e)},De(e,l),3>r&&["Last","This","Next"].forEach(function(e){t["is"+e+a]=function(){return Ie(this,e+" "+s,"en")}}),4>r&&(t["beginningOf"+a]=function(){var t={};switch(s){case"year":t.year=M(this,"FullYear");break;case"month":t.month=M(this,"Month");break;case"day":t.day=M(this,"Date");break;case"week":t.weekday=0}return this.set(t,!0)},t["endOf"+a]=function(){var t={hours:23,minutes:59,seconds:59,milliseconds:999};
switch(s){case"year":t.month=11,t.day=31;break;case"month":t.day=this.daysInMonth();break;case"week":t.weekday=6}return this.set(t,!0)})}),Jr.addFormat("([+-])?(\\d{4,4})[-.]?{full_month}[-.]?(\\d{1,2})?",!0,["year_sign","year","month","date"],!1,!0),Jr.addFormat("(\\d{1,2})[-.\\/]{full_month}(?:[-.\\/](\\d{2,4}))?",!0,["date","month","year"],!0),Jr.addFormat("{full_month}[-.](\\d{4,4})",!1,["month","year"]),Jr.addFormat("\\/Date\\((\\d+(?:[+-]\\d{4,4})?)\\)\\/",!1,["timestamp"]),Jr.addFormat(Fe(Jr),!1,nn),an=Jr.g.slice(0,7).reverse(),Jr.g=Jr.g.slice(7).concat(an),Me("f",function(t){return M(t,"Milliseconds")},!0),Me("s",function(t){return M(t,"Seconds")}),Me("m",function(t){return M(t,"Minutes")}),Me("h",function(t){return M(t,"Hours")%12||12}),Me("H",function(t){return M(t,"Hours")}),Me("d",function(t){return M(t,"Date")}),Me("M",function(t){return M(t,"Month")+1}),function(){function t(t,e){var r=M(t,"Hours");return fe(e).ampm[Lr(r/12)]||""}Le("t",t,1),Le("tt",t),Le("T",t,1,1),Le("TT",t,null,2)}(),function(){function t(t,e){var r=M(t,"Day");return fe(e).weekdays[r]}Le("dow",t,3),Le("Dow",t,3,1),Le("weekday",t),Le("Weekday",t,null,1)}(),Re("mon",0,3),Re("month",0),Re("month2",1),Re("month3",2),un.ms=un.f,un.milliseconds=un.f,un.seconds=un.s,un.minutes=un.m,un.hours=un.h,un["24hr"]=un.H,un["12hr"]=un.h,un.date=un.d,un.day=un.d,un.year=un.yyyy,o(sr,!0,!0,"short,long,full",function(t,e){t[e]=function(t){return Be(this,e,!1,t)}}),"\u3007\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07".split("").forEach(function(t,e){e>9&&(e=Pr(10,e-9)),sn[t]=e}),w(sn,jr),tn=or("([\u671f\u9031\u5468])?([\u3007\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07"+Dr+"]+)(?!\u6628)","g"),function(){var t=Jr.weekdays.slice(0,7),e=Jr.months.slice(0,12);o(sr,!0,!0,"today yesterday tomorrow weekday weekend future past".split(" ").concat(t).concat(e),function(t,e){t["is"+ve(e)]=function(t){return this.is(e,0,t)}})}(),sr.utc||(sr.utc={create:function(){return Ne(arguments,0,!0)},past:function(){return Ne(arguments,-1,!0)},future:function(){return Ne(arguments,1,!0)}}),i(sr,!1,!0,{RFC1123:"{Dow}, {dd} {Mon} {yyyy} {HH}:{mm}:{ss} {tz}",RFC1036:"{Weekday}, {dd}-{Mon}-{yy} {HH}:{mm}:{ss} {tz}",ISO8601_DATE:"{yyyy}-{MM}-{dd}",ISO8601_DATETIME:"{yyyy}-{MM}-{dd}T{HH}:{mm}:{ss}.{fff}{isotz}"}),je.prototype.toString=function(){return this.isValid()?this.start+".."+this.end:"Invalid Range"},i(je,!0,!0,{isValid:function(){return Ge(this.start)&&Ge(this.end)&&typeof this.start==typeof this.end},span:function(){return this.isValid()?Cr((xr(this.end)?this.end.charCodeAt(0):this.end)-(xr(this.start)?this.start.charCodeAt(0):this.start))+1:0/0},contains:function(t){return null==t?!1:t.start&&t.end?t.start>=this.start&&t.start<=this.end&&t.end>=this.start&&t.end<=this.end:t>=this.start&&t<=this.end},every:function(t,e){var r,n=this.start,i=this.end,o=n>i,s=n,a=0,l=[];for(Tr(t)&&(e=t,t=null),t=t||1,wr(n)?r=qe:xr(n)?r=ze:Sr(n)&&(r=t,wr(r)?t=r:(n=r.toLowerCase().match(/^(\d+)?\s?(\w+?)s?$/i),r=parseInt(n[1])||1,n=n[2].slice(0,1).toUpperCase()+n[2].slice(1),n.match(/hour|minute|second/i)?n+="s":"Year"===n?n="FullYear":"Day"===n&&(n="Date"),t=[r,n]),r=Ue),o&&t>0&&(t*=-1);o?s>=i:i>=s;)l.push(s),e&&e(s,a),s=r(s,t),a++;return l},union:function(t){return new je(this.start<t.start?this.start:t.start,this.end>t.end?this.end:t.end)},intersect:function(t){return t.start>this.end||t.end<this.start?new je(0/0,0/0):new je(this.start>t.start?this.start:t.start,this.end<t.end?this.end:t.end)},clone:function(){return new je(this.start,this.end)},clamp:function(t){var e=this.start,r=this.end,n=e>r?r:e,e=e>r?e:r;return $e(n>t?n:t>e?e:t)}}),[lr,ar,sr].forEach(function(t){i(t,!1,!0,{range:function(e,r){return t.create&&(e=t.create(e),r=t.create(r)),new je(e,r)}})}),i(lr,!0,!0,{upto:function(t,e,r){return lr.range(this,t).every(r,e)},clamp:function(t,e){return new je(t,e).clamp(this)},cap:function(t){return this.clamp(void 0,t)}}),i(lr,!0,!0,{downto:lr.prototype.upto}),i(ir,!1,function(t){return t instanceof je},{create:function(t){return t.every()}}),i(Function,!0,!0,{lazy:function(t,e,r){function n(){return u.length<r-(c&&e?1:0)&&u.push([this,arguments]),c||(c=!0,e?i():Xe(n,o,i)),a}var i,o,s,a,l=this,u=[],c=!1;return t=t||1,r=r||1/0,o=Rr(t),s=Mr(o/t)||1,i=function(){var t,e=u.length;if(0!=e){for(t=Br(e-s,0);e>t;)a=Function.prototype.apply.apply(l,u.shift()),e--;Xe(n,o,function(){c=!1,i()})}},n},throttle:function(t){return this.lazy(t,!0,1)},debounce:function(t){function e(){e.cancel(),Xe(e,t,r,this,arguments)}var r=this;return e},delay:function(t){var e=u(arguments,null,1);return Xe(this,t,this,this,e),this},every:function(t){function e(){r.apply(r,n),Xe(r,t,e)}var r=this,n=arguments,n=1<n.length?u(n,null,1):[];return Xe(r,t,e),r},cancel:function(){var t,e=this.timers;if(_r(e))for(;t=e.shift();)clearTimeout(t);return this.n=!0,this},after:function(t){var e=this,r=0,n=[];if(wr(t)){if(0===t)return e.call(),e}else t=1;return function(){var i;return n.push(u(arguments)),r++,r==t?(i=e.call(this,n),r=0,n=[],i):void 0}},once:function(){return this.throttle(1/0,!0)},fill:function(){var t=this,e=u(arguments);return function(){var r=u(arguments);return e.forEach(function(t,e){(null!=t||e>=r.length)&&r.splice(e,0,t)}),t.apply(this,r)}}}),i(lr,!1,!0,{random:function(t,e){var r,n;return 1==arguments.length&&(e=t,t=0),r=kr(t||0,d(e)?1:e),n=Br(t||0,d(e)?1:e)+1,Lr(ur.random()*(n-r)+r)}}),i(lr,!0,!0,{log:function(t){return ur.log(this)/(t?ur.log(t):1)},abbr:function(t){return Ke(this,t,"kmbt",0,4)},metric:function(t,e){return Ke(this,t,"n\u03bcm kMGTPE",4,d(e)?1:e)},bytes:function(t,e){return Ke(this,t,"kMGTPE",0,d(e)?4:e,!0)+"B"},isInteger:function(){return 0==this%1},isOdd:function(){return!isNaN(this)&&!this.isMultipleOf(2)},isEven:function(){return this.isMultipleOf(2)},isMultipleOf:function(t){return 0===this%t},format:function(t,e,r){var n,i,o,s="";for(d(e)&&(e=","),d(r)&&(r="."),n=(wr(t)?S(this,t||0).toFixed(Br(t,0)):this.toString()).replace(/^-/,"").split("."),i=n[0],o=n[1],n=i.length;n>0;n-=3)n<i.length&&(s=e+s),s=i.slice(Br(0,n-3),n)+s;return o&&(s+=r+T("0",(t||0)-o.length)+o),(0>this?"-":"")+s},hex:function(t){return this.pad(t||1,!1,16)},times:function(t){if(t)for(var e=0;this>e;e++)t.call(this,e);return this.toNumber()},chr:function(){return ar.fromCharCode(this)},pad:function(t,e,r){return C(this,t,e,r)},ordinalize:function(){var t=Cr(this),t=parseInt(t.toString().slice(-2));return this+P(t)},toNumber:function(){return parseFloat(this,10)}}),function(){function t(t){return function(e){return e?S(this,e,t):t(this)}}i(lr,!0,!0,{ceil:t(Rr),round:t(Mr),floor:t(Lr)}),o(lr,!0,!0,"abs,pow,sin,asin,cos,acos,tan,atan,exp,pow,sqrt",function(t,e){t[e]=function(t,r){return ur[e](this,t,r)}})}();var hn=["isObject","isNaN"],dn="keys values select reject each merge clone equal watch tap has toQueryString".split(" ");i(nr,!1,!0,{watch:function(t,e,r){if(dr){var n=t[e];nr.defineProperty(t,e,{enumerable:!0,configurable:!0,get:function(){return n},set:function(i){n=r.call(t,e,n,i)}})}}}),i(nr,!1,function(){return 1<arguments.length},{keys:function(t,e){var r=nr.keys(t);return r.forEach(function(r){e.call(t,r,t[r])}),r}}),i(nr,!1,!0,{isObject:function(t){return v(t)},isNaN:function(t){return wr(t)&&t.valueOf()!==t.valueOf()},equal:function(t,e){return I(t,e)},extended:function(t){return new _(t)},merge:function(t,e,r,n){var i,o,s,a,l,u,c;if(t&&"string"!=typeof e)for(i in e)if(f(e,i)&&t){if(a=e[i],l=t[i],u=h(l),o=g(a),s=g(l),c=u&&!1===n?l:a,u&&Tr(n)&&(c=n.call(e,i,l,a)),r&&(o||s))if(Sr(a))c=new sr(a.getTime());else{if(!Er(a)){s||(t[i]=ir.isArray(a)?[]:{}),nr.merge(t[i],a,r,n);continue}c=new or(a.source,R(a))}t[i]=c}return t},values:function(t,e){var r=[];return y(t,function(n,i){r.push(i),e&&e.call(t,i)}),r},clone:function(t,e){var r;if(!g(t))return t;if(r=pr.call(t),Sr(t,r)&&t.clone)return t.clone();if(Sr(t,r)||Er(t,r))return new t.constructor(t);if(t instanceof _)r=new _;else if(_r(t,r))r=[];else{if(!v(t,r))throw new TypeError("Clone must be a basic data type.");r={}}return nr.merge(r,t,e)},fromQueryString:function(t,e){var r=nr.extended();return t=t&&t.toString?t.toString():"",t.replace(/^.*?\?/,"").split("&").forEach(function(t){t=t.split("="),2===t.length&&Ve(r,t[0],decodeURIComponent(t[1]),e)}),r},toQueryString:function(t,e){return Ye(e,t)},tap:function(t,e){var r=e;return Tr(e)||(r=function(){e&&t[e]()}),r.call(t,t),t},has:function(t,e){return f(t,e)},select:function(t){return Qe(t,arguments,!0)},reject:function(t){return Qe(t,arguments,!1)}}),o(nr,!1,!0,yr,function(t,e){var r="is"+e;hn.push(r),t[r]=mr[e]}),i(nr,!1,function(){return 0===arguments.length},{extend:function(){var t=hn.concat(dn);"undefined"!=typeof Qr&&(t=t.concat(Qr)),N(t,nr)}}),N(dn,_),i(or,!1,!0,{escape:function(t){return L(t)}}),i(or,!0,!0,{getFlags:function(){return R(this)},setFlags:function(t){return or(this.source,t)},addFlag:function(t){return this.setFlags(R(this,t))},removeFlag:function(t){return this.setFlags(R(this).replace(t,""))}});var fn,gn;i(ar,!0,!1,{repeat:function(t){return t=Je(t),T(this,t)}}),i(ar,!0,function(t){return Er(t)||2<arguments.length},{startsWith:function(t){var e=arguments,r=e[1],e=e[2],n=this;return r&&(n=n.slice(r)),d(e)&&(e=!0),r=Er(t)?t.source.replace("^",""):L(t),or("^"+r,e?"":"i").test(n)},endsWith:function(t){var e=arguments,r=e[1],e=e[2],n=this;return h(r)&&(n=n.slice(0,r)),d(e)&&(e=!0),r=Er(t)?t.source.replace("$",""):L(t),or(r+"$",e?"":"i").test(n)}}),i(ar,!0,!0,{escapeRegExp:function(){return L(this)},escapeURL:function(t){return t?encodeURIComponent(this):encodeURI(this)},unescapeURL:function(t){return t?decodeURI(this):decodeURIComponent(this)},escapeHTML:function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\//g,"&#x2f;")},unescapeHTML:function(){return this.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#x2f;/g,"/").replace(/&amp;/g,"&")},encodeBase64:function(){return fn(unescape(encodeURIComponent(this)))},decodeBase64:function(){return decodeURIComponent(escape(gn(this)))},each:function(t,e){var r,n,i;if(Tr(t)?(e=t,t=/[\s\S]/g):t?xr(t)?t=or(L(t),"gi"):Er(t)&&(t=or(t.source,R(t,"g"))):t=/[\s\S]/g,r=this.match(t)||[],e)for(n=0,i=r.length;i>n;n++)r[n]=e.call(this,r[n],n,r)||r[n];return r},shift:function(t){var e="";return t=t||0,this.codes(function(r){e+=ar.fromCharCode(r+t)}),e},codes:function(t){var e,r,n=[];for(e=0,r=this.length;r>e;e++){var i=this.charCodeAt(e);n.push(i),t&&t.call(this,i,e)}return n},chars:function(t){return this.each(t)},words:function(t){return this.trim().each(/\S+/g,t)},lines:function(t){return this.trim().each(/^.*$/gm,t)},paragraphs:function(t){var e=this.trim().split(/[\r\n]{2,}/);return e=e.map(function(e){if(t)var r=t.call(e);return r?r:e})},isBlank:function(){return 0===this.trim().length},has:function(t){return-1!==this.search(Er(t)?t:L(t))},add:function(t,e){return e=d(e)?this.length:e,this.slice(0,e)+t+this.slice(e)},remove:function(t){return this.replace(t,"")},reverse:function(){return this.split("").reverse().join("")},compact:function(){return this.trim().replace(/([\r\n\s\u3000])+/g,function(t,e){return"\u3000"===e?e:" "})},at:function(){return H(this,arguments,!0)},from:function(t){return this.slice(rr(this,t,!0))},to:function(t){return d(t)&&(t=this.length),this.slice(0,rr(this,t))},dasherize:function(){return this.underscore().replace(/_/g,"-")},underscore:function(){return this.replace(/[-\s]+/g,"_").replace(ar.Inflector&&ar.Inflector.acronymRegExp,function(t,e){return(e>0?"_":"")+t.toLowerCase()}).replace(/([A-Z\d]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase()},camelize:function(t){return this.underscore().replace(/(^|_)([^_]+)/g,function(e,r,n,i){return e=(e=ar.Inflector)&&e.acronyms[n],e=xr(e)?e:void 0,i=!1!==t||i>0,e?i?e:e.toLowerCase():i?n.capitalize():n})},spacify:function(){return this.underscore().replace(/_/g," ")},stripTags:function(){var t=this;return c(0<arguments.length?arguments:[""],function(e){t=t.replace(or("</?"+L(e)+"[^<>]*>","gi"),"")}),t},removeTags:function(){var t=this;return c(0<arguments.length?arguments:["\\S+"],function(e){e=or("<("+e+")[^<>]*(?:\\/>|>.*?<\\/\\1>)","gi"),t=t.replace(e,"")}),t},truncate:function(t,e,r){return tr(this,t,e,r)},truncateOnWord:function(t,e,r){return tr(this,t,e,r,!0)},pad:function(t,e){var r,n;return t=Je(t),r=Br(0,t-this.length)/2,n=Lr(r),r=Rr(r),Ze(n,e)+this+Ze(r,e)},padLeft:function(t,e){return t=Je(t),Ze(Br(0,t-this.length),e)+this},padRight:function(t,e){return t=Je(t),this+Ze(Br(0,t-this.length),e)},first:function(t){return d(t)&&(t=1),this.substr(0,t)},last:function(t){return d(t)&&(t=1),this.substr(0>this.length-t?0:this.length-t)},toNumber:function(t){return A(this,t)},capitalize:function(t){var e;return this.toLowerCase().replace(t?/[^']/g:/^\S/,function(t){var r,n=t.toUpperCase();return r=e?t:n,e=n!==t,r})},assign:function(){var t={};return c(arguments,function(e,r){g(e)?w(t,e):t[r+1]=e}),this.replace(/\{([^{]+?)\}/g,function(e,r){return f(t,r)?t[r]:e})}}),i(ar,!0,!0,{insert:ar.prototype.add}),function(t){if(cr.btoa)fn=cr.btoa,gn=cr.atob;else{var e=/[^A-Za-z0-9\+\/\=]/g;fn=function(e){var r,n,i,o,s,a,l="",u=0;do r=e.charCodeAt(u++),n=e.charCodeAt(u++),i=e.charCodeAt(u++),o=r>>2,r=(3&r)<<4|n>>4,s=(15&n)<<2|i>>6,a=63&i,isNaN(n)?s=a=64:isNaN(i)&&(a=64),l=l+t.charAt(o)+t.charAt(r)+t.charAt(s)+t.charAt(a);while(u<e.length);return l},gn=function(r){var n,i,o,s,a,l="",u=0;if(r.match(e))throw Error("String contains invalid base64 characters");r=r.replace(/[^A-Za-z0-9\+\/\=]/g,"");do n=t.indexOf(r.charAt(u++)),i=t.indexOf(r.charAt(u++)),s=t.indexOf(r.charAt(u++)),a=t.indexOf(r.charAt(u++)),n=n<<2|i>>4,i=(15&i)<<4|s>>2,o=(3&s)<<6|a,l+=ar.fromCharCode(n),64!=s&&(l+=ar.fromCharCode(i)),64!=a&&(l+=ar.fromCharCode(o));while(u<r.length);return l}}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=")}(),$(function(){window.currentPlayer={id:-1};var t="",e=0;if(void 0!==window.customcharsheet_translation&&(i18n.translator.add(JSON.parse(BASE64.decode(window.customcharsheet_translation))),console.log("Custom Sheet Translation")),void 0!==window.customcharsheet_html){d20.journal.useCustomSheets=!0,d20.journal.customSheets={};var r=function(t,e,r){r||void 0===e||(t=html_sanitize(t,function(t){var e=t.toString(),r="https://s3.amazonaws.com/files.d20.io";return e.substring(0,r.length)===r?e:/^https?:\/\//.test(e)?"http://imgsrv.roll20.net/?src="+escape(e.replace("http://","").replace("https://","")):""},function(t){var e=t.split(" ");return _.each(e,function(t,r){e[r]="attr_"===t.substring(0,5)||"sheet-"===t.substring(0,6)||"repeating_"===t.substring(0,10)||"roll_"===t.substring(0,5)||"tokenaction"===t?t:"sheet-"+t}),e.join(" ")})),e=(((e||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var n=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,i=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return t.replace(i,"").replace(n,function(t,r){return e.indexOf("<"+r.toLowerCase()+">")>-1?t:""})};console.log("Compiling sheet..."),d20.journal.customSheets.rollTemplates={};var n=BASE64.decode(customcharsheet_html),i=/(<rolltemplate [^>]+>)([\s\S]*?)(<\/rolltemplate>)/gi,o=/(class=\"sheet-rolltemplate-)([^\"]+)(\">)/i;n=n.replace(i,function(t){var e=o.exec(t);if(e&&e.length>3){console.log("Found rolltemplate: "+e[2]);var n=e[2],i=arguments[2];i=r(i,"<br><input><textarea><div><span><label><hr><img><b><i><strong><em><h1><h2><h3><h4><h5><h6><p><hr><table><tr><td><tbody><thead><th><tfoot><select><option><fieldset><button><ul><li><ol><caption>"),d20.journal.customSheets.rollTemplates[n]=i}return""}),d20.journal.customSheets.layouthtml=r(n,"<br><input><textarea><div><span><label><hr><img><b><i><strong><em><h1><h2><h3><h4><h5><h6><p><hr><table><tr><td><tbody><thead><th><tfoot><select><option><fieldset><button><ul><li><ol><caption>");var s=$("<div class='root'>"+d20.journal.customSheets.layouthtml+"</div>");console.log("Finding sheet rolls..."),d20.journal.customSheets.availableRolls={},d20.journal.customSheets.availableAttributes={},d20.journal.customSheets.reservedAttributes={},d20.journal.customSheets.tokenActions=[],d20.journal.customSheets.attrDeps={};var a=/@{[^}]+}/g;d20.journal.updateSheetDeps=function(t,e){var r=e.match(a);if(!r)return!0;for(var n=0;n<r.length;n++){var i=r[n].substring(2,r[n].length-1).toLowerCase();d20.journal.customSheets.attrDeps[i]||(d20.journal.customSheets.attrDeps[i]=[]),-1===d20.journal.customSheets.attrDeps[i].indexOf(t.toLowerCase())&&d20.journal.customSheets.attrDeps[i].push(t.toLowerCase())}},s.find("button[type=roll]").each(function(){var t=$(this),e=t.parents("fieldset").length>0?!1:!0;e&&void 0!==t.attr("name")&&(d20.journal.customSheets.availableRolls[t.attr("name").substring(5,t.attr("name").length).toLowerCase()]=t.attr("value").split("\\n").join("\n"),t.hasClass("tokenaction")&&d20.journal.customSheets.tokenActions.push(t.attr("name").substring(5,t.attr("name").length).toLowerCase())),t.addClass("btn")}),d20.journal.customSheets.tokenActions=_.sortBy(d20.journal.customSheets.tokenActions,function(t){return t}),s.find('*[name^="attr_"]').each(function(){var t=$(this),e=t.parents("fieldset"),r="";if(e.length>0){var n,i=e[0].classList;_.each(i,function(t){return"repeating_"===t.substring(0,10)?(n=t.toLowerCase().replace("'","&quot;"),!1):void 0}),n&&(r=n+"_")}var o=r+t.attr("name").substring(5,t.attr("name").length).toLowerCase();if("input"===this.tagName.toLowerCase()&&"checkbox"===t.attr("type")&&void 0!==t.attr("value"))d20.journal.customSheets.availableAttributes[o]=t.attr("checked")?t.attr("value")||"":"0";else if("input"===this.tagName.toLowerCase()&&"radio"===t.attr("type")&&void 0!==t.attr("value"))t.attr("checked")&&(d20.journal.customSheets.availableAttributes[o]=t.attr("value")||"");else if(t.attr("disabled")){if(!this.attributes.value)return console.log("SHEET ERROR: Specified a disabled input without a valid formula in the value attribute."),!0;d20.journal.customSheets.availableAttributes[o]=this.attributes.value.nodeValue||"",d20.journal.updateSheetDeps(o,d20.journal.customSheets.availableAttributes[o]),t.attr("data-formula",this.attributes.value.nodeValue),d20.journal.customSheets.reservedAttributes[o]=!0}else d20.journal.customSheets.availableAttributes[o]=t.attr("value")||"";t.attr("disabled")||"string"!=typeof t.attr("value")||-1===t.attr("value").indexOf("@{")||d20.journal.updateSheetDeps(o,t.attr("value"))}),d20.journal.customSheets.layouthtml=s.html(),r=function(t,e){t=t.replace(/\/\*[^\*]+\*\//g,""),t=t.replace(/([^{]+){[^}]*}/gi,function(t,e){e=$.trim(e);for(var r=e.split(","),n="",i=0;i<r.length;i++)r[i]=$.trim(r[i]),"#"===r[i].substring(0,1)&&(r[i]=r[i].replace("#",".")),".charsheet "!==r[i].substring(0,11)&&".charsheet"!==r[i]&&"@font-face"!==r[i]&&".sheet-rolltemplate-"!==r[i].substring(0,20)&&(r[i]=".charsheet "+r[i]);return n=r.join(","),t=t.replace(e,n)});for(var r=[/(\bdata:\b|eval|cookie|\bwindow\b|\bparent\b|\bthis\b)/i,/behaviou?r|expression|moz-binding|@import|@charset|javascript|vbscript|[\<]|\\\w/i,/[\x7f-\xff]/,/[\x00-\x08\x0B\x0C\x0E-\x1F]/,/&\#/],n=0;n<r.length;n++)t.match(r[n])&&(console.log(t.match(r[n])),console.error("Potential CSS security violation; character sheet template styling thrown out."),t="");t=t.replace(/url[\s]*\([^\)]+\)/gi,function(t){t=t.replace(/\s/gi,""),t=t.replace("url(","");var e=t.split(")");t=e[e.length-2],t=t.replace(/'/gi,""),t=t.replace(/"/gi,"");var r="https://s3.amazonaws.com/files.d20.io";return t.substring(0,r.length)===r?"url('"+t+"')":/^https?:\/\//.test(t)?"url('http://imgsrv.roll20.net/?src="+escape($.trim(t.replace("http://","").replace("https://","")))+"')":""}),e=(((e||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var i=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,o=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return t.replace(o,"").replace(i,function(t,r){return e.indexOf("<"+r.toLowerCase()+">")>-1?t:""})};var l,u=document.head||document.getElementsByTagName("head")[0],c=document.createElement("style");l=r(BASE64.decode(customcharsheet_css)),c.type="text/css",c.styleSheet?c.styleSheet.cssText=l:c.appendChild(document.createTextNode(l)),u.appendChild(c),d20.journal.customSheets.styleel=c}var p=function(r){var n=r.type;if("gmrollresult"==r.type){if(!window.is_gm&&r.playerid!=window.currentPlayer.id)return console.log("ignoring message, not gm, and not original player."),"";n="rollresult"}if("whisper"==r.type){if(1==window.NOWHISPERS)return"";if(r.playerid==window.currentPlayer.id)n="whispersent";else{if(n="whisperreceived","gm"==r.target){if(!window.is_gm)return""}else if(r.target!=window.currentPlayer.id)return"";lastWhisperReceived=r}}"rollresult"==n&&r.origRoll?(n="newroll",r.htmlcontent=d20.dice_formatter.getHtmlForResult(JSON.parse(r.content)),r.sanitizedOrigRoll=d20.dice_formatter.replaceInlineRolls(r.origRoll,r)):"rollresult"==n&&"object"==typeof r.content&&(r.content=r.content.origformula+"|"+r.content.formula+"|"+r.content.total),r.rolltemplate||"rollresult"==n||"newroll"==n||"tokenroll"==n||"direct"==n||(r.content=Markdown.parse(r.content+"").autoLink());var i=$("#tmpl_chatmessage_"+n);if((r.who!==t||e>5)&&(r.showname=!0,e=0),r.rolltemplate){for(var o,s={},a=/{{([\s\S]*?}?)}}/gi;null!=(o=a.exec(r.content));){o.index===a.lastIndex&&a.lastIndex++;var l=o[1]+"",u=l.split("=");s[u[0]]=l.substring(u[0].length+1,l.length)}$.each(s,function(t,e){s[t]=e.replace(/\^{([^}]+)}/g,function(t,e){return e=$.trim(e),i18n(e,'<span style="color: red;">['+e+"]</span>")});var r=t.replace(/\^{([^}]+)}/g,function(t,e){return e=$.trim(e),i18n(e,"["+e+"]")});r!==t&&(s[r]=s[t],delete s[t])}),s["rollWasCrit()"]=function(){return function(t,e,n){try{var i=n.join(" ");if(void 0!==s[i]&&"string"==typeof s[i]){var o=s[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[o]&&d20.dice_formatter.checkForCrits(r.inlinerolls[o].results.rolls,"crit"))return e(t)}}catch(a){console.log("Error while checking for crit in roll...")}return null}},s["rollWasFumble()"]=function(){return function(t,e,n){try{var i=n.join(" ");if(void 0!==s[i]&&"string"==typeof s[i]){var o=s[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[o]&&d20.dice_formatter.checkForCrits(r.inlinerolls[o].results.rolls,"fumble"))return e(t)}}catch(a){console.log("Error while checking for fumble in roll...")}return null}},s["rollTotal()"]=function(){return function(t,e,n){try{var i=n[0],o=n[1];if(void 0!==s[i]&&"string"==typeof s[i]){var a=s[i].split("$[[")[1].split("]]")[0];if(r.inlinerolls[a]&&r.inlinerolls[a].results.total===parseInt(o,10))return e(t)}}catch(l){console.log("Error while checking for roll total...")}return null}},s["allprops()"]=function(){return function(t,e,r){try{var n="";for(var i in s)"name"!==i&&-1===r.indexOf(i)&&"function"!=typeof s[i]&&(n+=e(t.replace("{{key}}",ucfirst(i)).replace("{{value}}",s[i])));return n}catch(o){console.log("Error enumerating all properties")}return null}};var c="";if(d20.journal&&d20.journal.customSheets&&d20.journal.customSheets.rollTemplates[r.rolltemplate])c="<div class='sheet-rolltemplate-"+r.rolltemplate+"'>"+d20.journal.customSheets.rollTemplates[r.rolltemplate]+"</div>";else{var p=$("#sheet-rolltemplate-"+r.rolltemplate);0===p.length?console.error("Didn't find a roll template called '"+r.rolltemplate+"'"):c="<div class='"+p.attr("id")+"'>"+p.html()+"</div>"}r.content=Mustache.render(c,s),r.content=Markdown.parse(r.content),r.content=d20.utils.htmlTranslator(r.content,!0)}var h=i.jqote(r);return t="emote"==r.type||"gmrollresult"==r.type||"whisper"==r.type?"":r.who,e++,h},h=function(){function t(){return console.log("autograv"),$(this).hasClass("tipsy-w")?"w":$(this).hasClass("tipsy-e")?"e":$(this).hasClass("tipsy-n")?"n":$(this).hasClass("tipsy-s")?"s":$(this).hasClass("tipsy-side")?$(this).offset().left>$(document).scrollLeft()+$(window).width()/2?"e":"w":$(this).offset().top>$(document).scrollTop()+$(window).height()/2?"s":"n"}for(var e="",r=[],n=[],i=BASE64.decode(msgdata),o=JSON.parse(i),s=0;s<o.length;s++)for(var a in o[s]){if(o[s][a].timestamp=o[s][a][".priority"],o[s][a].timestamp){var l=o[s][a].timestamp,u=Date.create(l),c=(new Date).getTime();o[s][a].timestamp=u.format(864e5>c-l?"{h}:{mm}{TT}":"{{Month}} {{dd}}, {{yyyy}} {h}:{mm}{TT}")}else o[s][a].timestamp="";o[s][a].id=a,void 0!==o[s][a][".priority"]?n.push(o[s][a]):r.push(o[s][a])}r=_.sortBy(r,function(t){return t.id}),n=_.sortBy(n,function(t){return t[".priority"]});for(var s=0;s<r.length;s++)try{e+=p(r[s])}catch(h){console.log("ERROR with message "+r[s].id),console.log(h)}for(var s=0;s<n.length;s++)try{e+=p(n[s])}catch(h){console.log("ERROR with message "+n[s].id),console.log(h)}$("#textchat .content").html(e),$(".showtip").tipsy({live:!0,gravity:t,opacity:1,html:!0})};h()}),function(t){function e(e,r){this.$element=t(e),this.options=r,this.enabled=!0,this.fixTitle()}e.prototype={show:function(){var e=this.getTitle();if("noshow"!=e&&e&&this.enabled){var r=this.tip(),n=t("body"),i=0,o=0;this.$element.parents("#editor-wrapper").length>0&&(n=t("#editor-wrapper"),i=n.scrollTop(),o=n.scrollLeft());var s=this.$element.parents("body");s.hasClass("popoutwindow")&&(n=s),this.options.filterhtml&&(e=d20ext.utils.strip_tags(e,"<span><br><strong><em>")),r.find(".tipsy-inner")[this.options.html?"html":"text"](e),r[0].className="tipsy",r.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).appendTo(n);var a=t.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight});a.top=a.top+i,a.left=a.left+o;var l,u=r[0].offsetWidth,c=r[0].offsetHeight,p="function"==typeof this.options.gravity?this.options.gravity.call(this.$element[0]):this.options.gravity;switch(p.charAt(0)){case"n":l={top:a.top+a.height+this.options.offset,left:a.left+a.width/2-u/2};break;case"s":l={top:a.top-c-this.options.offset,left:a.left+a.width/2-u/2};break;case"e":l={top:a.top+a.height/2-c/2,left:a.left-u-this.options.offset};break;case"w":l={top:a.top+a.height/2-c/2,left:a.left+a.width+this.options.offset}}2==p.length&&(l.left="w"==p.charAt(1)?a.left+a.width/2-15:a.left+a.width/2-u+15),r.css(l).addClass("tipsy-"+p),this.options.fade?r.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):r.css({visibility:"visible",opacity:this.options.opacity}),r.on("mousedown",".noshow",function(){var e=t(this).attr("data-tutorial");return window.ignore_tutorials.push(e),t(".tipsy").remove(),t.post("/editor/disable_tutorial/"+e),!1})}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){t(this).remove()}):this.tip().remove()},fixTitle:function(){var t=this.$element;(t.attr("title")||"string"!=typeof t.attr("original-title"))&&t.attr("original-title",t.attr("title")||"").removeAttr("title")},getTitle:function(){var t,e=this.$element,r=this.options;this.fixTitle();var t,r=this.options;return"string"==typeof r.title?t=e.attr("title"==r.title?"original-title":r.title):"function"==typeof r.title&&(t=r.title.call(e[0])),t=(""+t).replace(/(^\s*|\s*$)/,""),t||r.fallback},tip:function(){return this.$tip||(this.$tip=t('<div class="tipsy"></div>').html(this.options.userscript?'<div class="tipsy-arrow"></div><div class="tipsy-inner userscript-tipsy-inner"></div><div class="tipsy-userscript-warning">API or player-generated content</div>':'<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>')),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},t.fn.tipsy=function(r){function n(n){var i=t.data(n,"tipsy");return i||(i=new e(n,t.fn.tipsy.elementOptions(n,r)),t.data(n,"tipsy",i)),i}function i(){var t=n(this);t.hoverState="in",0==r.delayIn?t.show():(t.fixTitle(),setTimeout(function(){"in"==t.hoverState&&t.show()},r.delayIn))}function o(){var t=n(this);t.hoverState="out",0==r.delayOut?t.hide():setTimeout(function(){"out"==t.hoverState&&t.hide()},r.delayOut)}if(r===!0)return this.data("tipsy");if("string"==typeof r){var s=this.data("tipsy");return s&&s[r](),this}if(r=t.extend({},t.fn.tipsy.defaults,r),r.live||this.each(function(){n(this)}),"manual"!=r.trigger){var a=r.live?"live":"bind",l="hover"==r.trigger?"mouseenter":"focus",u="hover"==r.trigger?"mouseleave":"blur";this[a](l,i)[a](u,o)}return this},t.fn.tipsy.defaults={delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.9,title:"title",trigger:"hover",conatinerel:!1},t.fn.tipsy.elementOptions=function(e,r){return t.metadata?t.extend({},r,t(e).metadata()):r},t.fn.tipsy.autoNS=function(){return t(this).offset().top>t(document).scrollTop()+t(window).height()/2?"s":"n"},t.fn.tipsy.autoWE=function(){return t(this).offset().left>t(document).scrollLeft()+t(window).width()/2?"e":"w"}}(jQuery);